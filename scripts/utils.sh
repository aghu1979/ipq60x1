#!/bin/bash
# å·¥å…·å‡½æ•°åº“ - æä¾›é€šç”¨çš„å·¥å…·å‡½æ•°
# ä½œè€…: Mary
# æœ€åæ›´æ–°: 2025-10-18

# =============================================================================
# å‘½ä»¤æ£€æŸ¥å‡½æ•°
# =============================================================================

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
# å‚æ•°: $1=å‘½ä»¤åç§°
# è¿”å›: 0=å­˜åœ¨, 1=ä¸å­˜åœ¨
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# =============================================================================
# æ–‡ä»¶å¤„ç†å‡½æ•°
# =============================================================================

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰
# å‚æ•°: $1=æ–‡ä»¶è·¯å¾„
# è¿”å›: 0=å­˜åœ¨, 1=ä¸å­˜åœ¨
file_exists_case_insensitive() {
    local file="$1"
    local dir=$(dirname "$file")
    local basename=$(basename "$file")
    
    # å¦‚æœç›®å½•å­˜åœ¨
    if [ -d "$dir" ]; then
        # æŸ¥æ‰¾æ–‡ä»¶ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰
        local found=$(find "$dir" -iname "$basename" -type f | head -n1)
        [ -n "$found" ]
    else
        return 1
    fi
}

# è·å–æ–‡ä»¶çœŸå®è·¯å¾„ï¼ˆå¤„ç†å¤§å°å†™ï¼‰
# å‚æ•°: $1=æ–‡ä»¶è·¯å¾„
# è¿”å›: æ–‡ä»¶çœŸå®è·¯å¾„
get_real_path() {
    local file="$1"
    local dir=$(dirname "$file")
    local basename=$(basename "$file")
    
    # å¦‚æœç›®å½•å­˜åœ¨
    if [ -d "$dir" ]; then
        # æŸ¥æ‰¾æ–‡ä»¶ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰
        find "$dir" -iname "$basename" -type f | head -n1
    fi
}

# =============================================================================
# è®¾å¤‡å¤„ç†å‡½æ•°
# =============================================================================

# æå–è®¾å¤‡åç§°
# å‚æ•°: $1=é…ç½®æ–‡ä»¶è·¯å¾„
# è¿”å›: è®¾å¤‡åç§°åˆ—è¡¨
extract_devices() {
    local config_file="$1"
    
    # ä»é…ç½®æ–‡ä»¶ä¸­æå–è®¾å¤‡åç§°
    local devices=$(grep "CONFIG_TARGET_DEVICE_.*_DEVICE_.*=y" "$config_file" 2>/dev/null | \
                   sed 's/.*_DEVICE_\(.*\)=y/\1/' | \
                   sort -u)
    
    # å¦‚æœæ²¡æœ‰æ‰¾åˆ°è®¾å¤‡
    if [ -z "$devices" ]; then
        echo "âš ï¸ æœªæ‰¾åˆ°è®¾å¤‡é…ç½®"
        return 1
    fi
    
    # ç»Ÿè®¡è®¾å¤‡æ•°é‡
    local device_count=$(echo "$devices" | wc -l)
    echo "ğŸ” æ£€æµ‹åˆ° $device_count ä¸ªè®¾å¤‡:"
    echo "$devices" | while read device; do
        echo "  - $device"
    done
    
    # è¿”å›è®¾å¤‡åˆ—è¡¨
    echo "$devices"
}

# =============================================================================
# éšæœºæ•°ç”Ÿæˆå‡½æ•°
# =============================================================================

# ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
# å‚æ•°: $1=é•¿åº¦ï¼ˆé»˜è®¤16ï¼‰
# è¿”å›: éšæœºå­—ç¬¦ä¸²
generate_random() {
    local length=${1:-16}
    openssl rand -hex $((length/2))
}

# =============================================================================
# ç½‘ç»œç›¸å…³å‡½æ•°
# =============================================================================

# æ£€æŸ¥ç½‘ç»œè¿æ¥
# å‚æ•°: $1=URLï¼ˆé»˜è®¤https://github.comï¼‰
# è¿”å›: 0=è¿æ¥æ­£å¸¸, 1=è¿æ¥å¤±è´¥
check_network() {
    local url=${1:-"https://github.com"}
    
    # ä½¿ç”¨curlæ£€æŸ¥ç½‘ç»œè¿æ¥
    if curl -s --head "$url" >/dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# ç­‰å¾…ç½‘ç»œè¿æ¥
# å‚æ•°: $1=æœ€å¤§å°è¯•æ¬¡æ•°ï¼ˆé»˜è®¤30ï¼‰
# è¿”å›: 0=è¿æ¥æˆåŠŸ, 1=è¿æ¥å¤±è´¥
wait_for_network() {
    local max_attempts=${1:-30}
    local attempt=1
    
    echo "â³ ç­‰å¾…ç½‘ç»œè¿æ¥..."
    
    # å¾ªç¯æ£€æŸ¥ç½‘ç»œè¿æ¥
    while [ $attempt -le $max_attempts ]; do
        if check_network; then
            echo "âœ… ç½‘ç»œè¿æ¥æ­£å¸¸"
            return 0
        fi
        
        echo "  å°è¯• $attempt/$max_attempts..."
        sleep 2
        ((attempt++))
    done
    
    echo "âŒ ç½‘ç»œè¿æ¥å¤±è´¥"
    return 1
}

# =============================================================================
# å®‰å…¨æ“ä½œå‡½æ•°
# =============================================================================

# å®‰å…¨åˆ é™¤ç›®å½•
# å‚æ•°: $1=ç›®å½•è·¯å¾„
# è¿”å›: 0=æˆåŠŸ, 1=å¤±è´¥
safe_remove() {
    local path="$1"
    
    # å®‰å…¨æ£€æŸ¥
    if [ -n "$path" ] && [ "$path" != "/" ] && [[ "$path" == *"/"*" ]]; then
        rm -rf "$path"
        echo "ğŸ—‘ï¸ å·²åˆ é™¤: $path"
        return 0
    else
        echo "âš ï¸ æ‹’ç»åˆ é™¤ä¸å®‰å…¨çš„è·¯å¾„: $path"
        return 1
    fi
}

# åˆ›å»ºç¬¦å·é“¾æ¥ï¼ˆå¤„ç†å·²å­˜åœ¨çš„æƒ…å†µï¼‰
# å‚æ•°: $1=æºè·¯å¾„, $2=ç›®æ ‡è·¯å¾„
# è¿”å›: 0=æˆåŠŸ, 1=å¤±è´¥
safe_symlink() {
    local source $GITHUB_WORKSPACE/scripts/logger.sh
    local source $GITHUB_WORKSPACE/scripts/utils.sh
    
    local source="$1"
    local target="$2"
    
    # å¦‚æœç›®æ ‡å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤
    if [ -e "$target" ]; then
        echo "âš ï¸ ç›®æ ‡å·²å­˜åœ¨ï¼Œåˆ é™¤: $target"
        rm -rf "$target"
    fi
    
    # åˆ›å»ºç¬¦å·é“¾æ¥
    ln -sf "$source" "$target"
    echo "ğŸ”— åˆ›å»ºé“¾æ¥: $source -> $target"
}

# =============================================================================
# æ–‡ä»¶å¤§å°å‡½æ•°
# =============================================================================

# è·å–æ–‡ä»¶å¤§å°ï¼ˆäººç±»å¯è¯»ï¼‰
# å‚æ•°: $1=æ–‡ä»¶è·¯å¾„
# è¿”å›: æ–‡ä»¶å¤§å°
get_file_size() {
    local file="$1"
    
    if [ -f "$file" ]; then
        ls -lh "$file" | awk '{print $5}'
    else
        echo "0"
    fi
}

# è·å–ç›®å½•å¤§å°
# å‚æ•°: $1=ç›®å½•è·¯å¾„
# è¿”å›: ç›®å½•å¤§å°
get_dir_size() {
    local dir="$1"
    
    if [ -d "$dir" ]; then
        du -sh "$dir" | cut -f1
    else
        echo "0"
    fi
}

# =============================================================================
# ç£€æŸ¥ç£ç›˜ç©ºé—´
# =============================================================================

# æ£€æŸ¥ç£ç›˜ç©ºé—´
# å‚æ•°: $1=è·¯å¾„ï¼ˆé»˜è®¤å½“å‰ç›®å½•ï¼‰, $2=æœ€å°ç©ºé—´GBï¼ˆé»˜è®¤5ï¼‰
# è¿”å›: 0=å……è¶³, 1=ä¸è¶³
check_disk_space() {
    local path=${1:-"."}
    local min_space_gb=${2:-5}
    
    # è·å–å¯ç”¨ç©ºé—´ï¼ˆKBï¼‰
    local available=$(df "$path" | awk 'NR==2 {print $4}')
    
    # è½¬æ¢ä¸ºGB
    local available_gb=$((available / 1024 / 1024))
    
    # æ£€æŸ¥æ˜¯å¦æ»¡è¶³æœ€å°ç©ºé—´è¦æ±‚
    if [ $available_gb -lt $min_space_gb ]; then
        echo "âš ï¸ ç£ç›˜ç©ºé—´ä¸è¶³: ${available_gb}GB å¯ç”¨ï¼Œéœ€è¦è‡³å°‘ ${min_space_gb}GB"
        return 1
    else
        echo "âœ… ç£ç›˜ç©ºé—´å……è¶³: ${available_gb}GB å¯ç”¨"
        return 0
    fi
}

# =============================================================================
# å¹¶è¡Œæ‰§è¡Œå‡½æ•°
# =============================================================================

# å¹¶è¡Œæ‰§è¡Œå‡½æ•°
# å‚æ•°: $1=æœ€å¤§å¹¶è¡Œæ•°, $2+=ä»»åŠ¡åˆ—è¡¨
parallel_exec() {
    local max_jobs=${1:-$(nproc)}
    local tasks=("${@:2}")
    local job_count=0
    
    echo "ğŸ”„ å¼€å§‹å¹¶è¡Œæ‰§è¡Œï¼Œæœ€å¤§å¹¶è¡Œæ•°: $max_jobs"
    
    # éå†æ‰€æœ‰ä»»åŠ¡
    for task in "${tasks[@]}"; do
        # ç­‰å¾…æœ‰ç©ºé—²æ§½ä½
        while [ $job_count -ge $max_jobs ]; do
            wait -n
            ((job_count--))
        done
        
        # å¯åŠ¨ä»»åŠ¡
        (
            echo "  æ‰§è¡Œä»»åŠ¡: $task"
            eval "$task"
        ) &
        ((job_count++))
    done
    
    # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    wait
    echo "âœ… æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆ"
}

# =============================================================================
# é…ç½®éªŒè¯å‡½æ•°
# =============================================================================

# éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼
# å‚æ•°: $1=é…ç½®æ–‡ä»¶è·¯å¾„
# è¿”å›: 0=æœ‰æ•ˆ, 1=æ— æ•ˆ
validate_config() {
    local config_file="$1"
    
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [ ! -f "$config_file" ]; then
        echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $config_file"
        return 1
    fi
    
    # æ£€æŸ¥é…ç½®æ–‡ä»¶æ ¼å¼
    local invalid_lines=$(grep -v '^#' "$config_file" | grep -v '^$' | grep -v '^CONFIG_')
    
    # å¦‚æœæœ‰æ— æ•ˆè¡Œ
    if [ -n "$invalid_lines" ]; then
        echo "âš ï¸ é…ç½®æ–‡ä»¶æ ¼å¼è­¦å‘Š:"
        echo "$invalid_lines"
    fi
    
    echo "âœ… é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡: $config_file"
    return 0
}

# =============================================================================
# é…ç½®å·®å¼‚å‡½æ•°
# =============================================================================

# ç”Ÿæˆé…ç½®å·®å¼‚æŠ¥å‘Š
# å‚æ•°: $1=æ—§é…ç½®æ–‡ä»¶, $2=æ–°é…ç½®æ–‡ä»¶, $3=è¾“å‡ºæ–‡ä»¶
generate_config_diff() {
    local old_config="$1"
    local new_config="$2"
    local output_file="$3"
    
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [ ! -f "$old_config" ] || [ ! -f "$new_config" ]; then
        echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
        return 1
    fi
    
    # ç”Ÿæˆå·®å¼‚æŠ¥å‘Š
    {
        echo "# é…ç½®å·®å¼‚æŠ¥å‘Š"
        echo "ç”Ÿæˆæ—¶é—´: $(date)"
        echo "æ—§é…ç½®: $old_config"
        echo "æ–°é…ç½®: $new_config"
        echo ""
        
        echo "## æ–°å¢çš„é…ç½®é¡¹"
        diff -u "$old_config" "$new_config" | grep "^+" | grep "^+CONFIG_" | sed 's/^+//' || echo "æ— æ–°å¢"
        echo ""
        
        echo "## åˆ é™¤çš„é…ç½®é¡¹"
        diff -u "$old_config" "$new_config" | grep "^-" | grep "^-CONFIG_" | sed 's/^-//' || echo "æ— åˆ é™¤"
        echo ""
        
        echo "## ä¿®æ”¹çš„é…ç½®é¡¹"
        diff -u "$old_config" "$new_config" | grep "^-" | grep "^-CONFIG_" | while read line; do
            local config=$(echo "$line" | sed 's/^-//')
            if grep -q "^$config" "$new_config"; then
                echo "$config"
            fi
        done
    } > "$output_file"
    
    echo "âœ… é…ç½®å·®å¼‚æŠ¥å‘Šå·²ç”Ÿæˆ: $output_file"
}

# =============================================================================
# æ—¶é—´å‡½æ•°
# =============================================================================

# è·å–å½“å‰æ—¶é—´æˆ³
get_timestamp() {
    date '+%Y-%m-%d %H:%M:%S'
}

# è·å–Unixæ—¶é—´æˆ³
get_unix_timestamp() {
    date +%s
}

# æ ¼å¼åŒ–æŒç»­æ—¶é—´
# å‚æ•°: $1=ç§’æ•°
# è¿”å›: æ ¼å¼åŒ–çš„æ—¶é—´å­—ç¬¦ä¸²
format_duration() {
    local seconds=$1
    local hours=$((seconds / 3600))
    local minutes=$(((seconds % 3600) / 60))
    local secs=$((seconds % 60))
    
    if [ $hours -gt 0 ]; then
        echo "${hours}å°æ—¶${minutes}åˆ†é’Ÿ${secs}ç§’"
    elif [ $minutes -gt 0 ]; then
        echo "${minutes}åˆ†é’Ÿ${secs}ç§’"
    else
        echo "${secs}ç§’"
    fi
}

# =============================================================================
# è¿›åº¦æ˜¾ç¤ºå‡½æ•°
# =============================================================================

# æ˜¾ç¤ºè¿›åº¦æ¡
# å‚æ•°: $1=å½“å‰è¿›åº¦, $2=æ€»è¿›åº¦, $3=æè¿°
show_progress() {
    local current=$1
    local total=$2
    local description=${3:-"å¤„ç†ä¸­"}
    local percentage=$((current * 100 / total))
    local filled=$((percentage / 2))
    local empty=$((50 - filled))
    
    # æ„å»ºè¿›åº¦æ¡
    local bar=""
    for ((i=0; i<filled; i++)); do
        bar+="â–ˆ"
    done
    for ((i=0; i<empty; i++)); do
        bar+="â–‘"
    done
    
    # è¾“å‡ºè¿›åº¦æ¡
    printf "\râ³ %s [%s] %d%% (%d/%d/%d/%d)" "$description" "$bar" "$percentage" "$current" "$total"
    
    # å¦‚æœå®Œæˆï¼Œæ¢è¡Œ
    if [ $current -eq $total ]; then
        echo ""
    fi
}

# =============================================================================
# åˆå§‹åŒ–
# =============================================================================

# åŠ è½½æ—¶æ˜¾ç¤ºåˆå§‹åŒ–ä¿¡æ¯
echo "ğŸ”§ å·¥å…·å‡½æ•°åº“å·²åŠ è½½"
