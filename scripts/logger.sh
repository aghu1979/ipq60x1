#!/bin/bash
# æ—¥å¿—æ¨¡å— - æä¾›ç»Ÿä¸€çš„æ—¥å¿—è¾“å‡ºæ ¼å¼å’Œé”™è¯¯å¤„ç†
# ä½œè€…: Mary
# æœ€åŽæ›´æ–°: 2025-10-18

# =============================================================================
# é¢œè‰²å®šä¹‰ - ç”¨äºŽæŽ§åˆ¶å°è¾“å‡ºçš„é¢œè‰²æŽ§åˆ¶
# =============================================================================

# åŸºç¡€é¢œè‰²
RED='\033[0;31m'      # çº¢è‰² - ç”¨äºŽé”™è¯¯ä¿¡æ¯
GREEN='\033[0;32m'    # ç»¿è‰² - ç”¨äºŽæˆåŠŸä¿¡æ¯
YELLOW='\033[1;33m'   # é»„è‰² - ç”¨äºŽè­¦å‘Šä¿¡æ¯
BLUE='\033[0;34m'     # è“è‰² - ç”¨äºŽä¸€èˆ¬ä¿¡æ¯
PURPLE='\033[0;35m'   # ç´«è‰² - ç”¨äºŽæ­¥éª¤æ ‡è®°
CYAN='\033[0;36m'     # é’è‰² - ç”¨äºŽè°ƒè¯•ä¿¡æ¯
WHITE='\033[1;37m'    # ç™½è‰² - ç”¨äºŽå¼ºè°ƒ
NC='\033[0m'          # æ— é¢œè‰² - é‡ç½®é¢œè‰²

# =============================================================================
# å›¾æ ‡å®šä¹‰ - ç”¨äºŽå¢žå¼ºæ—¥å¿—çš„å¯è¯»æ€§
# =============================================================================

ICON_INFO="â„¹ï¸"        # ä¿¡æ¯å›¾æ ‡
ICON_SUCCESS="âœ…"     # æˆåŠŸå›¾æ ‡
ICON_WARNING="âš ï¸"     # è­¾å‘Šå›¾æ ‡
ICON_ERROR="âŒ"       # é”™è¯¯å›¾æ ‡
ICON_START="ðŸš€"       # å¼€å§‹å›¾æ ‡
ICON_END="ðŸ"         # ç»“æŸå›¾æ ‡
ICON_DEBUG="ðŸ”"       # è°ƒè¯•å›¾æ ‡
ICON_PROGRESS="â³"     # è¿›è¡Œä¸­å›¾æ ‡

# =============================================================================
# æ—¥å¿—çº§åˆ«å®šä¹‰ - ç”¨äºŽæŽ§åˆ¶æ—¥å¿—è¾“å‡ºçš„è¯¦ç»†ç¨‹åº¦
# =============================================================================

LOG_LEVEL_INFO=1       # ä¿¡æ¯çº§åˆ«
LOG_LEVEL_SUCCESS=2    # æˆåŠŸçº§åˆ«
LOG_LEVEL_WARNING=3    # è­‰å‘Šçº§åˆ«
LOG_LEVEL_ERROR=4      # é”™è¯¯çº§åˆ«
LOG_LEVEL_DEBUG=5      # è°ƒè¯•çº§åˆ«

# å½“å‰æ—¥å¿—çº§åˆ«ï¼ˆå¯é€šè¿‡çŽ¯å¢ƒå˜é‡LOG_LEVELæŽ§åˆ¶ï¼‰
CURRENT_LOG_LEVEL=${LOG_LEVEL_INFO}

# =============================================================================
# æ—¥å¿—æ–‡ä»¶å®šä¹‰
# =============================================================================

# ä¸»æ—¥å¿—æ–‡ä»¶
LOG_FILE="build.log"
# é”™è¯¯æ—¥å¿—æ–‡ä»¶
ERROR_LOG="error.log"
# æ‘˜è¦æ—¥å¿—æ–‡ä»¶
SUMMARY_LOG="summary.log"

# =============================================================================
# åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
# =============================================================================

# åˆå§‹åŒ–æ—¥å¿—æ–‡ä»¶
init_log() {
    # åˆ›å»ºä¸»æ—¥å¿—æ–‡ä»¶
    {
        echo "========================================"
        echo "OpenWrt Build Log"
        echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "========================================"
        echo ""
    } > $LOG_FILE
    
    # åˆ›å»ºé”™è¯¯æ—¥å¿—æ–‡ä»¶
    {
        echo "========================================"
        echo "OpenWrt Error Log"
        echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "========================================"
        echo ""
    } > $ERROR_LOG
    
    # åˆ›å»ºæ‘˜è¦æ—¥å¿—æ–‡ä»¶
    {
        echo "========================================"
        echo "OpenWrt Build Summary"
        echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "========================================"
        echo ""
    } > $SUMMARY_LOG
}

# =============================================================================
# é€šç”¨æ—¥å¿—è¾“å‡ºå‡½æ•°
# =============================================================================

# é€šç”¨æ—¥å¿—è¾“å‡ºå‡½æ•°
# å‚æ•°: $1=çº§åˆ«, $2=é¢œè‰², $3=å›¾æ ‡, $4=æ¶ˆæ¯
log() {
    local level=$1
    local color=$2
    local icon=$3
    local message=$4
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # æŽ§åˆ¶å°è¾“å‡ºï¼ˆå¸¦é¢œè‰²å’Œå›¾æ ‡ï¼‰
    echo -e "${color}[${icon}]${NC} ${timestamp} - ${message}"
    
    # æ–‡ä»¶è¾“å‡ºï¼ˆä¸å¸¦é¢œè‰²ï¼‰
    echo "[${level}] ${timestamp} - ${message}" >> $LOG_FILE
}

# =============================================================================
# å…·ä½“çº§åˆ«çš„æ—¥å¿—å‡½æ•°
# =============================================================================

# ä¿¡æ¯æ—¥å¿—
log_info() {
    if [ $CURRENT_LOG_LEVEL -le $LOG_LEVEL_INFO ]; then
        log "INFO" "$BLUE" "$ICON_INFO" "$1"
    fi
}

# æˆåŠŸæ—¥å¿—
log_success() {
    if [ $CURRENT_LOG_LEVEL -le $LOG_LEVEL_SUCCESS ]; then
        log "SUCCESS" "$GREEN" "$ICON_SUCCESS" "$1"
    fi
}

# è­¾å‘Šæ—¥å¿—
log_warning() {
    if [ $CURRENT_LOG_LEVEL -le $LOG_LEVEL_WARNING ]; then
        log "WARNING" "$YELLOW" "$ICON_WARNING" "$1"
    fi
}

# é”™è¯¯æ—¥å¿—
log_error() {
    if [ $CURRENT_LOG_LEVEL -le $LOG_LEVEL_ERROR ]; then
        log "ERROR" "$RED" "$ICON_ERROR" "$1"
        
        # è®°å½•åˆ°é”™è¯¯æ—¥å¿—
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $1" >> $ERROR_LOG
        
        # è®°å½•é”™è¯¯ä¸Šä¸‹æ–‡ï¼ˆå‰1000è¡Œï¼‰
        if [ -f "$LOG_FILE" ]; then
            {
                echo ""
                echo "========================================"
                echo "é”™è¯¯ä¸Šä¸‹æ–‡ï¼ˆå‰1000è¡Œï¼‰"
                echo "========================================"
                tail -n 1000 $LOG_FILE >> $ERROR_LOG
            }
        fi
        
        # ç”Ÿæˆé”™è¯¯æ‘˜è¦
        generate_error_summary "$1"
    fi
}

# è°ƒè¯•æ—¥å¿—
log_debug() {
    if [ $CURRENT_LOG_LEVEL -le $LOG_LEVEL_DEBUG ]; then
        log "DEBUG" "$CYAN" "$ICON_DEBUG" "$1"
    fi
}

# =============================================================================
# æ­¥éª¤æ ‡è®°å‡½æ•°
# =============================================================================

# æ­¥éª¤å¼€å§‹æ ‡è®°
# å‚æ•°: $1=æ­¥éª¤åç§°
step_start() {
    local message=$1
    
    # æŽ§åˆ¶å°è¾“å‡º
    echo -e "\n${PURPLE}========== ${ICON_START} å¼€å§‹: $1 ==========${NC}" | tee -a $LOG_FILE
    
    # æ—¥å¿—è®°å½•
    log_info "å¼€å§‹æ‰§è¡Œ: $1"
    
    # è®°å½•å¼€å§‹æ—¶é—´åˆ°çŽ¯å¢ƒå˜é‡
    echo "STEP_START_TIME=$(date +%s)" >> $GITHUB_ENV
    
    # è®°å½•åˆ°æ‘˜è¦æ—¥å¿—
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] å¼€å§‹: $1" >> $SUMMARY_LOG
}

# æ­¥éª¤ç»“æŸæ ‡è®°
# å‚æ•°: $1=æ­¥éª¤åç§°
step_end() {
    local message=$1
    local end_time=$(date +%s)
    local start_time=${STEP_START_TIME:-0}
    local duration=$((end_time - start_time))
    
    # æ ¼å¼åŒ–æŒç»­æ—¶é—´
    local hours=$((duration / 3600))
    local minutes=$(((duration % 3600) / 60))
    local seconds=$((duration % 60))
    local duration_str=""
    
    if [ $hours -gt 0 ]; then
        duration_str="${hours}å°æ—¶${minutes}åˆ†é’Ÿ${seconds}ç§’"
    elif [ $minutes -gt 0 ]; then
        duration_str="${minutes}åˆ†é’Ÿ${seconds}ç§’"
    else
        duration_str="${seconds}ç§’"
    fi
    
    # æŽ§åˆ¶å°è¾“å‡º
    echo -e "${PURPLE}========== ${ICON_END} å®Œæˆ: $1 (è€—æ—¶: ${duration_str}) ==========${NC}\n" | tee -a $LOG_FILE
    
    # æ—¥å¿—è®°å½•
    log_success "å®Œæˆæ‰§è¡Œ: $1 (è€—æ—¶: ${duration_str})"
    
    # è®°å½•åˆ°æ‘˜è¦æ—¥å¿—
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] å®Œæˆ: $1 (è€—æ—¶: ${duration_str})" >> $SUMMARY_LOG
}

# =============================================================================
# é”™è¯¯å¤„ç†å‡½æ•°
# =============================================================================

# ç”Ÿæˆé”™è¯¯æ‘˜è¦
# å‚æ•°: $1=é”™è¯¯æ¶ˆæ¯
generate_error_summary() {
    local error_msg=$1
    local summary_file="error_summary.md"
    
    # ç”ŸæˆMarkdownæ ¼å¼çš„é”™è¯¯æ‘˜è¦
    cat > $summary_file << EOF
# ðŸš¨ ç¼–è¯‘é”™è¯¯æ‘˜è¦

## é”™è¯¯ä¿¡æ¯
\`\`\`
 $error_msg
\`\`\`

## æ—¶é—´æˆ³
 $(date '+%Y-%m-%d %H:%M:%S')

## è¯¦ç»†æ—¥å¿—
- ðŸ”— [å®Œæ•´æ—¥å¿—]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)
- ðŸ”— [é”™è¯¯æ—¥å¿—æŸ¥çœ‹]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)

## çŸ¥è¯†ä¿¡æ¯
- Runner: ${{ runner.os }}
- Workflow: $GITHUB_WORKFLOW
- Job: $GITHUB_JOB
- åˆ†æ”¯: $GITHUB_REF_NAME

## å»ºè®®è§£å†³æ–¹æ¡ˆ
1. æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®
2. çŸ¥é“ç½‘ç»œè¿žæŽ¥æ­£å¸¸
3. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—èŽ·å–æ›´å¤šä¿¡æ¯
4. å¦‚æžœé—®é¢˜æŒç»­ï¼Œè¯·æäº¤Issue

EOF
    
    echo "ðŸ“„ é”™è¯¯æ‘˜è¦å·²ç”Ÿæˆ: $summary_file"
}

# =============================================================================
# åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
# =============================================================================

# è„šæœ¬åŠ è½½æ—¶è‡ªåŠ¨åˆå§‹åŒ–
init_log
