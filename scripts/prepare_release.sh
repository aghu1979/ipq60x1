#!/bin/bash
# å‘å¸ƒå‡†å¤‡è„šæœ¬ - å‡†å¤‡Releaseå†…å®¹å’Œå‘å¸ƒè¯´æ˜
# ä½œè€…: Mary
# æœ€åæ›´æ–°: 2024-01-XX

# åŠ è½½ä¾èµ–æ¨¡å—
source ./scripts/logger.sh

# =============================================================================
# ä¿¡æ¯è·å–å‡½æ•°
# =============================================================================

# è·å–å†…æ ¸ç‰ˆæœ¬
# è¿”å›: å†…æ ¸ç‰ˆæœ¬å­—ç¬¦ä¸²
get_kernel_version() {
    if [ -f ".config" ]; then
        # ä»é…ç½®æ–‡ä»¶ä¸­æå–å†…æ ¸ç‰ˆæœ¬
        local kernel_ver=$(grep "^CONFIG_KERNEL_VERSION" .config | cut -d'"' -f2)
        if [ -n "$kernel_ver" ]; then
            echo "$kernel_ver"
        else
            # å°è¯•å…¶ä»–æ–¹å¼è·å–
            kernel_ver=$(grep "^CONFIG_KERNEL" .config | head -n1 | cut -d'=' -f2 | tr -d '"')
            echo "${kernel_ver:-æœªçŸ¥}"
        fi
    else
        echo "æœªçŸ¥"
    fi
}

# è·å–è®¾å¤‡åˆ—è¡¨
# è¿”å›: è®¾å¤‡åˆ—è¡¨å­—ç¬¦ä¸²
get_device_list() {
    # ä»é…ç½®æ–‡ä»¶ä¸­æå–è®¾å¤‡åˆ—è¡¨
    local devices=$(grep "CONFIG_TARGET_DEVICE_.*_DEVICE_.*=y" .config 2>/dev/null | \
                   sed 's/.*_DEVICE_\(.*\)=y/\1/' | \
                   sort -u | \
                   tr '\n' ', ' | sed 's/,$//')
    echo "${devices:-æ— }"
}

# è·å–Luciåº”ç”¨åˆ—è¡¨
# è¿”å›: Luciåº”ç”¨åˆ—è¡¨
get_luci_apps() {
    # è·å–æ‰€æœ‰Luciåº”ç”¨
    local apps=$(grep "^CONFIG_PACKAGE_luci-app.*=y" .config 2>/dev/null | \
                cut -d'=' -f1 | \
                sed 's/CONFIG_PACKAGE_//' | \
                sort | \
                head -20)  # é™åˆ¶æ˜¾ç¤ºæ•°é‡
    
    # æ ¼å¼åŒ–è¾“å‡º
    if [ -n "$apps" ]; then
        echo "$apps" | while read app; do
            echo "- $app"
        done
    else
        echo "æ— "
    fi
}

# è·å–ç¼–è¯‘ä¿¡æ¯
# è¿”å›: ç¼–è¯‘ä¿¡æ¯å­—ç¬¦ä¸²
get_build_info() {
    local build_date=$(date '+%Y-%m-%d %H:%M:%S')
    local build_host=$(hostname)
    local build_user=$(whoami)
    
    echo "ç¼–è¯‘æ—¶é—´: $build_date"
    echo "ç¼–è¯‘ä¸»æœº: $build_host"
    echo "ç¼–è¯‘ç”¨æˆ·: $build_user"
}

# =============================================================================
# å‘å¸ƒè¯´æ˜ç”Ÿæˆå‡½æ•°
# =============================================================================

# ç”Ÿæˆå‘å¸ƒè¯´æ˜
# å‚æ•°: $1=SoCï¼ˆé»˜è®¤ipq60xxï¼‰
generate_release_notes() {
    local soc="${1:-ipq60xx}"
    local date=$(date '+%Y-%m-%d %H:%M:%S')
    local kernel_ver=$(get_kernel_version)
    local devices=$(get_device_list)
    local build_info=$(get_build_info)
    
    # ç”ŸæˆMarkdownæ ¼å¼çš„å‘å¸ƒè¯´æ˜
    cat << EOF
# OpenWrt å›ºä»¶å‘å¸ƒ - $soc

## ğŸ“¥ ä¸‹è½½è¯´æ˜

### å›ºä»¶æ–‡ä»¶è¯´æ˜
- **\*-factory-*.bin**: ç”¨äºé¦–æ¬¡åˆ·æœºæˆ–æ¢å¤å‡ºå‚è®¾ç½®
- **\*-sysupgrade-*.bin**: ç”¨äºç³»ç»Ÿå‡çº§ï¼ˆä¿ç•™é…ç½®ï¼‰
- **æ ¡éªŒå’Œæ–‡ä»¶**: è¯·ä¸‹è½½åéªŒè¯æ–‡ä»¶å®Œæ•´æ€§

### åˆ·æœºæ­¥éª¤
1. ä¸‹è½½å¯¹åº”è®¾å¤‡çš„å›ºä»¶æ–‡ä»¶
2. ä½¿ç”¨SHA256æ ¡éªŒå’ŒéªŒè¯æ–‡ä»¶å®Œæ•´æ€§
3. æ ¹æ®è®¾å¤‡ç±»å‹é€‰æ‹©åˆé€‚çš„åˆ·æœºæ–¹æ³•
4. åˆ·æœºåæ¢å¤å‡ºå‚è®¾ç½®

## ğŸ”‘ åŸºæœ¬ä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| **é»˜è®¤ç®¡ç†åœ°å€** | 192.168.111.1 |
| **é»˜è®¤ç”¨æˆ·** | root |
| **é»˜è®¤å¯†ç ** | noneï¼ˆç©ºå¯†ç ï¼‰ |
| **é»˜è®¤WiFiå¯†ç ** | 12345678 |
| **SSHç«¯å£** | 22 |

## ğŸ“‹ å›ºä»¶ä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| **åŒ…å«åˆ†æ”¯** | openwrt, immwrt, libwrt |
| **åŒ…å«è®¾å¤‡** | $devices |
| **åŒ…å«é…ç½®** | Pro, Max, Ultra |
| **å†…æ ¸ç‰ˆæœ¬** | $kernel_ver |
| **ç¼–è¯‘æ—¶é—´** | $date |

## ğŸ“¦ ç¼–è¯‘çš„Luciåº”ç”¨åˆ—è¡¨

 $(get_luci_apps)

## ğŸ‘¤ ä½œè€…ä¿¡æ¯

- **ä½œè€…**: Mary
- **é¡¹ç›®ä»“åº“**: [$GITHUB_REPOSITORY]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY)
- **ç¼–è¯‘ä»»åŠ¡**: [#$GITHUB_RUN_NUMBER]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)

## ğŸ“ é™„ä»¶è¯´æ˜

| æ–‡ä»¶ç±»å‹ | è¯´æ˜ |
|----------|------|
| **\*-factory-*.bin** | åˆ·æœºå›ºä»¶ |
| **\*-sysupgrade-*.bin** | å‡çº§å›ºä»¶ |
| **$soc-config.tar.gz** | æ‰€æœ‰é…ç½®æ–‡ä»¶ |
| **$soc-app.tar.gz** | æ‰€æœ‰è½¯ä»¶åŒ… |
| **$soc-log.tar.gz** | ç¼–è¯‘æ—¥å¿— |
| **checksums.txt** | æ–‡ä»¶æ ¡éªŒå’Œ |

## ğŸ”§ ç¼–è¯‘ç¯å¢ƒä¿¡æ¯

 $build_info

## âš ï¸ æ³¨æ„äº‹é¡¹

### é‡è¦æé†’
1. **åˆ·æœºå‰è¯·å¤‡ä»½åŸå›ºä»¶**
2. **é¦–æ¬¡åˆ·æœºä½¿ç”¨factory.bin**
3. **å‡çº§ä½¿ç”¨sysupgrade.bin**
4. **åˆ·æœºåå»ºè®®æ¢å¤å‡ºå‚è®¾ç½®**

### å…¼å®¹æ€§è¯´æ˜
- æœ¬å›ºä»¶ä»…é€‚ç”¨äºæŒ‡å®šçš„è®¾å¤‡å‹å·
- ä¸åŒè®¾å¤‡è¯·å‹¿æ··ç”¨å›ºä»¶
- å‡çº§å‰è¯·ç¡®è®¤è®¾å¤‡å‹å·

### æ€§èƒ½ä¼˜åŒ–
- å·²å¯ç”¨å¿…è¦çš„å†…æ ¸ä¼˜åŒ–
- é¢„è£…å¸¸ç”¨è½¯ä»¶åŒ…
- ä¼˜åŒ–ç½‘ç»œæ€§èƒ½

## ğŸ› é—®é¢˜åé¦ˆ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

1. **æŸ¥çœ‹æ—¥å¿—**
   - [å®Œæ•´ç¼–è¯‘æ—¥å¿—]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)
   - è®¾å¤‡æ—¥å¿—: \`logread\` æˆ– \`dmesg\`

2. **æ”¶é›†ä¿¡æ¯**
   - è®¾å¤‡å‹å·
   - å›ºä»¶ç‰ˆæœ¬
   - é—®é¢˜æè¿°
   - å¤ç°æ­¥éª¤

3. **æäº¤åé¦ˆ**
   - [æäº¤Issue]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/issues)
   - è¯·é™„ä¸Šç›¸å…³æ—¥å¿—å’Œæˆªå›¾

## ğŸ“š ç›¸å…³é“¾æ¥

- [OpenWrtå®˜ç½‘](https://openwrt.org)
- [é¡¹ç›®æºç ]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY)
- [æ›´æ–°æ—¥å¿—](CHANGELOG.md)

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ª GPL-3.0 è®¸å¯è¯ã€‚

---

**æ„Ÿè°¢ä½¿ç”¨ OpenWrt å›ºä»¶ï¼** ğŸ‰

å¦‚æœè§‰å¾—æœ‰ç”¨ï¼Œè¯·ç»™ä¸ªâ­ï¸æ”¯æŒä¸€ä¸‹ï¼
EOF
}

# =============================================================================
# è®¾å¤‡å¯¹æ¯”è¡¨ç”Ÿæˆå‡½æ•°
# =============================================================================

# ç”Ÿæˆè®¾å¤‡å¯¹æ¯”è¡¨
# å‚æ•°: æ— 
generate_device_comparison() {
    local output_file="device_comparison.md"
    
    log_info "ç”Ÿæˆè®¾å¤‡å¯¹æ¯”è¡¨: $output_file"
    
    # ç”Ÿæˆå¯¹æ¯”è¡¨
    cat > $output_file << EOF
# è®¾å¤‡æ”¯æŒå¯¹æ¯”

## æ”¯æŒçš„è®¾å¤‡

| è®¾å¤‡å‹å· | Proç‰ˆæœ¬ | Maxç‰ˆæœ¬ | Ultraç‰ˆæœ¬ | å¤‡æ³¨ |
|----------|---------|---------|-----------|------|
| jdcloud_re-ss-01 | âœ… | âœ… | âœ… | ä¸»æµè®¾å¤‡ |
| jdcloud_re-cs-02 | âœ… | âœ… | âœ… | ä¸»æµè®¾å¤‡ |

## ç‰ˆæœ¬å·®å¼‚

| åŠŸèƒ½ | Pro | Max | Ultra |
|------|-----|-----|-------|
| åŸºç¡€åŠŸèƒ½ | âœ… | âœ… | âœ… |
| é«˜çº§ç½‘ç»œ | âŒ | âœ… | âœ… |
| ç§‘å­¦ä¸Šç½‘ | âŒ | âŒ | âœ… |
| æ€§èƒ½ä¼˜åŒ– | åŸºç¡€ | å¢å¼º | æœ€å¼º |
| è½¯ä»¶åŒ…æ•°é‡ | åŸºç¡€ | ä¸°å¯Œ | æœ€å…¨ |

## é€‰æ‹©å»ºè®®

- **Proç‰ˆæœ¬**: é€‚åˆåŸºç¡€ä½¿ç”¨ï¼Œç¨³å®šå¯é 
- **Maxç‰ˆæœ¬**: é€‚åˆè¿›é˜¶ç”¨æˆ·ï¼ŒåŠŸèƒ½ä¸°å¯Œ
- **Ultraç‰ˆæœ¬**: é€‚åˆé«˜çº§ç”¨æˆ·ï¼ŒåŠŸèƒ½æœ€å…¨

EOF
    
    log_success "è®¾å¤‡å¯¹æ¯”è¡¨å·²ç”Ÿæˆ: $output_file"
}

# =============================================================================
# è½¯ä»¶åŒ…æ¸…å•ç”Ÿæˆå‡½æ•°
# =============================================================================

# ç”Ÿæˆè½¯ä»¶åŒ…æ¸…å•
# å‚æ•°: æ— 
generate_package_list() {
    local output_file="package_list.txt"
    
    log_info "ç”Ÿæˆè½¯ä»¶åŒ…æ¸…å•: $output_file"
    
    # ç”Ÿæˆæ¸…å•
    {
        echo "# è½¯ä»¶åŒ…æ¸…å•"
        echo "ç”Ÿæˆæ—¶é—´: $(date)"
        echo ""
        
        echo "## æ‰€æœ‰è½¯ä»¶åŒ…"
        if [ -d "release/packages" ]; then
            ls release/packages/*.ipk 2>/dev/null | xargs -n1 basename | sort
        else
            echo "æ— è½¯ä»¶åŒ…"
        fi
        echo ""
        
        echo "## åˆ†ç±»ç»Ÿè®¡"
        if [ -d "release/packages" ]; then
            echo "æ€»æ•°: $(ls release/packages/*.ipk 2>/dev/null | wc -l)"
            echo "å¤§å°: $(get_dir_size release/packages)"
        fi
    } > "$output_file"
    
    log_success "è½¯ä»¶åŒ…æ¸…å•å·²ç”Ÿæˆ: $output_file"
}

# =============================================================================
# æ›´æ–°æ—¥å¿—ç”Ÿæˆå‡½æ•°
# =============================================================================

# ç”Ÿæˆæ›´æ–°æ—¥å¿—
# å‚æ•°: æ— 
generate_changelog() {
    local output_file="CHANGELOG.md"
    
    log_info "ç”Ÿæˆæ›´æ–°æ—¥å¿—: $output_file"
    
    # ç”Ÿæˆæ›´æ–°æ—¥å¿—
    cat > $output_file << EOF
# æ›´æ–°æ—¥å¿—

## [$(date '+%Y-%m-%d')] - æ–°ç‰ˆæœ¬å‘å¸ƒ

### æ–°å¢
- æ”¯æŒå¤šèŠ¯ç‰‡æ¶æ„ç¼–è¯‘
- æ–°å¢è‡ªåŠ¨ç­¾ååŠŸèƒ½
- ä¼˜åŒ–ç¼“å­˜ç­–ç•¥
- å¢å¼ºé”™è¯¯å¤„ç†

### æ”¹è¿›
- æå‡ç¼–è¯‘é€Ÿåº¦
- ä¼˜åŒ–è½¯ä»¶åŒ…ä¾èµ–å¤„ç†
- æ”¹è¿›æ—¥å¿—ç³»ç»Ÿ
- å¢å¼ºäº§å‡ºç‰©ç®¡ç†

### ä¿®å¤
- ä¿®å¤é…ç½®åˆå¹¶é—®é¢˜
- è§£å†³è½¯ä»¶åŒ…å†²çª
- ä¿®å¤ç­¾åéªŒè¯é—®é¢˜

### å·²çŸ¥é—®é¢˜
- æš‚æ— 

## å†å²ç‰ˆæœ¬

### [2024-01-XX] - åˆå§‹ç‰ˆæœ¬
- åŸºç¡€åŠŸèƒ½å®ç°
- æ”¯æŒOpenWrtç¼–è¯‘
- åŸºæœ¬çš„äº§å‡ºç‰©å¤„ç†

EOF
    
    log_success "æ›´æ–°æ—¥å¿—å·²ç”Ÿæˆ: $output_file"
}

# =============================================================================
# ä¸»å‡½æ•°
# =============================================================================

# ä¸»å‡½æ•°
# å‚æ•°: $1=SoCï¼ˆé»˜è®¤ipq60xxï¼‰
main() {
    local soc="${1:-ipq60xx}"
    
    # å¼€å§‹æ­¥éª¤
    step_start "å‡†å¤‡å‘å¸ƒå†…å®¹"
    
    # ç”Ÿæˆå‘å¸ƒè¯´æ˜
    log_info "ç”Ÿæˆå‘å¸ƒè¯´æ˜..."
    generate_release_notes "$soc"
    
    # ç”Ÿæˆè¾…åŠ©æ–‡æ¡£
    generate_device_comparison
    generate_package_list
    generate_changelog
    
    # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
    echo ""
    echo "ğŸ“Š å‘å¸ƒç»Ÿè®¡:"
    echo "  - å›ºä»¶æ–‡ä»¶: $(ls release/*.bin 2>/dev/null | wc -l)"
    echo "  - é…ç½®åŒ…: $(ls release/*-config.tar.gz 2>/dev/null | wc -l)"
    echo "  - è½¯ä»¶åŒ…: $(ls release/*-app.tar.gz 2>/dev/null | wc -l)"
    echo "  - æ—¥å¿—åŒ…: $(ls release/*-log.tar.gz 2>/dev/null | wc -l)"
    echo "  - æ–‡æ¡£æ–‡ä»¶: $(ls *.md 2>/dev/null | wc -l)"
    
    # ç»“æŸæ­¥éª¤
    step_end "å‘å¸ƒå‡†å¤‡å®Œæˆ"
    
    log_success "æ‰€æœ‰å‘å¸ƒå†…å®¹å‡†å¤‡å®Œæˆ"
}

# =============================================================================
# è„šæœ¬å…¥å£ç‚¹
# =============================================================================

# å¦‚æœç›´æ¥æ‰§è¡Œæ­¤è„šæœ¬
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    main "$@"
fi
