name: Build All Systems

on:
  workflow_dispatch:
    inputs:
      include_packages:
        description: 'æ˜¯å¦åŒæ—¶ç¼–è¯‘è½¯ä»¶åŒ…'
        required: true
        default: true
        type: boolean
      packages:
        description: 'é€‰æ‹©è¦ç¼–è¯‘çš„è½¯ä»¶åŒ…ï¼ˆå½“include_packagesä¸ºtrueæ—¶ç”Ÿæ•ˆï¼‰'
        required: false
        default: 'Pro,Max,Ultra'
        type: string
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è‡ªåŠ¨ç¼–è¯‘æ‰€æœ‰

jobs:
  # ç¬¬ä¸€æ­¥ï¼šç¼–è¯‘æ‰€æœ‰æ ¸å¿ƒç³»ç»Ÿ
  build-all-cores:
    uses: ./.github/workflows/build-core.yml
    with:
      build_all: true

  # ç¬¬äºŒæ­¥ï¼šç¼–è¯‘æ‰€æœ‰è½¯ä»¶åŒ…
  build-all-packages:
    needs: build-all-cores
    if: inputs.include_packages == 'true'
    uses: ./.github/workflows/build-packages.yml
    with:
      build_all: true
      package: ${{ inputs.packages }}
      core-map: core-map-${{ github.run_id }}
    secrets: inherit

  # ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
  generate-report:
    needs: [build-all-cores, build-all-packages]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          pattern: "*-${{ github.run_id }}-*"
          merge-multiple: true
          path: all-artifacts

      - name: ğŸ“Š ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š
        run: |
          # åˆ›å»ºæŠ¥å‘Šç›®å½•
          mkdir -p reports
          
          # ç»Ÿè®¡æ ¸å¿ƒç³»ç»Ÿ
          CORE_COUNT=$(find all-artifacts -name "core-build-*" -type d | wc -l)
          FIRMWARE_COUNT=$(find all-artifacts -name "*.bin" -type f | wc -l)
          REPORT_COUNT=$(find all-artifacts -name "*.md" -type f | wc -l)
          
          # ç”ŸæˆæŠ¥å‘Š
          cat > reports/build-report.md << EOF
          # OpenWrt ç¼–è¯‘æŠ¥å‘Š
          
          **ç¼–è¯‘æ—¶é—´**: $(date)
          **è¿è¡ŒID**: ${{ github.run_id }}
          
          ## ğŸ“Š ç¼–è¯‘ç»Ÿè®¡
          
          - æ ¸å¿ƒç³»ç»Ÿæ•°é‡: $CORE_COUNT
          - å›ºä»¶æ–‡ä»¶æ•°é‡: $FIRMWARE_COUNT
          - æŠ¥å‘Šæ–‡ä»¶æ•°é‡: $REPORT_COUNT
          
          ## ğŸ“¦ æ ¸å¿ƒç³»ç»Ÿåˆ—è¡¨
          
          EOF
          
          # åˆ—å‡ºæ‰€æœ‰æ ¸å¿ƒç³»ç»Ÿ
          find all-artifacts -name "core-build-*" -type d | while read dir; do
            echo "- $(basename $dir)" >> reports/build-report.md
          done
          
          echo "" >> reports/build-report.md
          echo "## ğŸ”— å›ºä»¶æ–‡ä»¶" >> reports/build-report.md
          echo "" >> reports/build-report.md
          
          # åˆ—å‡ºæ‰€æœ‰å›ºä»¶
          find all-artifacts -name "*.bin" -type f | while read file; do
            echo "- $(basename $file)" >> reports/build-report.md
          done
          
          echo "âœ… æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: ğŸ“¤ ä¸Šä¼ æœ€ç»ˆæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: build-report-${{ github.run_id }}
          path: reports/
          retention-days: 30
