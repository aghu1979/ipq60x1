name: OpenWrt Core Build

on:
  workflow_call:
    inputs:
      chip:
        required: true
      branch:
        required: true
      config:
        required: true

jobs:
  base-build:
    runs-on: ubuntu-22.04
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      base-path: ${{ steps.cache-key.outputs.path }}
    steps:
      - name: ğŸ› ï¸ è®¾ç½®ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”‘ ç”Ÿæˆç¼“å­˜é”®
        id: cache-key
        run: |
          KEY="base-${{ inputs.chip }}-${{ inputs.branch }}-${{ hashFiles('.github/configs/base_*.config') }}"
          echo "key=$KEY" >> $GITHUB_OUTPUT
          echo "path=base-$KEY" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ æ¢å¤åŸºç¡€ç¯å¢ƒç¼“å­˜
        uses: actions/cache@v4
        id: cache
        with:
          path: ${{ steps.cache-key.outputs.path }}
          key: ${{ steps.cache-key.outputs.key }}

      - name: ğŸŒ± å‡†å¤‡åŸºç¡€ç¯å¢ƒ
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p ${{ steps.cache-key.outputs.path }}
          docker run --rm \
            -v $(pwd):/work \
            -w /work \
            openwrt/org:ubuntu-22.04 \
            bash -c "
              ./scripts/prepare-env.sh ${{ inputs.chip }} ${{ inputs.branch }}
              make defconfig
              make -j$(nproc) IGNORE_ERRORS=1
              tar -czf ${{ steps.cache-key.outputs.path }}/base.tar.gz .
            "

  final-build:
    needs: base-build
    runs-on: ubuntu-22.04
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ æ¢å¤åŸºç¡€ç¯å¢ƒ
        run: |
          mkdir -p base
          tar -xzf ${{ needs.base-build.outputs.base-path }}/base.tar.gz -C base

      - name: ğŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶
        run: |
          ./scripts/merge-config.sh \
            base/.config \
            .github/configs/${{ inputs.config }}.config \
            .config

      - name: ğŸ§ª æ£€æŸ¥è½¯ä»¶åŒ…
        run: |
          ./scripts/package-check.sh .config

      - name: ğŸš€ ç¼–è¯‘å›ºä»¶
        run: |
          docker run --rm \
            -v $(pwd):/work \
            -w /work/base \
            openwrt/org:ubuntu-22.04 \
            bash -c "
              cp ../.config .config
              make defconfig
              make -j$(nproc) IGNORE_ERRORS=1
            "

      - name: ğŸ“¦ æ”¶é›†äº§ç‰©
        run: |
          mkdir -p packages
          find base/bin/targets -name "*.bin" -exec cp {} ./ \;
          find base/bin/targets -name "*.manifest" -exec cp {} ./ \;
          find base/bin/targets -name "config.buildinfo" -exec cp {} ./ \;
          cp base/.config .config
          cp -r base/bin/packages packages/

      - name: ğŸ“¤ ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.chip }}-${{ inputs.branch }}-${{ inputs.config }}-${{ github.run_id }}
          path: |
            *.bin
            *.config
            *.manifest
            config.buildinfo
            packages/
          retention-days: 7
