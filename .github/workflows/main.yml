name: OpenWrt Multi-Branch Multi-Config Build

on:
  # æ‰‹åŠ¨è§¦å‘ï¼Œå…è®¸ç”¨æˆ·é€‰æ‹©æ“ä½œç³»ç»Ÿ
  workflow_dispatch:
    inputs:
      ubuntu_version:
        description: 'é€‰æ‹© Ubuntu ç‰ˆæœ¬'
        required: true
        default: 'ubuntu-22.04'
        type: choice
        options:
          - ubuntu-22.04
          - ubuntu-24.04
  # å®šæ—¶è§¦å‘ï¼ŒåŒ—äº¬æ—¶é—´æ¯å‘¨äº”0ç‚¹ (UTC+8) -> UTC 16:00
  schedule:
    - cron: '0 16 * * 4'
  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main
    paths:
      - '.github/**'
      - 'configs/**'
      - 'scripts/**'

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  CHIPSET: ipq60xx
  LOG_FILE: build.log
  # Release ç›¸å…³ä¿¡æ¯
  DEFAULT_IP: "192.168.111.1"
  DEFAULT_USER: "root"
  DEFAULT_PASS: "none"
  DEFAULT_WIFI_PASS: "12345678"
  AUTHOR: "Mary"

jobs:
  # Job 1: å‡†å¤‡åŸºç¡€ç¼–è¯‘ç¯å¢ƒ
  prepare-env:
    name: å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
    runs-on: ${{ github.event.inputs.ubuntu_version || 'ubuntu-22.04' }}
    outputs:
      # å°†æå–çš„è®¾å¤‡åå’Œå“ˆå¸Œæ–‡ä»¶åä¼ é€’ç»™åç»­job
      device_names: ${{ steps.extract_devices.outputs.devices }}
      hashes_file_name: ${{ steps.hash.outputs.name }}
      # å°†æˆåŠŸæ„å»ºçš„åˆ†æ”¯åˆ—è¡¨ä¼ é€’ç»™build job
      built_branches: ${{ steps.set-outputs.outputs.branches }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          # åŠ è½½é€šç”¨å‡½æ•°
          source .github/scripts/common.sh
          step_start "åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ"
          # æ¸…ç†ç£ç›˜ç©ºé—´
          check_disk_space
          # å®‰è£…ä¾èµ–
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2204)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "Asia/Shanghai"
          # åˆ›å»ºå·¥ä½œç›®å½•
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          step_end "åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ"

      - name: æå–è®¾å¤‡å
        id: extract_devices
        run: |
          source .github/scripts/common.sh
          step_start "æå–è®¾å¤‡å"
          local devices=$(extract_device_names ".github/configs/base_${{ env.CHIPSET }}.config")
          echo "devices=$devices" >> $GITHUB_OUTPUT
          step_end "æå–è®¾å¤‡å"

      - name: ç”Ÿæˆç¼“å­˜å“ˆå¸Œæ–‡ä»¶
        id: hash
        run: |
          source .github/scripts/common.sh
          step_start "ç”Ÿæˆç¼“å­˜å“ˆå¸Œæ–‡ä»¶"
          local hash_file="hashes-${{ env.CHIPSET }}.txt"
          generate_hashes_file "$hash_file" \
            ".github/scripts/" \
            ".github/configs/base_${{ env.CHIPSET }}.config"
          echo "name=$hash_file" >> $GITHUB_OUTPUT
          step_end "ç”Ÿæˆç¼“å­˜å“ˆå¸Œæ–‡ä»¶"

      - name: ç¼“å­˜ Dl ç›®å½•
        uses: actions/cache@v4
        with:
          path: /workdir/dl
          key: ${{ env.CHIPSET }}-dl-${{ hashFiles(steps.hash.outputs.name) }}
          restore-keys: |
            ${{ env.CHIPSET }}-dl-

      - name: ç¼“å­˜ Staging å’Œ Build ç›®å½•
        uses: actions/cache@v4
        with:
          path: |
            /workdir/staging_dir
            /workdir/build_dir
          key: ${{ env.CHIPSET }}-build-${{ hashFiles(steps.hash.outputs.name) }}
          restore-keys: |
            ${{ env.CHIPSET }}-build-

      - name: ç¼“å­˜ CCache
        uses: actions/cache@v4
        with:
          path: /workdir/.ccache
          key: ${{ env.CHIPSET }}-ccache-${{ hashFiles(steps.hash.outputs.name) }}
          restore-keys: |
            ${{ env.CHIPSET }}-ccache-

      - name: å‡†å¤‡åˆ†æ”¯ç¯å¢ƒ (çŸ©é˜µ)
        strategy:
          fail-fast: false
          matrix:
            include:
              - branch: immwrt
                repo_url: https://github.com/laipeng668/immortalwrt.git
                repo_branch: master
                repo_short: immwrt
              - branch: openwrt
                repo_url: https://github.com/laipeng668/openwrt.git
                repo_branch: master
                repo_short: openwrt
              - branch: libwrt
                repo_url: https://github.com/laipeng668/openwrt-6.x.git
                repo_branch: k6.12-nss
                repo_short: libwrt

        run: |
          source .github/scripts/common.sh
          step_start "å‡†å¤‡ ${{ matrix.branch }} åˆ†æ”¯ç¯å¢ƒ"
          
          # å…‹éš†æºç 
          log_info "å…‹éš† ${{ matrix.repo_url }}..."
          git clone ${{ matrix.repo_url }} -b ${{ matrix.repo_branch }} --single-branch /workdir/${{ matrix.branch }}
          
          # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
          log_info "æ‰§è¡Œ ${{ matrix.branch }} çš„è‡ªå®šä¹‰è„šæœ¬..."
          cd /workdir/${{ matrix.branch }}
          $GITHUB_WORKSPACE/.github/scripts/custom_${{ matrix.branch }}.sh
          
          # æ›´æ–°å’Œå®‰è£… Feeds
          log_info "æ›´æ–°å’Œå®‰è£… Feeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # åˆå¹¶åŸºç¡€é…ç½®
          log_info "åˆå¹¶åŸºç¡€é…ç½®æ–‡ä»¶..."
          cat $GITHUB_WORKSPACE/.github/configs/base_${{ env.CHIPSET }}.config > .config
          cat $GITHUB_WORKSPACE/.github/configs/base_${{ matrix.branch }}.config >> .config
          make defconfig
          
          # ä¸‹è½½æºç 
          log_info "ä¸‹è½½æ‰€æœ‰è½¯ä»¶åŒ…æºç ..."
          make download -j$(nproc)
          
          step_end "å‡†å¤‡ ${{ matrix.branch }} åˆ†æ”¯ç¯å¢ƒ"

      - name: ä¸Šä¼ ç¯å¢ƒ Artifact
        uses: actions/upload-artifact@v4
        with:
          name: env_${{ env.CHIPSET }}
          path: /workdir
          retention-days: 1

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          # å°†æ‰€æœ‰åˆ†æ”¯åç”¨é€—å·è¿æ¥
          echo "branches=immwrt,openwrt,libwrt" >> $GITHUB_OUTPUT

  # Job 2: çŸ©é˜µç¼–è¯‘
  build:
    name: ç¼–è¯‘å›ºä»¶ (${{ matrix.branch }}-${{ matrix.config }})
    needs: prepare-env
    runs-on: ${{ github.event.inputs.ubuntu_version || 'ubuntu-22.04' }}
    strategy:
      fail-fast: false # å…è®¸æŸä¸ªé…ç½®å¤±è´¥ï¼Œå…¶ä»–ç»§ç»­
      matrix:
        branch: ${{ fromJson(format('["%s"]', needs.prepare-env.outputs.built_branches)) }}
        config: [Pro, Max, Ultra]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          source .github/scripts/common.sh
          step_start "åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ"
          check_disk_space
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2204)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "Asia/Shanghai"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          step_end "åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ"

      - name: ä¸‹è½½ç¯å¢ƒ Artifact
        uses: actions/download-artifact@v4
        with:
          name: env_${{ env.CHIPSET }}
          path: /workdir

      - name: æ¢å¤ CCache
        uses: actions/cache@v4
        with:
          path: /workdir/.ccache
          key: ${{ env.CHIPSET }}-ccache-${{ hashFiles(format('/workdir/hashes-{0}.txt', env.CHIPSET)) }}

      - name: åˆå¹¶æœ€ç»ˆé…ç½®å¹¶æ£€æŸ¥ LuCI åŒ…
        run: |
          source .github/scripts/common.sh
          step_start "åˆå¹¶æœ€ç»ˆé…ç½®å¹¶æ£€æŸ¥ LuCI åŒ…"
          
          cd /workdir/${{ matrix.branch }}
          
          # ä¿å­˜åˆå¹¶å‰çš„é…ç½®
          cp .config .config.before
          
          # åˆå¹¶ç”¨æˆ·é…ç½®
          cat $GITHUB_WORKSPACE/.github/configs/${{ matrix.config }}.config >> .config
          
          # æ ¼å¼åŒ–å¹¶è¡¥å…¨é…ç½®
          make defconfig
          
          # å¯¹æ¯” LuCI åŒ…
          if ! compare_luci_packages ".config.before" ".config"; then
            log_error "LuCI è½¯ä»¶åŒ…æ£€æŸ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼"
            exit 1
          fi
          
          step_end "åˆå¹¶æœ€ç»ˆé…ç½®å¹¶æ£€æŸ¥ LuCI åŒ…"

      - name: ç¼–è¯‘å›ºä»¶
        run: |
          source .github/scripts/common.sh
          step_start "ç¼–è¯‘ ${{ matrix.branch }}-${{ matrix.config }} å›ºä»¶"
          cd /workdir/${{ matrix.branch }}
          export CCACHE_DIR=/workdir/.ccache
          make -j$(nproc) || make -j1 V=s
          step_end "ç¼–è¯‘ ${{ matrix.branch }}-${{ matrix.config }} å›ºä»¶"

      - name: æ•´ç†äº§å‡ºç‰©
        run: |
          source .github/scripts/common.sh
          step_start "æ•´ç† ${{ matrix.branch }}-${{ matrix.config }} äº§å‡ºç‰©"
          
          local source_dir="/workdir/${{ matrix.branch }}/bin/targets/${{ env.CHIPSET }}"
          local target_dir="/workdir/artifacts/${{ matrix.branch }}-${{ matrix.config }}"
          
          rename_and_package_artifacts "$source_dir" "$target_dir" "${{ matrix.branch }}" "${{ env.CHIPSET }}" "${{ matrix.config }}" "${{ needs.prepare-env.outputs.device_names }}"
          
          step_end "æ•´ç† ${{ matrix.branch }}-${{ matrix.config }} äº§å‡ºç‰©"

      - name: ä¸Šä¼ äº§å‡ºç‰© Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build_${{ matrix.branch }}_${{ matrix.config }}
          path: /workdir/artifacts/${{ matrix.branch }}-${{ matrix.config }}/
          retention-days: 1

  # Job 3: å‘å¸ƒ
  publish:
    name: å‘å¸ƒåˆ° Release
    needs: [prepare-env, build]
    runs-on: ubuntu-latest
    if: success() # åªæœ‰æ‰€æœ‰ç¼–è¯‘æˆåŠŸåæ‰æ‰§è¡Œ

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰äº§å‡ºç‰©
        uses: actions/download-artifact@v4
        with:
          path: /tmp/artifacts

      - name: æ•´åˆä¸æ‰“åŒ…
        run: |
          source .github/scripts/common.sh
          step_start "æ•´åˆä¸æ‰“åŒ…æ‰€æœ‰äº§å‡ºç‰©"
          
          local release_dir="/tmp/release"
          mkdir -p "${release_dir}"
          
          # æ‰“åŒ…æ‰€æœ‰é…ç½®æ–‡ä»¶
          find /tmp/artifacts -name "configs" -type d | xargs -I {} cp -r -n {} "${release_dir}/"
          tar -czf "${release_dir}/${{ env.CHIPSET }}-config.tar.gz" -C "${release_dir}" configs/
          
          # æ‰“åŒ…æ‰€æœ‰è½¯ä»¶åŒ…
          find /tmp/artifacts -name "apps" -type d | xargs -I {} cp -r -n {} "${release_dir}/"
          tar -czf "${release_dir}/${{ env.CHIPSET }}-app.tar.gz" -C "${release_dir}" apps/
          
          # ç§»åŠ¨æ‰€æœ‰å›ºä»¶åˆ°å‘å¸ƒç›®å½•
          find /tmp/artifacts -name "*.bin" -exec cp {} "${release_dir}/" \;
          
          step_end "æ•´åˆä¸æ‰“åŒ…æ‰€æœ‰äº§å‡ºç‰©"

      - name: ç”Ÿæˆ Release Body
        id: generate_body
        run: |
          source .github/scripts/common.sh
          step_start "ç”Ÿæˆ Release Body"
          
          local tag="${{ env.CHIPSET }}-$(date +'%Y%m%d')"
          local kernel_version=$(find /tmp/artifacts -name "*.manifest" -exec grep -m1 '^kernel:' {} \; | head -n1 | cut -d' ' -f2)
          local luci_apps=$(find /tmp/release -name "*.manifest" -exec grep -h 'luci-app-' {} \; | sort -u | tr '\n' ', ')
          
          cat > /tmp/release_body.md << EOF
          ## OpenWrt å›ºä»¶å‘å¸ƒ
          
          ---
          
          ### ğŸ“¦ åŸºæœ¬ä¿¡æ¯
          - **é»˜è®¤ç®¡ç†åœ°å€**: ${{ env.DEFAULT_IP }}
          - **é»˜è®¤ç”¨æˆ·**: ${{ env.DEFAULT_USER }}
          - **é»˜è®¤å¯†ç **: ${{ env.DEFAULT_PASS }}
          - **é»˜è®¤WIFIå¯†ç **: ${{ env.DEFAULT_WIFI_PASS }}
          
          ### ğŸŒ³ åˆ†æ”¯ä¸é…ç½®
          - **åŒ…å«åˆ†æ”¯**: ImmortalWrt, OpenWrt, LibWrt
          - **åŒ…å«é…ç½®**: Pro, Max, Ultra
          
          ### ğŸ”§ ç³»ç»Ÿä¿¡æ¯
          - **å†…æ ¸ç‰ˆæœ¬**: ${kernel_version}
          - **ç¼–è¯‘çš„LuCIåº”ç”¨åˆ—è¡¨**: ${luci_apps}
          
          ### ğŸ‘¤ å‘å¸ƒä¿¡æ¯
          - **ä½œè€…**: ${{ env.AUTHOR }}
          - **å‘å¸ƒæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S %Z')
          
          ---
          
          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          è¯·æ ¹æ®æ‚¨çš„ **è®¾å¤‡å‹å·** å’Œ **éœ€æ±‚é…ç½®** ä¸‹è½½å¯¹åº”çš„å›ºä»¶æ–‡ä»¶ã€‚
          
          ### ğŸ“ é™„ä»¶è¯´æ˜
          - \`*-factory.bin\`: é€‚ç”¨äºä»åŸå‚å›ºä»¶åˆ·å…¥ã€‚
          - \`*-sysupgrade.bin\`: é€‚ç”¨äºåœ¨å·²åˆ·å…¥OpenWrtçš„è®¾å¤‡ä¸Šå‡çº§ã€‚
          - \`${{ env.CHIPSET }}-config.tar.gz\`: æ‰€æœ‰å›ºä»¶çš„é…ç½®æ–‡ä»¶(.config, .manifestç­‰)ã€‚
          - \`${{ env.CHIPSET }}-app.tar.gz\`: æ‰€æœ‰ç¼–è¯‘ç”Ÿæˆçš„è½¯ä»¶åŒ…(.ipk)ã€‚
          EOF
          
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "body_file=/tmp/release_body.md" >> $GITHUB_OUTPUT
          
          step_end "ç”Ÿæˆ Release Body"

      - name: åˆ›å»ºå¹¶å‘å¸ƒ Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.generate_body.outputs.tag }}
          body_path: ${{ steps.generate_body.outputs.body_file }}
          files: |
            /tmp/release/*.bin
            /tmp/release/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 4: æ¸…ç†
  cleanup:
    name: æ¸…ç† Artifacts
    needs: [prepare-env, build, publish]
    runs-on: ubuntu-latest
    if: always() # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ

    steps:
      - name: åˆ é™¤æ‰€æœ‰ Artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            env_${{ env.CHIPSET }}
            build_*
          failOnError: false
