name: OpenWrt Build Scheduler

on:
  workflow_dispatch:
    inputs:
      config:
        description: 'é€‰æ‹©é…ç½®æ–‡ä»¶'
        required: true
        default: 'libwrt'
        type: choice
        options:
        - libwrt
      ssh:
        description: 'SSHè¿æ¥åˆ°Actions'
        required: false
        default: 'false'
        type: boolean
  push:
    branches:
      - main
    paths:
      - '.github/workflows/main.yml'
      - 'scripts/**'
      - 'config/**'
  schedule:
    - cron: '0 2 * * 1' # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ„å»º

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  DIY_P1_SH: scripts/diy.sh
  DIY_P2_SH: scripts/config-manager.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: false
  TZ: Asia/Shanghai
  PRODUCT_NAME: OpenWrt

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      build-time: ${{ steps.set-matrix.outputs.build-time }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: ç”Ÿæˆæ„å»ºçŸ©é˜µ
        id: set-matrix
        run: |
          # è®¾ç½®æ„å»ºæ—¶é—´
          echo "build-time=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆæ„å»ºçŸ©é˜µ
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # å®šæ—¶æ„å»ºä½¿ç”¨æ‰€æœ‰é…ç½®
            echo 'matrix={"chip": ["ipq60xx"], "branch": ["main"], "config": ["libwrt"]}' >> $GITHUB_OUTPUT
          else
            # æ‰‹åŠ¨è§¦å‘ä½¿ç”¨é€‰æ‹©çš„é…ç½®
            echo 'matrix={"chip": ["ipq60xx"], "branch": ["main"], "config": ["${{ github.event.inputs.config || 'libwrt' }}"]}' >> $GITHUB_OUTPUT
          fi

  build-base:
    needs: generate-matrix
    if: needs.generate-matrix.result == 'success'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    uses: ./.github/workflows/base-build.yml
    with:
      config: ${{ matrix.config }}
      ssh: ${{ github.event.inputs.ssh || 'false' }}
    secrets: inherit

  build-final:
    needs: [generate-matrix, build-base]
    if: always() && needs.generate-matrix.result == 'success' && needs.build-base.result == 'success'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    uses: ./.github/workflows/final-build.yml
    with:
      config: ${{ matrix.config }}
      ssh: ${{ github.event.inputs.ssh || 'false' }}
      base-cache-key: ${{ needs.build-base.outputs[matrix.branch].cache-key }}
    secrets: inherit

  release:
    needs: [generate-matrix, build-final]
    runs-on: ubuntu-latest
    if: always() && needs.build-final.result == 'success'
    steps:
      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          pattern: "*-${{ github.run_id }}-*"
          merge-multiple: true
          path: artifacts

      - name: ğŸ“¦ æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release
          # å¤åˆ¶æ‰€æœ‰å›ºä»¶æ–‡ä»¶
          find artifacts -name "*.bin" -type f -exec cp {} release/ \;
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          find artifacts -name "*.config" -type f -exec cp {} release/ \;
          find artifacts -name "*.manifest" -type f -exec cp {} release/ \;
          find artifacts -name "config.buildinfo" -type f -exec cp {} release/ \;
          # åˆå¹¶æ‰€æœ‰è½¯ä»¶åŒ…
          mkdir -p packages
          find artifacts -name "*.ipk" -type f -exec cp {} packages/ \;
          tar -czf release/packages.tar.gz -C packages .
          # å¤åˆ¶æŠ¥å‘Šæ–‡ä»¶
          find artifacts -name "*.md" -type f -exec cp {} release/ \;
          # ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨
          ls -la release/ > release/filelist.txt

      - name: ğŸš€ å‘å¸ƒåˆ°Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: OpenWrt Build ${{ github.run_number }}
          body: |
            ## ğŸ“… ç¼–è¯‘ä¿¡æ¯
            - **ç¼–è¯‘æ—¶é—´**: ${{ needs.generate-matrix.outputs.build-time }}
            - **ç¼–è¯‘ä»»åŠ¡**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ## ğŸ“¦ äº§ç‰©è¯´æ˜
            - `*.bin`: å›ºä»¶æ–‡ä»¶
            - `*.config`: ç¼–è¯‘é…ç½®
            - `*.manifest`: è½¯ä»¶åŒ…æ¸…å•
            - `config.buildinfo`: æ„å»ºä¿¡æ¯
            - `packages.tar.gz`: æ‰€æœ‰è½¯ä»¶åŒ…
            - `*.md`: è¯¦ç»†æŠ¥å‘Š
            
            ## ğŸ”— å¿«é€Ÿè®¿é—®
            - [æŸ¥çœ‹æ„å»ºæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [ä¸‹è½½æ‰€æœ‰äº§ç‰©](${{ github.server_url }}/${{ github.repository }}/releases/download/build-${{ github.run_number }}/)
          files: release/*
          draft: false
          prerelease: false
