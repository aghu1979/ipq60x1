name: OpenWrt Build Scheduler

on:
  schedule:
    - cron: '0 16 * * 4'  # åŒ—äº¬æ—¶é—´å‘¨äº”0ç‚¹ (UTC+8)
  workflow_dispatch:  # ä»…ä¿ç•™æ‰‹åŠ¨è§¦å‘

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      build-time: ${{ steps.time.outputs.time }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ ç”Ÿæˆç¼–è¯‘çŸ©é˜µ
        id: set-matrix
        run: |
          # æ£€æŸ¥å¯ç”¨çš„é…ç½®æ–‡ä»¶
          echo "ğŸ“‹ æ£€æŸ¥é…ç½®æ–‡ä»¶..."
          ls -la configs/
          
          # ç”ŸæˆçŸ©é˜µ
          matrix=$(jq -n -c \
            --argjson chips '["ipq60xx"]' \
            --argjson branches '["openwrt", "immwrt", "libwrt"]' \
            --argjson configs '["Pro", "Max", "Ultra"]' \
            '{
              include: [
                $chips[] as $chip | $branches[] as $branch | $configs[] as $config | {chip, branch, config}
              ]
            }')
          
          echo "matrix=$matrix" >> $GITHUB_OUTPUT
          echo "Generated matrix: $matrix"

      - name: â° è®°å½•ç¼–è¯‘æ—¶é—´
        id: time
        run: |
          echo "time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

  # Job 1: ç¼–è¯‘åŸºç¡€ç³»ç»Ÿ - ä¸ºæ¯ä¸ªåˆ†æ”¯å•ç‹¬ç¼–è¯‘
  build-base:
    needs: generate-matrix
    strategy:
      fail-fast: false
      matrix:
        branch: [openwrt, immwrt, libwrt]
    uses: ./.github/workflows/base-build.yml
    with:
      chip: ipq60xx
      branch: ${{ matrix.branch }}
    secrets: inherit

  # Job 2: åˆå¹¶æ‰€æœ‰ç¼“å­˜ä¿¡æ¯
  merge-cache-info:
    needs: [generate-matrix, build-base]
    runs-on: ubuntu-latest
    outputs:
      cache-map: ${{ steps.merge.outputs.cache-map }}
    steps:
      - name: ğŸ”— åˆå¹¶ç¼“å­˜ä¿¡æ¯
        id: merge
        run: |
          # åˆ›å»ºä¸€ä¸ªç©ºçš„JSONå¯¹è±¡
          CACHE_MAP='{}'
          
          # åˆå¹¶æ¯ä¸ªåˆ†æ”¯çš„ç¼“å­˜ä¿¡æ¯
          # openwrtåˆ†æ”¯
          if [ -n "${{ needs.build-base.outputs['openwrt'].cache-info }}" ]; then
            CACHE_MAP=$(echo "$CACHE_MAP" | jq -c -s '.[0] * .[1]' - <<< "${{ needs.build-base.outputs['openwrt'].cache-info }}")
          fi
          
          # immwrtåˆ†æ”¯
          if [ -n "${{ needs.build-base.outputs['immwrt'].cache-info }}" ]; then
            CACHE_MAP=$(echo "$CACHE_MAP" | jq -c -s '.[0] * .[1]' - <<< "${{ needs.build-base.outputs['immwrt'].cache-info }}")
          fi
          
          # libwrtåˆ†æ”¯
          if [ -n "${{ needs.build-base.outputs['libwrt'].cache-info }}" ]; then
            CACHE_MAP=$(echo "$CACHE_MAP" | jq -c -s '.[0] * .[1]' - <<< "${{ needs.build-base.outputs['libwrt'].cache-info }}")
          fi
          
          echo "cache-map=$CACHE_MAP" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ åˆå¹¶åçš„ç¼“å­˜æ˜ å°„: $CACHE_MAP"

  # Job 3: å¹¶è¡Œç¼–è¯‘æœ€ç»ˆå›ºä»¶
  build-final:
    needs: [generate-matrix, merge-cache-info]
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    uses: ./.github/workflows/final-build.yml
    with:
      chip: ${{ matrix.chip }}
      branch: ${{ matrix.branch }}
      config: ${{ matrix.config }}
      base-cache-key: ${{ fromJson(needs.merge-cache-info.outputs.cache-map)[matrix.branch]['cache-key'] }}
    secrets: inherit

  release:
    needs: [generate-matrix, build-final]
    runs-on: ubuntu-latest
    if: always() && needs.build-final.result == 'success'
    steps:
      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          pattern: "*-${{ github.run_id }}-*"
          merge-multiple: true
          path: artifacts

      - name: ğŸ“¦ æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release
          # å¤åˆ¶æ‰€æœ‰å›ºä»¶æ–‡ä»¶
          find artifacts -name "*.bin" -type f -exec cp {} release/ \;
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          find artifacts -name "*.config" -type f -exec cp {} release/ \;
          find artifacts -name "*.manifest" -type f -exec cp {} release/ \;
          find artifacts -name "config.buildinfo" -type f -exec cp {} release/ \;
          # åˆå¹¶æ‰€æœ‰è½¯ä»¶åŒ…
          mkdir -p packages
          find artifacts -name "*.ipk" -type f -exec cp {} packages/ \;
          tar -czf release/packages.tar.gz -C packages .
          # å¤åˆ¶æŠ¥å‘Šæ–‡ä»¶
          find artifacts -name "*.md" -type f -exec cp {} release/ \;
          # ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨
          ls -la release/ > release/filelist.txt

      - name: ğŸš€ å‘å¸ƒåˆ°Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: OpenWrt Build ${{ github.run_number }}
          body: |
            ## ğŸ“… ç¼–è¯‘ä¿¡æ¯
            - **ç¼–è¯‘æ—¶é—´**: ${{ needs.generate-matrix.outputs.build-time }}
            - **ç¼–è¯‘ä»»åŠ¡**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ## ğŸ“¦ äº§ç‰©è¯´æ˜
            - `*.bin`: å›ºä»¶æ–‡ä»¶
            - `*.config`: ç¼–è¯‘é…ç½®
            - `*.manifest`: è½¯ä»¶åŒ…æ¸…å•
            - `config.buildinfo`: æ„å»ºä¿¡æ¯
            - `packages.tar.gz`: æ‰€æœ‰è½¯ä»¶åŒ…
            - `*.md`: è¯¦ç»†æŠ¥å‘Š
            
            ## ğŸ”— å¿«é€Ÿè®¿é—®
            - [æŸ¥çœ‹æ„å»ºæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [ä¸‹è½½æ‰€æœ‰äº§ç‰©](${{ github.server_url }}/${{ github.repository }}/releases/download/build-${{ github.run_number }}/)
          files: release/*
          draft: false
          prerelease: false
