name: ðŸ­ å¯å¤ç”¨æž„å»ºå·¥åŽ‚

on:
  workflow_call:
    inputs:
      os_version:
        required: true
        type: string
      chipset:
        required: true
        type: string
      branch:
        required: true
        type: string
      profile:
        required: true
        type: string
      hashes-value:
        required: true
        type: string
      devices:
        required: true
        type: string

# å…¨å±€çŽ¯å¢ƒå˜é‡
env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  DIY_P1_SH: scripts/diy.sh
  DIY_P2_SH: scripts/repo.sh
  UPLOAD_FIRMWARE_DIR: firmware
  UPLOAD_CONFIG_DIR: config
  UPLOAD_PACKAGES_DIR: packages
  UPLOAD_LOGS_DIR: logs
  CONFIG_FILE: .config
  COLOR_ERROR: '\033[1;31m'
  COLOR_WARN: '\033[1;33m'
  COLOR_INFO: '\033[1;36m'
  COLOR_SUCCESS: '\033[1;32m'
  COLOR_RESET: '\033[0m'
  ICON_ERROR: 'âŒ'
  ICON_WARN: 'âš ï¸'
  ICON_INFO: 'â„¹ï¸'
  ICON_SUCCESS: 'âœ…'

jobs:
  build:
    name: ðŸ› ï¸ ç¼–è¯‘ ${{ inputs.profile }}
    runs-on: ${{ inputs.os_version }}
    permissions:
      contents: read
    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ’¾ æ˜¾ç¤ºç¼–è¯‘å‰ç£ç›˜ç©ºé—´
        run: |
          COLOR_INFO_VAR="${{ env.COLOR_INFO }}"
          ICON_INFO_VAR="${{ env.ICON_INFO }}"
          COLOR_RESET_VAR="${{ env.COLOR_RESET }}"
          echo -e "${COLOR_INFO_VAR}${ICON_INFO_VAR} ç¼–è¯‘å‰ç£ç›˜ç©ºé—´: ${COLOR_RESET_VAR}"
          df -hT

      - name: ðŸ§¹ æ¸…ç†ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: ðŸ’¾ æ˜¾ç¤ºæ¸…ç†åŽç£ç›˜ç©ºé—´
        run: |
          COLOR_INFO_VAR="${{ env.COLOR_INFO }}"
          ICON_INFO_VAR="${{ env.ICON_INFO }}"
          COLOR_RESET_VAR="${{ env.COLOR_RESET }}"
          echo -e "${COLOR_INFO_VAR}${ICON_INFO_VAR} æ¸…ç†åŽç£ç›˜ç©ºé—´: ${COLOR_RESET_VAR}"
          df -hT

      - name: ðŸ“¦ æ¢å¤/åˆ›å»ºç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ./dl
            ./ccache
            ./toolchain
            ./build_dir
            ./staging_dir
            ./tmp
          key: ${{ inputs.chipset }}-${{ inputs.branch }}-${{ inputs.hashes-value }}
          restore-keys: |
            ${{ inputs.chipset }}-${{ inputs.branch }}-

      - name: ðŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          COLOR_SUCCESS_VAR="${{ env.COLOR_SUCCESS }}"
          ICON_SUCCESS_VAR="${{ env.ICON_SUCCESS }}"
          COLOR_RESET_VAR="${{ env.COLOR_RESET }}"
          sudo rm -rf /etc/apt/sources.list.d/*
          sudo apt-get update
          sudo apt-get install -y $(curl -fsSL git.io/depends-ubuntu-2204)
          echo -e "${COLOR_SUCCESS_VAR}${ICON_SUCCESS_VAR} ä¾èµ–å®‰è£…å®Œæˆ${COLOR_RESET_VAR}"

      - name: ðŸŒ± å‡†å¤‡åŸºç¡€çŽ¯å¢ƒ
        run: |
          # å°†æ‰€æœ‰ env å’Œ inputs å˜é‡èµ‹å€¼ç»™ shell å˜é‡
          REPO_URL_VAR="${{ env.REPO_URL }}"
          DIY_P2_SH_VAR="${{ env.DIY_P2_SH }}"
          COLOR_INFO_VAR="${{ env.COLOR_INFO }}"
          ICON_INFO_VAR="${{ env.ICON_INFO }}"
          COLOR_SUCCESS_VAR="${{ env.COLOR_SUCCESS }}"
          ICON_SUCCESS_VAR="${{ env.ICON_SUCCESS }}"
          COLOR_RESET_VAR="${{ env.COLOR_RESET }}"
          CHIPSET_VAR="${{ inputs.chipset }}"
          BRANCH_VAR="${{ inputs.branch }}"
          
          set -euo pipefail
          if [ ! -d "toolchain" ]; then
            echo -e "${COLOR_INFO_VAR}${ICON_INFO_VAR} ç¼“å­˜æœªå‘½ä¸­ï¼Œå¼€å§‹å‡†å¤‡åŸºç¡€ç¼–è¯‘çŽ¯å¢ƒ...${COLOR_RESET_VAR}"
            git clone $REPO_URL_VAR immortalwrt
            cd immortalwrt
            cat ../configs/base_${CHIPSET_VAR}.config > .config
            cat ../configs/base_${BRANCH_VAR}.config >> .config
            chmod +x ../${DIY_P2_SH_VAR}
            ../${DIY_P2_SH_VAR}
            ./scripts/feeds update -a
            ./scripts/feeds install -a
            make defconfig
            make toolchain/install -j$(nproc) || make toolchain/install -j1
            echo -e "${COLOR_SUCCESS_VAR}${ICON_SUCCESS_VAR} åŸºç¡€çŽ¯å¢ƒå‡†å¤‡å®Œæˆï¼Œå·²ç¼“å­˜ã€‚${COLOR_RESET_VAR}"
          else
            echo -e "${COLOR_SUCCESS_VAR}${ICON_SUCCESS_VAR} ç¼“å­˜å‘½ä¸­ï¼Œè·³è¿‡åŸºç¡€çŽ¯å¢ƒå‡†å¤‡ã€‚${COLOR_RESET_VAR}"
            git clone $REPO_URL_VAR immortalwrt
          fi

      - name: ðŸ—ï¸ ç¼–è¯‘å›ºä»¶ (${{ inputs.profile }})
        id: compile
        run: |
          # å°†æ‰€æœ‰ env å’Œ inputs å˜é‡èµ‹å€¼ç»™ shell å˜é‡
          UPLOAD_LOGS_DIR_VAR="${{ env.UPLOAD_LOGS_DIR }}"
          DIY_P1_SH_VAR="${{ env.DIY_P1_SH }}"
          COLOR_INFO_VAR="${{ env.COLOR_INFO }}"
          ICON_INFO_VAR="${{ env.ICON_INFO }}"
          COLOR_SUCCESS_VAR="${{ env.COLOR_SUCCESS }}"
          ICON_SUCCESS_VAR="${{ env.ICON_SUCCESS }}"
          COLOR_RESET_VAR="${{ env.COLOR_RESET }}"
          PROFILE_VAR="${{ inputs.profile }}"
          
          set -euo pipefail
          LOG_FILE="build_${PROFILE_VAR}.log"
          cd immortalwrt
          
          echo -e "${COLOR_INFO_VAR}${ICON_INFO_VAR} ---------- å¼€å§‹ç¼–è¯‘é…ç½®: ${PROFILE_VAR} ----------${COLOR_RESET_VAR}" | tee "../${UPLOAD_LOGS_DIR_VAR}/$LOG_FILE"
          
          echo -e "${COLOR_INFO_VAR}${ICON_INFO_VAR} æ­¥éª¤ 1: åˆå¹¶é…ç½®æ–‡ä»¶...${COLOR_RESET_VAR}" | tee -a "../${UPLOAD_LOGS_DIR_VAR}/$LOG_FILE"
          cat ../configs/${PROFILE_VAR}.config >> .config
          
          echo -e "${COLOR_INFO_VAR}${ICON_INFO_VAR} æ­¥éª¤ 2: æ£€æŸ¥ LuCI è½¯ä»¶åŒ…ä¾èµ–...${COLOR_RESET_VAR}" | tee -a "../${UPLOAD_LOGS_DIR_VAR}/$LOG_FILE"
          chmod +x ../scripts/check_luci.sh
          ../scripts/check_luci.sh .config | tee -a "../${UPLOAD_LOGS_DIR_VAR}/$LOG_FILE"
          
          echo -e "${COLOR_INFO_VAR}${ICON_INFO_VAR} æ­¥éª¤ 3: å¼€å§‹ç¼–è¯‘å›ºä»¶...${COLOR_RESET_VAR}" | tee -a "../${UPLOAD_LOGS_DIR_VAR}/$LOG_FILE"
          make -j$(nproc) | tee -a "../${UPLOAD_LOGS_DIR_VAR}/$LOG_FILE"
          
          echo -e "${COLOR_INFO_VAR}${ICON_INFO_VAR} æ­¥éª¤ 4: æ‰§è¡Œ DIY è„šæœ¬...${COLOR_RESET_VAR}" | tee -a "../${UPLOAD_LOGS_DIR_VAR}/$LOG_FILE"
          chmod +x ../${DIY_P1_SH_VAR}
          ../${DIY_P1_SH_VAR}
          
          echo -e "${COLOR_SUCCESS_VAR}${ICON_SUCCESS_VAR} ---------- é…ç½® ${PROFILE_VAR} ç¼–è¯‘å®Œæˆ ----------${COLOR_RESET_VAR}" | tee -a "../${UPLOAD_LOGS_DIR_VAR}/$LOG_FILE"

      - name: ðŸ“¦ æ”¶é›†å¹¶é‡å‘½åäº§ç‰©
        if: steps.compile.outcome == 'success'
        run: |
          # å°†æ‰€æœ‰ env å’Œ inputs å˜é‡èµ‹å€¼ç»™ shell å˜é‡
          UPLOAD_FIRMWARE_DIR_VAR="${{ env.UPLOAD_FIRMWARE_DIR }}"
          UPLOAD_CONFIG_DIR_VAR="${{ env.UPLOAD_CONFIG_DIR }}"
          UPLOAD_PACKAGES_DIR_VAR="${{ env.UPLOAD_PACKAGES_DIR }}"
          COLOR_INFO_VAR="${{ env.COLOR_INFO }}"
          ICON_INFO_VAR="${{ env.ICON_INFO }}"
          COLOR_RESET_VAR="${{ env.COLOR_RESET }}"
          CHIPSET_VAR="${{ inputs.chipset }}"
          BRANCH_VAR="${{ inputs.branch }}"
          PROFILE_VAR="${{ inputs.profile }}"
          DEVICES_VAR="${{ inputs.devices }}"

          set -euo pipefail
          cd immortalwrt
          mkdir -p "../${UPLOAD_FIRMWARE_DIR_VAR}"
          mkdir -p "../${UPLOAD_CONFIG_DIR_VAR}"
          mkdir -p "../${UPLOAD_PACKAGES_DIR_VAR}"
          
          for DEVICE in $DEVICES_VAR; do
            find bin/targets/*/* -type f \( -name "*${DEVICE}*-squashfs-sysupgrade.bin" -o -name "*${DEVICE}*-squashfs-factory.bin" \) | while read -r f; do
              if [[ "$f" =~ .*-squashfs-(sysupgrade|factory)\.bin$ ]]; then
                TYPE="${BASH_REMATCH[1]}"
                NEW_NAME="${BRANCH_VAR}-${DEVICE}-${TYPE}-${PROFILE_VAR}.bin"
                cp "$f" "../${UPLOAD_FIRMWARE_DIR_VAR}/$NEW_NAME"
                echo -e "${COLOR_INFO_VAR}${ICON_INFO_VAR} å›ºä»¶å·²é‡å‘½å: $NEW_NAME${COLOR_RESET_VAR}"
              fi
            done
            cp .config "../${UPLOAD_CONFIG_DIR_VAR}/${BRANCH_VAR}-${CHIPSET_VAR}-${DEVICE}-${PROFILE_VAR}.config"
            cp bin/targets/*/*/${DEVICE}.manifest "../${UPLOAD_CONFIG_DIR_VAR}/${BRANCH_VAR}-${CHIPSET_VAR}-${DEVICE}-${PROFILE_VAR}.manifest"
            cp .config.buildinfo "../${UPLOAD_CONFIG_DIR_VAR}/${BRANCH_VAR}-${CHIPSET_VAR}-${DEVICE}-${PROFILE_VAR}.config.buildinfo"
          done
          
          cp bin/packages/**/*.ipk ../${UPLOAD_PACKAGES_DIR_VAR}/ 2>/dev/null || true

      - name: ðŸ“¤ ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build_artifacts_${{ inputs.profile }}
          path: |
            ${{ env.UPLOAD_FIRMWARE_DIR }}
            ${{ env.UPLOAD_CONFIG_DIR }}
            ${{ env.UPLOAD_PACKAGES_DIR }}
            ${{ env.UPLOAD_LOGS_DIR }}
          retention-days: 7
