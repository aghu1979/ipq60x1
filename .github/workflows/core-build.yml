name: OpenWrt Core Build

on:
  workflow_call:
    inputs:
      chip:
        required: true
        type: string
      branch:
        required: true
        type: string
      config:
        required: true
        type: string
    secrets:
      GH_TOKEN:
        required: false

jobs:
  prepare-base:
    runs-on: ubuntu-22.04
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
      build-path: ${{ steps.cache-key.outputs.path }}
    steps:
      - name: ğŸ› ï¸ åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”‘ ç”Ÿæˆç¼“å­˜é”®
        id: cache-key
        run: |
          # ç”ŸæˆåŸºäºé…ç½®çš„ç¼“å­˜é”®
          CHIP_HASH=$(sha256sum .github/configs/base_${{ inputs.chip }}.config | cut -d' ' -f1)
          BRANCH_HASH=$(sha256sum .github/configs/base_${{ inputs.branch }}.config | cut -d' ' -f1)
          CACHE_KEY="base-${{ inputs.chip }}-${{ inputs.branch }}-${CHIP_HASH:0:8}-${BRANCH_HASH:0:8}"
          BUILD_PATH="build-base-${{ inputs.chip }}-${{ inputs.branch }}"
          
          echo "key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "path=$BUILD_PATH" >> $GITHUB_OUTPUT
          echo "Generated cache key: $CACHE_KEY"

      - name: ğŸ“¦ æ¢å¤åŸºç¡€ç¯å¢ƒç¼“å­˜
        id: cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.cache-key.outputs.path }}
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            base-${{ inputs.chip }}-${{ inputs.branch }}-

      - name: ğŸŒ± å‡†å¤‡åŸºç¡€ç¯å¢ƒ
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ”§ å‡†å¤‡åŸºç¡€ç¼–è¯‘ç¯å¢ƒ..."
          mkdir -p ${{ steps.cache-key.outputs.path }}
          
          # è®¾ç½®æºç ä»“åº“URL
          case "${{ inputs.branch }}" in
            "openwrt")
              REPO_URL="https://github.com/openwrt/openwrt"
              ;;
            "immwrt")
              REPO_URL="https://github.com/immortalwrt/immortalwrt"
              ;;
            "libwrt")
              REPO_URL="https://github.com/LibreWrt/LibreWrt"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„åˆ†æ”¯: ${{ inputs.branch }}"
              exit 1
              ;;
          esac
          
          # å…‹éš†æºç 
          git clone --depth=1 $REPO_URL openwrt-src
          cd openwrt-src
          
          # åº”ç”¨åŸºç¡€é…ç½®
          cp "../.github/configs/base_${{ inputs.chip }}.config" .config
          cat "../.github/configs/base_${{ inputs.branch }}.config" >> .config
          
          # æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
          cp ../scripts/diy.sh ./
          cp ../scripts/repo.sh ./
          chmod +x diy.sh repo.sh
          ./diy.sh
          ./repo.sh
          
          # æ›´æ–°feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
          make defconfig
          make -j$(nproc) IGNORE_ERRORS=1 download
          make -j$(nproc) IGNORE_ERRORS=1 tools/compile
          make -j$(nproc) IGNORE_ERRORS=1 toolchain/compile
          
          # æ‰“åŒ…åŸºç¡€ç¯å¢ƒ
          cd ..
          tar -czf ${{ steps.cache-key.outputs.path }}/base.tar.gz -C openwrt-src .
          echo "âœ… åŸºç¡€ç¯å¢ƒå‡†å¤‡å®Œæˆ"

  build-firmware:
    needs: prepare-base
    runs-on: ubuntu-22.04
    outputs:
      build-status: ${{ steps.build.outputs.status }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ æ¢å¤åŸºç¡€ç¯å¢ƒ
        run: |
          mkdir -p openwrt-build
          tar -xzf ${{ needs.prepare-base.outputs.build-path }}/base.tar.gz -C openwrt-build
          echo "âœ… åŸºç¡€ç¯å¢ƒæ¢å¤å®Œæˆ"

      - name: ğŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶
        run: |
          echo "ğŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶..."
          cd openwrt-build
          
          # å¤‡ä»½åŸå§‹é…ç½®
          cp .config .config.base
          
          # åˆå¹¶ç”¨æˆ·é…ç½®
          if [ -f "../.github/configs/${{ inputs.config }}.config" ]; then
            while IFS= read -r line; do
              if [[ $line =~ ^CONFIG_ ]]; then
                key=$(echo "$line" | cut -d'=' -f1)
                if grep -q "^$key=" .config; then
                  sed -i "s|^$key=.*|$line|" .config
                else
                  echo "$line" >> .config
                fi
              fi
            done < "../.github/configs/${{ inputs.config }}.config"
          fi
          
          # ç”Ÿæˆæœ€ç»ˆé…ç½®
          make defconfig
          
          echo "âœ… é…ç½®åˆå¹¶å®Œæˆ"
          echo "ğŸ“Š é…ç½®ç»Ÿè®¡:"
          echo "  - åŸºç¡€é…ç½®é¡¹: $(grep -c '^CONFIG_' .config.base)"
          echo "  - ç”¨æˆ·é…ç½®é¡¹: $(grep -c '^CONFIG_' "../.github/configs/${{ inputs.config }}.config" 2>/dev/null || echo 0)"
          echo "  - æœ€ç»ˆé…ç½®é¡¹: $(grep -c '^CONFIG_' .config)"

      - name: ğŸ” æ£€æŸ¥LUCIè½¯ä»¶åŒ…
        run: |
          echo "ğŸ” æ£€æŸ¥LUCIè½¯ä»¶åŒ…..."
          cd openwrt-build
          
          # æå–æ‰€æœ‰LUCIè½¯ä»¶åŒ…
          LUCI_PACKAGES=$(grep "^CONFIG_PACKAGE_luci-" .config | sed 's/^CONFIG_PACKAGE_\(.*\)=y/\1/' | sort)
          echo "ğŸ“¦ éœ€è¦çš„LUCIè½¯ä»¶åŒ…:"
          echo "$LUCI_PACKAGES"
          
          # æ£€æŸ¥è½¯ä»¶åŒ…å¯ç”¨æ€§
          MISSING_PACKAGES=""
          for pkg in $LUCI_PACKAGES; do
            if [ -d "package/feeds/packages/$pkg" ] || [ -d "package/feeds/luci/$pkg" ] || [ -d "package/$pkg" ]; then
              echo "âœ… $pkg - å¯ç”¨"
            else
              echo "âŒ $pkg - ç¼ºå¤±"
              MISSING_PACKAGES="$MISSING_PACKAGES $pkg"
            fi
          done
          
          if [ -n "$MISSING_PACKAGES" ]; then
            echo ""
            echo "ğŸš¨ å‘ç°ç¼ºå¤±çš„LUCIè½¯ä»¶åŒ…: $MISSING_PACKAGES"
            echo "ğŸ’¡ ä¿®å¤å»ºè®®:"
            echo "1. æ£€æŸ¥è½¯ä»¶åŒ…åç§°æ˜¯å¦æ­£ç¡®"
            echo "2. æ›´æ–°ç¬¬ä¸‰æ–¹è½¯ä»¶æº"
            echo "3. ç¡®è®¤è½¯ä»¶åŒ…åœ¨å½“å‰åˆ†æ”¯ä¸­å¯ç”¨"
            exit 1
          else
            echo ""
            echo "âœ… æ‰€æœ‰LUCIè½¯ä»¶åŒ…æ£€æŸ¥é€šè¿‡ï¼"
          fi

      - name: ğŸš€ ç¼–è¯‘å›ºä»¶
        id: build
        run: |
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          cd openwrt-build
          
          # è®¾ç½®ç¼–è¯‘å‚æ•°
          make -j$(nproc) || {
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            make -j1 V=s
          }
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          if [ -d "bin/targets" ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸ"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ğŸ“¦ æ”¶é›†ç¼–è¯‘äº§ç‰©
        run: |
          echo "ğŸ“¦ æ”¶é›†ç¼–è¯‘äº§ç‰©..."
          mkdir -p artifacts
          
          # å¤åˆ¶å›ºä»¶æ–‡ä»¶
          find openwrt-build/bin/targets -name "*.bin" -type f -exec cp {} artifacts/ \;
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp openwrt-build/.config artifacts/config-${{ inputs.chip }}-${{ inputs.branch }}-${{ inputs.config }}.config
          find openwrt-build/bin/targets -name "*.manifest" -type f -exec cp {} artifacts/ \;
          find openwrt-build/bin/targets -name "config.buildinfo" -type f -exec cp {} artifacts/ \;
          
          # å¤åˆ¶è½¯ä»¶åŒ…
          mkdir -p artifacts/packages
          find openwrt-build/bin/packages -name "*.ipk" -type f -exec cp {} artifacts/packages/ \;
          
          # ç”Ÿæˆæ–‡ä»¶æ¸…å•
          ls -la artifacts/ > artifacts/filelist.txt
          echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆ"

      - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.chip }}-${{ inputs.branch }}-${{ inputs.config }}-${{ github.run_id }}
          path: artifacts/
          retention-days: 7
          if-no-files-found: error
