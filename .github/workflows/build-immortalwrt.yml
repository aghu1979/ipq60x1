name: IPQ60xx-ImmortalWrt-MultiBuild

on:
  workflow_dispatch:
  workflow_call:
  # schedule:
  #   - cron: 0 20 * * *

env:
  REPO_URL: https://github.com/laipeng668/immortalwrt.git
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  DIY_P1_SH: scripts/diy.sh
  DIY_P2_SH: scripts/repo.sh
  UPLOAD_BIN_DIR: false
  FIRMWARE_RELEASE: true
  TZ: Asia/Shanghai
  # å®šä¹‰ä¸‰ä¸ªå˜ä½“
  VARIANTS: "Ultra Max Pro"
  # åŸºç¡€é…ç½®æ–‡ä»¶
  BASE_CONFIG: configs/base_ipq60xx.config
  IMMWRT_CONFIG: configs/base_immwrt.config

jobs:
  Setup:
    runs-on: ubuntu-22.04
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      build-date: ${{ steps.build-date.outputs.date }}
      file-date: ${{ steps.build-date.outputs.file-date }}
      version-info: ${{ steps.version-info.outputs.info }}
      version-kernel: ${{ steps.version-info.outputs.kernel }}
      source-repo: ${{ steps.vars.outputs.source-repo }}
      device-target: ${{ steps.vars.outputs.device-target }}
      device-subtarget: ${{ steps.vars.outputs.device-subtarget }}
      hash: ${{ steps.vars.outputs.hash }}

    steps:
    - name: æ£€æŸ¥æœåŠ¡å™¨æ€§èƒ½
      run: |
        echo "è­¦å‘Šâš "
        echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
        echo -e "å·²çŸ¥CPUåž‹å·ï¼ˆé™åºï¼‰ï¼š7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673 \n"
        echo "--------------------------CPUä¿¡æ¯--------------------------"
        echo "CPUç‰©ç†æ•°é‡ï¼š$(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo -e "CPUæ ¸å¿ƒä¿¡æ¯ï¼š$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
        echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
        echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯ï¼š"
        echo -e "$(sudo lshw -short -C memory | grep GiB) \n"
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        echo "ç¡¬ç›˜æ•°é‡ï¼š$(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

    - name: åˆå§‹åŒ–çŽ¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -y update
        sudo -E apt-get -y install $(curl -fsSL is.gd/depends_ubuntu_2204)
        sudo -E systemctl daemon-reload
        sudo timedatectl set-timezone "$TZ"

    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: å…‹éš†æºä»£ç 
      run: |
        df -hT $GITHUB_WORKSPACE
        sudo mkdir -p /mnt/openwrt
        sudo chown -R $(id -u):$(id -g) /mnt/openwrt
        git clone --depth 1 -b $REPO_BRANCH --single-branch $REPO_URL /mnt/openwrt
        cd /mnt/openwrt
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
        VERSION_INFO=$(git show -s --date=short --format="ä½œè€…: %an<br/>æ—¶é—´: %cd<br/>å†…å®¹: %s<br/>hash: %H")
        echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV
        VERSION_KERNEL=$(grep -oP 'LINUX_KERNEL_HASH-\K[0-9]+\.[0-9]+\.[0-9]+' target/linux/generic/kernel-6.12)
        echo "VERSION_KERNEL=$VERSION_KERNEL" >> $GITHUB_ENV

    - name: ç”Ÿæˆå˜é‡
      id: vars
      run: |
        # ä½¿ç”¨Ultraé…ç½®ç”ŸæˆåŸºç¡€å˜é‡
        cp $BASE_CONFIG $IMMWRT_CONFIG configs/Ultra.config /tmp/merged.config
        cd $OPENWRT_PATH
        cp /tmp/merged.config .config
        make defconfig > /dev/null 2>&1
        SOURCE_REPO="$(echo $REPO_URL | awk -F '/' '{print $(NF)}')"
        echo "source-repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
        DEVICE_TARGET=$(cat .config | grep CONFIG_TARGET_BOARD | awk -F '"' '{print $2}')
        echo "device-target=$DEVICE_TARGET" >> $GITHUB_OUTPUT
        DEVICE_SUBTARGET=$(cat .config | grep CONFIG_TARGET_SUBTARGET | awk -F '"' '{print $2}')
        echo "device-subtarget=$DEVICE_SUBTARGET" >> $GITHUB_OUTPUT
        echo "hash=$(git log -1 --pretty=format:'%h')" >> $GITHUB_OUTPUT

    - name: è®¾ç½®æž„å»ºæ—¥æœŸ
      id: build-date
      run: |
        echo "date=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_OUTPUT
        echo "file-date=$(date +"%Y.%m.%d")" >> $GITHUB_OUTPUT

    - name: è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯
      id: version-info
      run: |
        echo "info=$VERSION_INFO" >> $GITHUB_OUTPUT
        echo "kernel=$VERSION_KERNEL" >> $GITHUB_OUTPUT

    - name: ç”Ÿæˆç¼“å­˜é”®
      id: cache-key
      run: |
        echo "key=${{ steps.vars.outputs.source-repo }}-${{ env.REPO_BRANCH }}-${{ steps.vars.outputs.device-target }}-${{ steps.vars.outputs.device-subtarget }}-${{ steps.vars.outputs.hash }}-${{ steps.build-date.outputs.date }}" >> $GITHUB_OUTPUT

    - name: ç¼“å­˜å·¥å…·é“¾
      uses: actions/cache@main
      with:
        key: ${{ steps.cache-key.outputs.key }}
        restore-keys: ${{ steps.vars.outputs.source-repo }}-${{ env.REPO_BRANCH }}-${{ steps.vars.outputs.device-target }}-${{ steps.vars.outputs.device-subtarget }}-
        path: |
          ${{ env.OPENWRT_PATH }}/.ccache
          ${{ env.OPENWRT_PATH }}/staging_dir
          ${{ env.OPENWRT_PATH }}/dl

    - name: åˆ·æ–°ç¼“å­˜
      run: |
        if [ -d "$OPENWRT_PATH/staging_dir" ]; then
          find "$OPENWRT_PATH/staging_dir" -type d -name "stamp" -not -path "*target*" | while read -r dir; do
              find "$dir" -type f -exec touch {} +
          done
        fi

  Build:
    needs: Setup
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        variant: [Ultra, Max, Pro]
      fail-fast: false
    
    steps:
    - name: åˆå§‹åŒ–æ—¥å¿—
      run: |
        source scripts/logger.sh
        init_log
        log_system_status

    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: æ£€æŸ¥ç¼“å­˜
      run: |
        source scripts/utils.sh
        if is_cache_valid "$OPENWRT_PATH/dl" 3; then
          echo "CACHE_VALID=true" >> $GITHUB_ENV
          log_info "DLç¼“å­˜æœ‰æ•ˆï¼Œå°†ä½¿ç”¨ç¼“å­˜"
        else
          echo "CACHE_VALID=false" >> $GITHUB_ENV
          log_info "DLç¼“å­˜æ— æ•ˆï¼Œå°†é‡æ–°ä¸‹è½½"
        fi

    - name: å‡†å¤‡æž„å»ºçŽ¯å¢ƒ
      run: |
        # åˆ›å»ºæž„å»ºç›®å½•
        BUILD_DIR="/mnt/openwrt-${{ matrix.variant }}"
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $(id -u):$(id -g) $BUILD_DIR
        
        # å¤åˆ¶æºä»£ç 
        if [ "$CACHE_VALID" == "true" ]; then
          # ä½¿ç”¨ç¡¬é“¾æŽ¥å¤åˆ¶ä»¥èŠ‚çœç©ºé—´
          cp -al /mnt/openwrt/. $BUILD_DIR
          log_info "ä½¿ç”¨ç¡¬é“¾æŽ¥å¤åˆ¶æºä»£ç "
        else
          # å®Œå…¨å¤åˆ¶
          cp -r /mnt/openwrt/. $BUILD_DIR
          log_info "å®Œå…¨å¤åˆ¶æºä»£ç "
        fi
        
        echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
        echo "OPENWRT_PATH=$BUILD_DIR" >> $GITHUB_ENV

    - name: åˆå¹¶é…ç½®æ–‡ä»¶
      run: |
        source scripts/logger.sh
        source scripts/utils.sh
        
        # åˆå¹¶é…ç½®æ–‡ä»¶
        MERGED_CONFIG="/tmp/${{ matrix.variant }}.config"
        merge_configs "$BASE_CONFIG" "$IMMWRT_CONFIG" "configs/${{ matrix.variant }}.config" "$MERGED_CONFIG"
        
        # å¤åˆ¶åˆ°æž„å»ºç›®å½•
        cp "$MERGED_CONFIG" "$OPENWRT_PATH/.config"
        
        log_info "é…ç½®æ–‡ä»¶åˆå¹¶å®Œæˆ: ${{ matrix.variant }}"

    - name: æ¯”è¾ƒè½¯ä»¶åŒ…åˆ—è¡¨
      run: |
        source scripts/logger.sh
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        OUTPUT_DIR="$GITHUB_WORKSPACE/package-compare-${{ matrix.variant }}"
        mkdir -p "$OUTPUT_DIR"
        
        # æ¯”è¾ƒè½¯ä»¶åŒ…åˆ—è¡¨
        chmod +x scripts/compare_packages.sh
        scripts/compare_packages.sh "$OPENWRT_PATH/.config" "$OPENWRT_PATH" "${{ matrix.variant }}" "$OUTPUT_DIR"
        
        # ä¸Šä¼ æ¯”è¾ƒç»“æžœ
        echo "PACKAGE_COMPARE_DIR=$OUTPUT_DIR" >> $GITHUB_ENV

    - name: å®‰è£…Feeds
      run: |
        source scripts/logger.sh
        
        cd $OPENWRT_PATH
        
        # å¦‚æžœç¼“å­˜æ— æ•ˆï¼Œæ›´æ–°feeds
        if [ "$CACHE_VALID" != "true" ]; then
          log_command "./scripts/feeds update -a" "æ›´æ–°feeds"
          log_command "./scripts/feeds install -a" "å®‰è£…feeds"
        else
          log_info "ä½¿ç”¨ç¼“å­˜çš„feeds"
        fi

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
      run: |
        source scripts/logger.sh
        
        chmod +x $DIY_P1_SH
        chmod +x $DIY_P2_SH
        
        cd $OPENWRT_PATH
        $GITHUB_WORKSPACE/$DIY_P1_SH "$OPENWRT_PATH"
        $GITHUB_WORKSPACE/$DIY_P2_SH "$OPENWRT_PATH"

    - name: ä¸‹è½½DLè½¯ä»¶åŒ…
      run: |
        source scripts/logger.sh
        
        cd $OPENWRT_PATH
        log_command "make defconfig" "æ‰§è¡Œdefconfig"
        
        # å¦‚æžœç¼“å­˜æ— æ•ˆï¼Œä¸‹è½½è½¯ä»¶åŒ…
        if [ "$CACHE_VALID" != "true" ]; then
          log_command "make download -j$(nproc)" "ä¸‹è½½è½¯ä»¶åŒ…"
        else
          log_info "ä½¿ç”¨ç¼“å­˜çš„è½¯ä»¶åŒ…"
        fi

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        source scripts/logger.sh
        
        cd $OPENWRT_PATH
        echo -e "$(nproc) thread compile"
        
        # è®°å½•ç¼–è¯‘å¼€å§‹æ—¶é—´
        BUILD_START=$(date +%s)
        echo "BUILD_START=$BUILD_START" >> $GITHUB_ENV
        
        # ç¼–è¯‘å›ºä»¶
        if log_command "make -j$(nproc) || make -j1 || make -j1 V=s" "ç¼–è¯‘å›ºä»¶"; then
          echo "status=success" >> $GITHUB_OUTPUT
          log_info "ç¼–è¯‘æˆåŠŸ"
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          log_error "ç¼–è¯‘å¤±è´¥"
          exit 1
        fi
        
        # è®°å½•ç¼–è¯‘ç»“æŸæ—¶é—´
        BUILD_END=$(date +%s)
        BUILD_TIME=$((BUILD_END - BUILD_START))
        echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
        log_info "ç¼–è¯‘è€—æ—¶: $BUILD_TIME ç§’"

    - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
      if: (!cancelled())
      run: df -hT

    - name: æ•´ç†æ–‡ä»¶
      if: steps.compile.outputs.status == 'success'
      run: |
        source scripts/logger.sh
        
        cd $OPENWRT_PATH/bin/targets/*/*
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp $OPENWRT_PATH/.config ${{ matrix.variant }}.config
        
        # é‡å‘½åæ–‡ä»¶
        mv config.buildinfo ${{ matrix.variant }}.config.buildinfo
        mv immortalwrt-qualcommax-ipq60xx.manifest immortalwrt-qualcommax-ipq60xx-${{ matrix.variant }}.manifest
        
        # æ•´ç†è½¯ä»¶åŒ…
        mkdir -p packages
        mv -f $OPENWRT_PATH/bin/packages/*/*/*.apk packages 2>/dev/null || true
        tar -zcf ${{ matrix.variant }}.Packages.tar.gz packages
        
        # æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
        rm -rf packages feeds.buildinfo version.buildinfo sha256sums profiles.json
        
        # è®¾ç½®è¾“å‡ºè·¯å¾„
        echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
        
        log_info "æ–‡ä»¶æ•´ç†å®Œæˆ"

    - name: ä¸Šä¼ è½¯ä»¶åŒ…æ¯”è¾ƒç»“æžœ
      if: always()
      uses: actions/upload-artifact@main
      with:
        name: package-compare-${{ matrix.variant }}
        path: ${{ env.PACKAGE_COMPARE_DIR }}

    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifact
      if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE != 'true'
      uses: actions/upload-artifact@main
      with:
        name: ${{ needs.Setup.outputs.source-repo }}-firmware-${{ matrix.variant }}-${{ needs.Setup.outputs.device-target }}-${{ needs.Setup.outputs.device-subtarget }}-${{ needs.Setup.outputs.file-date }}
        path: ${{ env.FIRMWARE_PATH }}

    - name: ä¸Šä¼ å›ºä»¶åˆ°Release
      if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
      uses: ncipollo/release-action@main
      with:
        name: ${{ needs.Setup.outputs.build-date }} for ${{ matrix.variant }}
        allowUpdates: true
        tag: ${{ matrix.variant }}-${{ needs.Setup.outputs.file-date }}
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ${{ env.FIRMWARE_PATH }}/*
        body: |
          **This is ImmortalWrt Firmware for ${{ matrix.variant }} variant**
          ### ðŸ“’ å›ºä»¶ä¿¡æ¯
          - è¿™æ˜¯ ${{ matrix.variant }} å˜ä½“çš„å›ºä»¶ï¼ŒåŒ…å«ä»¥ä¸‹ç‰¹æ€§ï¼š
            - Ultra: åŒ…å«æœ€å¤šç¬¬ä¸‰æ–¹luciè½¯ä»¶åŒ…
            - Max: åŒ…å«ä¸­ç­‰æ•°é‡ç¬¬ä¸‰æ–¹luciè½¯ä»¶åŒ…
            - Pro: åŒ…å«æœ€å°‘ç¬¬ä¸‰æ–¹luciè½¯ä»¶åŒ…
          - ðŸ’» è¿™æ˜¯ IPQ60xx å¹³å°ä½¿ç”¨çš„ ImmortalWrt å›ºä»¶
          - âš½ å›ºä»¶æºç : ${{ env.REPO_URL }}
          - ðŸ’ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
          - ðŸŒ é»˜è®¤åœ°å€: **192.168.111.1**
          - ðŸ”‘ é»˜è®¤å¯†ç : none
          - â±ï¸ ç¼–è¯‘è€—æ—¶: ${{ env.BUILD_TIME }} ç§’
          ### ðŸ§Š å›ºä»¶ç‰ˆæœ¬
          - å›ºä»¶å†…æ ¸ç‰ˆæœ¬ï¼š**${{ needs.Setup.outputs.version-kernel }}**
          - å›ºä»¶ç¼–è¯‘å‰æœ€åŽä¸€æ¬¡âž¦[ä¸»æºç ](${{ env.REPO_URL }})æ›´æ–°è®°å½•
          - ${{ needs.Setup.outputs.version-info }}

  Cleanup:
    needs: [Setup, Build]
    runs-on: ubuntu-22.04
    if: always()
    
    steps:
    - name: åˆ é™¤æ—§ç¼“å­˜
      run: |
        # èŽ·å–ç¼“å­˜åˆ—è¡¨å¹¶åˆ é™¤
        gh cache list --key ${{ needs.Setup.outputs.source-repo }}-${{ env.REPO_BRANCH }}-${{ needs.Setup.outputs.device-target }}-${{ needs.Setup.outputs.device-subtarget }}- --json key --jq '.[] | .key' | while read -r key; do
          gh cache delete "$key"
        done
        # è¾“å‡ºç¼“å­˜çŠ¶æ€
        echo "========cache status========"
        echo "ccache: $(du -sh /mnt/openwrt/.ccache 2>/dev/null | cut -f 1 || echo "N/A")"
        echo "staging: $(du -sh /mnt/openwrt/staging_dir 2>/dev/null | cut -f 1 || echo "N/A")"
        echo "dl: $(du -sh /mnt/openwrt/dl 2>/dev/null | cut -f 1 || echo "N/A")"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
