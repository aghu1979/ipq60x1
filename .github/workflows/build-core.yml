name: Build Core System

on:
  workflow_dispatch:
    inputs:
      build_all:
        description: 'æ˜¯å¦ç¼–è¯‘æ‰€æœ‰ç»„åˆ'
        required: true
        default: true
        type: boolean
      chip:
        description: 'èŠ¯ç‰‡åž‹å·ï¼ˆå½“build_allä¸ºfalseæ—¶ç”Ÿæ•ˆï¼‰'
        required: false
        default: 'ipq60xx'
        type: choice
        options:
          - ipq60xx
          # - ipq80xx  # æš‚æ—¶æ³¨é‡Šï¼Œä¿ç•™æ‰©å±•ç©ºé—´
      branch:
        description: 'æºç åˆ†æ”¯ï¼ˆå½“build_allä¸ºfalseæ—¶ç”Ÿæ•ˆï¼‰'
        required: false
        default: 'openwrt'
        type: choice
        options:
          - openwrt
          - immwrt
          - libwrt
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è‡ªåŠ¨ç¼–è¯‘

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ ç”Ÿæˆç¼–è¯‘çŸ©é˜µ
        id: set-matrix
        run: |
          if [ "${{ inputs.build_all }}" = "true" ]; then
            # ç¼–è¯‘æ‰€æœ‰ç»„åˆï¼ˆæš‚æ—¶åªåŒ…å«ipq60xxï¼‰
            matrix=$(jq -n -c \
              --argjson chips '["ipq60xx"]' \
              # --argjson chips '["ipq60xx", "ipq80xx"]'  # æœªæ¥æ‰©å±•æ—¶å–æ¶ˆæ³¨é‡Š
              --argjson branches '["openwrt", "immwrt", "libwrt"]' \
              '{
                include: [
                  $chips[] as $chip | $branches[] as $branch | {chip, branch}
                ]
              }')
            echo "ðŸ“‹ å°†ç¼–è¯‘æ‰€æœ‰èŠ¯ç‰‡å’Œåˆ†æ”¯ç»„åˆ"
          else
            # åªç¼–è¯‘æŒ‡å®šç»„åˆ
            matrix=$(jq -n -c \
              --arg chip "${{ inputs.chip }}" \
              --arg branch "${{ inputs.branch }}" \
              '{
                include: [
                  {chip: $chip, branch: $branch}
                ]
              }')
            echo "ðŸ“‹ å°†ç¼–è¯‘æŒ‡å®šç»„åˆ: ${{ inputs.chip }}-${{ inputs.branch }}"
          fi
          
          echo "matrix=$matrix" >> $GITHUB_OUTPUT
          echo "Generated matrix: $matrix"

  build-core:
    needs: generate-matrix
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ”§ è®¾ç½®çŽ¯å¢ƒ
        id: setup
        run: |
          # å®‰è£…ä¾èµ–
          sudo apt-get update
          sudo apt-get install -y jq curl build-essential
          
          # è®¾ç½®å˜é‡
          CHIP="${{ matrix.chip }}"
          BRANCH="${{ matrix.branch }}"
          BUILD_PATH="core-build-${CHIP}-${BRANCH}"
          
          # ç”Ÿæˆç¼“å­˜é”®
          CHIP_HASH=$(sha256sum "configs/base_${CHIP}.config" | cut -d' ' -f1)
          BRANCH_HASH=$(sha256sum "configs/base_${BRANCH}.config" | cut -d' ' -f1)
          CACHE_KEY="core-${CHIP}-${BRANCH}-${CHIP_HASH:0:8}-${BRANCH_HASH:0:8}"
          
          # è¾“å‡ºå˜é‡
          echo "build-path=$BUILD_PATH" >> $GITHUB_OUTPUT
          echo "cache-key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "chip=$CHIP" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          
          echo "âœ… çŽ¯å¢ƒè®¾ç½®å®Œæˆ"
          echo "  - èŠ¯ç‰‡: $CHIP"
          echo "  - åˆ†æ”¯: $BRANCH"
          echo "  - æž„å»ºè·¯å¾„: $BUILD_PATH"
          echo "  - ç¼“å­˜é”®: $CACHE_KEY"

      - name: ðŸ“¦ æ£€æŸ¥ç¼“å­˜
        id: cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.setup.outputs.build-path }}
          key: ${{ steps.setup.outputs.cache-key }}
          restore-keys: |
            core-${{ matrix.chip }}-${{ matrix.branch }}-

      - name: ðŸŒ± ç¼–è¯‘æ ¸å¿ƒç³»ç»Ÿ
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          # æ‰§è¡Œæ ¸å¿ƒç¼–è¯‘è„šæœ¬
          chmod +x scripts/build-core.sh
          ./scripts/build-core.sh \
            --chip "${{ steps.setup.outputs.chip }}" \
            --branch "${{ steps.setup.outputs.branch }}" \
            --path "${{ steps.setup.outputs.build-path }}"

      - name: ðŸ“¤ ä¸Šä¼ æ ¸å¿ƒç³»ç»Ÿ
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: core-${{ matrix.chip }}-${{ matrix.branch }}-${{ github.run_id }}
          path: ${{ steps.setup.outputs.build-path }}
          retention-days: 7

  # ç”Ÿæˆæ‰€æœ‰æ ¸å¿ƒç³»ç»Ÿçš„æ˜ å°„æ–‡ä»¶
  generate-core-map:
    needs: [generate-matrix, build-core]
    runs-on: ubuntu-latest
    if: always() && needs.build-core.result == 'success'
    steps:
      - name: ðŸ“ ç”Ÿæˆæ ¸å¿ƒç³»ç»Ÿæ˜ å°„æ–‡ä»¶
        run: |
          # åˆ›å»ºæ˜ å°„æ–‡ä»¶ï¼ˆæš‚æ—¶åªåŒ…å«ipq60xxï¼‰
          cat > core-map.json << EOF
          {
            "ipq60xx-openwrt": "core-ipq60xx-openwrt-${{ github.run_id }}",
            "ipq60xx-immwrt": "core-ipq60xx-immwrt-${{ github.run_id }}",
            "ipq60xx-libwrt": "core-ipq60xx-libwrt-${{ github.run_id }}",
            # "ipq80xx-openwrt": "core-ipq80xx-openwrt-${{ github.run_id }}",  # æœªæ¥æ‰©å±•æ—¶å–æ¶ˆæ³¨é‡Š
            # "ipq80xx-immwrt": "core-ipq80xx-immwrt-${{ github.run_id }}",   # æœªæ¥æ‰©å±•æ—¶å–æ¶ˆæ³¨é‡Š
            # "ipq80xx-libwrt": "core-ipq80xx-libwrt-${{ github.run_id }}"    # æœªæ¥æ‰©å±•æ—¶å–æ¶ˆæ³¨é‡Š
          }
          EOF
          
          echo "ðŸ“‹ æ ¸å¿ƒç³»ç»Ÿæ˜ å°„æ–‡ä»¶:"
          cat core-map.json

      - name: ðŸ“¤ ä¸Šä¼ æ˜ å°„æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: core-map-${{ github.run_id }}
          path: core-map.json
          retention-days: 1

  # è‡ªåŠ¨è§¦å‘æ‰€æœ‰è½¯ä»¶åŒ…ç¼–è¯‘
  trigger-packages:
    needs: [generate-matrix, build-core, generate-core-map]
    runs-on: ubuntu-latest
    if: always() && needs.build-core.result == 'success' && needs.generate-core-map.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        package: [Pro, Max, Ultra]
    steps:
      - name: ðŸš€ è§¦å‘è½¯ä»¶åŒ…ç¼–è¯‘
        run: |
          echo "ðŸ“‹ å°†ä¸ºæ‰€æœ‰æ ¸å¿ƒç³»ç»Ÿç¼–è¯‘ ${{ matrix.package }} è½¯ä»¶åŒ…"
          # è¿™é‡Œåªæ˜¯å±•ç¤ºä¿¡æ¯ï¼Œå®žé™…çš„è½¯ä»¶åŒ…ç¼–è¯‘éœ€è¦æ‰‹åŠ¨è§¦å‘æˆ–é€šè¿‡å…¶ä»–æ–¹å¼
