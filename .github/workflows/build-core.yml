name: Build Core System

on:
  workflow_dispatch:
    inputs:
      chip:
        description: 'èŠ¯ç‰‡å‹å·'
        required: true
        default: 'ipq60xx'
        type: choice
        options:
          - ipq60xx
          - ipq80xx
      branch:
        description: 'æºç åˆ†æ”¯'
        required: true
        default: 'openwrt'
        type: choice
        options:
          - openwrt
          - immwrt
          - libwrt

jobs:
  build-core:
    runs-on: ubuntu-22.04
    outputs:
      core-cache-key: ${{ steps.cache.outputs.cache-hit }}
      build-path: ${{ steps.setup.outputs.build-path }}
      cache-key: ${{ steps.setup.outputs.cache-key }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½®ç¯å¢ƒ
        id: setup
        run: |
          # å®‰è£…ä¾èµ–
          sudo apt-get update
          sudo apt-get install -y jq curl build-essential
          
          # è®¾ç½®å˜é‡
          CHIP="${{ inputs.chip }}"
          BRANCH="${{ inputs.branch }}"
          BUILD_PATH="core-build-${CHIP}-${BRANCH}"
          
          # ç”Ÿæˆç¼“å­˜é”®
          CHIP_HASH=$(sha256sum "configs/base_${CHIP}.config" | cut -d' ' -f1)
          BRANCH_HASH=$(sha256sum "configs/base_${BRANCH}.config" | cut -d' ' -f1)
          CACHE_KEY="core-${CHIP}-${BRANCH}-${CHIP_HASH:0:8}-${BRANCH_HASH:0:8}"
          
          # è¾“å‡ºå˜é‡
          echo "build-path=$BUILD_PATH" >> $GITHUB_OUTPUT
          echo "cache-key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "chip=$CHIP" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          
          echo "âœ… ç¯å¢ƒè®¾ç½®å®Œæˆ"
          echo "  - èŠ¯ç‰‡: $CHIP"
          echo "  - åˆ†æ”¯: $BRANCH"
          echo "  - æ„å»ºè·¯å¾„: $BUILD_PATH"
          echo "  - ç¼“å­˜é”®: $CACHE_KEY"

      - name: ğŸ“¦ æ£€æŸ¥ç¼“å­˜
        id: cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.setup.outputs.build-path }}
          key: ${{ steps.setup.outputs.cache-key }}
          restore-keys: |
            core-${{ inputs.chip }}-${{ inputs.branch }}-

      - name: ğŸŒ± ç¼–è¯‘æ ¸å¿ƒç³»ç»Ÿ
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          # æ‰§è¡Œæ ¸å¿ƒç¼–è¯‘è„šæœ¬
          chmod +x scripts/build-core.sh
          ./scripts/build-core.sh \
            --chip "${{ steps.setup.outputs.chip }}" \
            --branch "${{ steps.setup.outputs.branch }}" \
            --path "${{ steps.setup.outputs.build-path }}"

      - name: ğŸ“¤ ä¸Šä¼ æ ¸å¿ƒç³»ç»Ÿ
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: core-${{ inputs.chip }}-${{ inputs.branch }}-${{ github.run_id }}
          path: ${{ steps.setup.outputs.build-path }}
          retention-days: 7
