name: ImmortalWrt åˆ†å±‚ç¼–è¯‘ç³»ç»Ÿ

# è§¦å‘æ¡ä»¶ï¼šå®šæ—¶ä»»åŠ¡ï¼ˆæ¯å‘¨äº”0ç‚¹åŒ—äº¬æ—¶é—´ï¼‰å’Œæ‰‹åŠ¨è§¦å‘
on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯å‘¨äº”0ç‚¹ = UTCæ¯å‘¨å››16ç‚¹
    - cron: '0 16 * * 4'
  workflow_dispatch:
    inputs:
      ubuntu_version:
        description: 'é€‰æ‹©Ubuntuç‰ˆæœ¬'
        required: true
        default: '22.04'
        type: choice
        options:
          - '22.04'
          - '24.04'
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°ç¼–è¯‘ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        required: false
        default: false
        type: boolean

# å…¨å±€çŽ¯å¢ƒå˜é‡
env:
  REPO_URL: https://github.com/laipeng668/immortalwrt.git
  REPO_BRANCH: master
  REPO_SHORT: immwrt
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: scripts/diy.sh
  DIY_P2_SH: scripts/repo.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  AUTHOR_NAME: Mary
  DEFAULT_IP: 192.168.111.1
  DEFAULT_PASSWORD: none
  DEFAULT_WIFI_PASSWORD: 12345678

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šçŽ¯å¢ƒå‡†å¤‡å’ŒåŸºç¡€çŽ¯å¢ƒç¼–è¯‘
  setup-and-base-build:
    name: ðŸš€ çŽ¯å¢ƒå‡†å¤‡ä¸ŽåŸºç¡€ç¼–è¯‘
    runs-on: ubuntu-${{ github.event.inputs.ubuntu_version || '22.04' }}
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      device-list: ${{ steps.parse-devices.outputs.devices }}
      kernel-version: ${{ steps.get-kernel.outputs.version }}
      build-date: ${{ steps.get-date.outputs.date }}
      cache-hit: ${{ steps.cache-base.outputs.cache-hit }}
      
    steps:
      - name: ðŸ§¹ æ¸…ç†ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“Š æ˜¾ç¤ºåˆå§‹ç£ç›˜ç©ºé—´
        run: |
          echo "## ðŸ“Š åˆå§‹ç£ç›˜ç©ºé—´" >> $GITHUB_STEP_SUMMARY
          df -h | tee -a $GITHUB_STEP_SUMMARY

      - name: ðŸ§ å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev \
            libssl-dev python3-distutils python3-pyelftools \
            python3-setuptools python3-serial rsync unzip \
            zlib1g-dev file wget ccache curl device-tree-compiler \
            python3-pip python3-wheel qemu-utils
          sudo pip3 install --upgrade pip
          sudo pip3 install pyelftools

      - name: ðŸ“… èŽ·å–æž„å»ºæ—¥æœŸ
        id: get-date
        run: |
          echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
          echo "## ðŸ“… æž„å»ºæ—¥æœŸ: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”‘ ç”Ÿæˆç¼“å­˜é”®
        id: cache-key
        run: |
          # ç”ŸæˆåŒ…å«æ‰€æœ‰ç›¸å…³è¾“å…¥çš„å“ˆå¸Œå€¼
          HASH_CONTENT="${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-$(cat .github/configs/base_ipq60xx.config .github/configs/base_immwrt.config | sha256sum | cut -d' ' -f1)"
          CACHE_KEY="base-${HASH_CONTENT:0:16}"
          echo "key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          echo "## ðŸ”‘ ç¼“å­˜é”®: ${CACHE_KEY}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¦ æ£€å‡ºåŸºç¡€çŽ¯å¢ƒç¼“å­˜
        id: cache-base
        uses: actions/cache@v4
        with:
          path: |
            openwrt/
            !openwrt/bin/
            !openwrt/logs/
            !openwrt/tmp/
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            base-

      - name: ðŸ“¥ å…‹éš†æºç ï¼ˆç¼“å­˜æœªå‘½ä¸­æ—¶ï¼‰
        if: steps.cache-base.outputs.cache-hit != 'true'
        run: |
          echo "## ðŸ“¥ ç¼“å­˜æœªå‘½ä¸­ï¼Œå¼€å§‹å…‹éš†æºç " >> $GITHUB_STEP_SUMMARY
          git clone ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} openwrt
          cd openwrt
          
          # åº”ç”¨åŸºç¡€é…ç½®
          echo "## ðŸ”§ åº”ç”¨èŠ¯ç‰‡åŸºç¡€é…ç½®" >> $GITHUB_STEP_SUMMARY
          cat ../.github/configs/base_ipq60xx.config >> .config
          
          echo "## ðŸ”§ åº”ç”¨åˆ†æ”¯åŸºç¡€é…ç½®" >> $GITHUB_STEP_SUMMARY
          cat ../.github/configs/base_immwrt.config >> .config
          
          # æ›´æ–°feeds
          echo "## ðŸ“¦ æ›´æ–°feeds" >> $GITHUB_STEP_SUMMARY
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # å‡†å¤‡åŸºç¡€ç¼–è¯‘çŽ¯å¢ƒ
          echo "## ðŸ—ï¸ å‡†å¤‡åŸºç¡€ç¼–è¯‘çŽ¯å¢ƒ" >> $GITHUB_STEP_SUMMARY
          make defconfig
          make download -j8
          make tools/compile -j$(nproc)
          make toolchain/compile -j$(nproc)

      - name: ðŸ” è§£æžè®¾å¤‡åˆ—è¡¨
        id: parse-devices
        run: |
          cd openwrt
          # ä»Žé…ç½®æ–‡ä»¶ä¸­æå–è®¾å¤‡åç§°
          DEVICES=$(grep "CONFIG_TARGET_DEVICE.*=y" .config | sed 's/.*DEVICE_\(.*\)=y/\1/' | tr '\n' ' ')
          echo "devices=${DEVICES}" >> $GITHUB_OUTPUT
          echo "## ðŸ“± æ£€æµ‹åˆ°çš„è®¾å¤‡: ${DEVICES}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§ èŽ·å–å†…æ ¸ç‰ˆæœ¬
        id: get-kernel
        run: |
          cd openwrt
          if [ -f include/kernel-version.mk ]; then
            KERNEL_VERSION=$(grep "KERNEL_VERSION" include/kernel-version.mk | cut -d'=' -f2 | tr -d ' ')
          else
            KERNEL_VERSION="unknown"
          fi
          echo "version=${KERNEL_VERSION}" >> $GITHUB_OUTPUT
          echo "## ðŸ§ å†…æ ¸ç‰ˆæœ¬: ${KERNEL_VERSION}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“Š æ˜¾ç¤ºå‡†å¤‡åŽç£ç›˜ç©ºé—´
        run: |
          echo "## ðŸ“Š å‡†å¤‡åŽç£ç›˜ç©ºé—´" >> $GITHUB_STEP_SUMMARY
          df -h | tee -a $GITHUB_STEP_SUMMARY

  # ç¬¬äºŒé˜¶æ®µï¼šå¹¶è¡Œç¼–è¯‘ä¸åŒé…ç½®çš„å›ºä»¶
  build-firmware:
    name: ðŸ—ï¸ ç¼–è¯‘å›ºä»¶ (${{ matrix.config }})
    needs: setup-and-base-build
    runs-on: ubuntu-${{ github.event.inputs.ubuntu_version || '22.04' }}
    strategy:
      fail-fast: false
      matrix:
        config: [Pro, Max, Ultra]
    
    steps:
      - name: ðŸ§¹ æ¸…ç†ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ æ¢å¤åŸºç¡€çŽ¯å¢ƒç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            openwrt/
            !openwrt/bin/
            !openwrt/logs/
            !openwrt/tmp/
          key: ${{ needs.setup-and-base-build.outputs.cache-key }}

      - name: ðŸ”§ åº”ç”¨ç”¨æˆ·é…ç½®
        run: |
          cd openwrt
          
          # å¤‡ä»½åŽŸå§‹é…ç½®
          cp .config .config.base
          
          # åº”ç”¨ç”¨æˆ·é…ç½®
          if [ -f "../.github/configs/${{ matrix.config }}.config" ]; then
            echo "## ðŸ”§ åº”ç”¨ ${{ matrix.config }} é…ç½®" >> $GITHUB_STEP_SUMMARY
            cat "../.github/configs/${{ matrix.config }}.config" >> .config
          else
            echo "## âŒ æœªæ‰¾åˆ° ${{ matrix.config }}.config é…ç½®æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # é‡æ–°ç”Ÿæˆé…ç½®
          make defconfig
          
          # åˆ†æžluciè½¯ä»¶åŒ…å˜åŒ–
          echo "## ðŸ“¦ Luciè½¯ä»¶åŒ…åˆ†æž (${{ matrix.config }})" >> $GITHUB_STEP_SUMMARY
          echo "### åˆå¹¶å‰luciè½¯ä»¶åŒ…:" >> $GITHUB_STEP_SUMMARY
          grep "CONFIG_PACKAGE_luci-.*=y" .config.base | wc -l | tee -a $GITHUB_STEP_SUMMARY
          echo "### åˆå¹¶åŽluciè½¯ä»¶åŒ…:" >> $GITHUB_STEP_SUMMARY
          grep "CONFIG_PACKAGE_luci-.*=y" .config | wc -l | tee -a $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºæ–°å¢žçš„luciè½¯ä»¶åŒ…
          echo "### æ–°å¢žçš„luciè½¯ä»¶åŒ…:" >> $GITHUB_STEP_SUMMARY
          comm -13 <(grep "CONFIG_PACKAGE_luci-.*=y" .config.base | sort) \
                   <(grep "CONFIG_PACKAGE_luci-.*=y" .config | sort) | \
            sed 's/.*CONFIG_PACKAGE_\(.*\)=y/- \1/' | tee -a $GITHUB_STEP_SUMMARY || true

      - name: ðŸ—ï¸ ç¼–è¯‘å›ºä»¶
        run: |
          cd openwrt
          
          # è®¾ç½®ç¼–è¯‘å‚æ•°
          echo "## âš™ï¸ ç¼–è¯‘å‚æ•°è®¾ç½®" >> $GITHUB_STEP_SUMMARY
          echo "- å¹¶è¡Œæ•°: $(nproc)" >> $GITHUB_STEP_SUMMARY
          echo "- é…ç½®: ${{ matrix.config }}" >> $GITHUB_STEP_SUMMARY
          
          # å¼€å§‹ç¼–è¯‘
          echo "## ðŸ—ï¸ å¼€å§‹ç¼–è¯‘å›ºä»¶ (${{ matrix.config }})" >> $GITHUB_STEP_SUMMARY
          make -j$(nproc) 2>&1 | tee compile.log
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æžœ
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "## âŒ ç¼–è¯‘å¤±è´¥ï¼" >> $GITHUB_STEP_SUMMARY
            echo "### é”™è¯¯æ—¥å¿—ï¼ˆæœ€åŽ1000è¡Œï¼‰:" >> $GITHUB_STEP_SUMMARY
            tail -1000 compile.log >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "## âœ… ç¼–è¯‘å®Œæˆ (${{ matrix.config }})" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¦ æ”¶é›†ç¼–è¯‘äº§ç‰©
        run: |
          cd openwrt
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          TEMP_DIR="../temp_${{ matrix.config }}"
          mkdir -p "${TEMP_DIR}"
          
          # å¤åˆ¶å›ºä»¶æ–‡ä»¶
          echo "## ðŸ“¦ æ”¶é›†å›ºä»¶æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          find bin/targets/ -name "*squashfs-*" -type f | while read file; do
            # æå–è®¾å¤‡åç§°
            DEVICE=$(echo "$file" | grep -oE "DEVICE_[^/]+" | sed 's/DEVICE_//' || echo "unknown")
            
            # æ ¹æ®æ–‡ä»¶ç±»åž‹é‡å‘½å
            if [[ "$file" == *"factory"* ]]; then
              NEW_NAME="${{ env.REPO_SHORT }}-${DEVICE}-factory-${{ matrix.config }}.bin"
            elif [[ "$file" == *"sysupgrade"* ]]; then
              NEW_NAME="${{ env.REPO_SHORT }}-${DEVICE}-sysupgrade-${{ matrix.config }}.bin"
            fi
            
            cp "$file" "${TEMP_DIR}/${NEW_NAME}"
            echo "- ${NEW_NAME}" >> $GITHUB_STEP_SUMMARY
          done
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          echo "## ðŸ“„ æ”¶é›†é…ç½®æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          for device in ${{ needs.setup-and-base-build.outputs.device-list }}; do
            cp .config "${TEMP_DIR}/${{ env.REPO_SHORT }}-${device}-${{ matrix.config }}.config"
            cp bin/targets/*/*/manifest "${TEMP_DIR}/${{ env.REPO_SHORT }}-${device}-${{ matrix.config }}.manifest" 2>/dev/null || true
            cp config.buildinfo "${TEMP_DIR}/${{ env.REPO_SHORT }}-${device}-${{ matrix.config }}.config.buildinfo" 2>/dev/null || true
          done
          
          # æ”¶é›†è½¯ä»¶åŒ…
          echo "## ðŸ“¦ æ”¶é›†è½¯ä»¶åŒ…" >> $GITHUB_STEP_SUMMARY
          mkdir -p "${TEMP_DIR}/packages"
          find bin/packages/ -name "*.ipk" -o -name "*.apk" 2>/dev/null | while read pkg; do
            cp "$pkg" "${TEMP_DIR}/packages/"
          done
          
          # æ‰“åŒ…è½¯ä»¶åŒ…
          cd "${TEMP_DIR}"
          tar -czf "ipq60xx-app-${{ matrix.config }}.tar.gz" packages/
          
          # æ‰“åŒ…é…ç½®æ–‡ä»¶
          tar -czf "ipq60xx-config-${{ matrix.config }}.tar.gz" *.config *.manifest *.config.buildinfo 2>/dev/null || true

      - name: ðŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.config }}
          path: temp_${{ matrix.config }}/
          retention-days: 7

  # ç¬¬ä¸‰é˜¶æ®µï¼šå‘å¸ƒåˆ°Release
  release:
    name: ðŸš€ å‘å¸ƒRelease
    needs: [setup-and-base-build, build-firmware]
    runs-on: ubuntu-22.04
    if: always() && (needs.build-firmware.result == 'success' || needs.build-firmware.result == 'skipped')
    
    steps:
      - name: ðŸ“¥ ä¸‹è½½æ‰€æœ‰ç¼–è¯‘äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: ðŸ“¦ æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release/
          
          # åˆå¹¶æ‰€æœ‰é…ç½®æ–‡ä»¶
          echo "## ðŸ“¦ æ•´ç†é…ç½®æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          cat artifacts/firmware-*/ipq60xx-config-*.tar.gz | tar -xz -C release/ 2>/dev/null || true
          
          # åˆå¹¶æ‰€æœ‰è½¯ä»¶åŒ…
          echo "## ðŸ“¦ åˆå¹¶è½¯ä»¶åŒ…" >> $GITHUB_STEP_SUMMARY
          mkdir -p release/packages/
          find artifacts/ -name "*.ipk" -o -name "*.apk" | while read pkg; do
            cp "$pkg" release/packages/
          done
          cd release/
          tar -czf "ipq60xx-app.tar.gz" packages/
          
          # å¤åˆ¶æ‰€æœ‰å›ºä»¶
          echo "## ðŸ“¦ æ”¶é›†å›ºä»¶æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          find artifacts/ -name "*.bin" -type f | while read bin; do
            cp "$bin" release/
            echo "- $(basename $bin)" >> $GITHUB_STEP_SUMMARY
          done
          
          # ç”Ÿæˆè½¯ä»¶åŒ…åˆ—è¡¨
          echo "## ðŸ“‹ ç”Ÿæˆçš„luci-appåˆ—è¡¨:" >> $GITHUB_STEP_SUMMARY
          find packages/ -name "luci-app-*.ipk" -o -name "luci-app-*.apk" | \
            sed 's/.*\///g' | sed 's/\.ipk$//' | sed 's/\.apk$//' | \
            sort | while read app; do
              echo "- $app" >> $GITHUB_STEP_SUMMARY
            done

      - name: ðŸ“ ç”ŸæˆReleaseè¯´æ˜Ž
        run: |
          cat > release/NOTES.md << EOF
          # ImmortalWrt å›ºä»¶å‘å¸ƒ
          
          ## ðŸ“‹ åŸºæœ¬ä¿¡æ¯
          - **é»˜è®¤ç®¡ç†åœ°å€**: ${{ env.DEFAULT_IP }}
          - **é»˜è®¤ç”¨æˆ·**: root
          - **é»˜è®¤å¯†ç **: ${{ env.DEFAULT_PASSWORD }}
          - **é»˜è®¤WIFIå¯†ç **: ${{ env.DEFAULT_WIFI_PASSWORD }}
          
          ## ðŸ—ï¸ æž„å»ºä¿¡æ¯
          - **åˆ†æ”¯**: ${{ env.REPO_SHORT }}
          - **å†…æ ¸ç‰ˆæœ¬**: ${{ needs.setup-and-base-build.outputs.kernel-version }}
          - **æž„å»ºæ—¥æœŸ**: ${{ needs.setup-and-base-build.outputs.build-date }}
          - **ä½œè€…**: ${{ env.AUTHOR_NAME }}
          
          ## ðŸ“± æ”¯æŒçš„è®¾å¤‡
          ${{ needs.setup-and-base-build.outputs.device-list }}
          
          ## ðŸ“¦ é…ç½®ç‰ˆæœ¬
          - Pro: åŸºç¡€é…ç½®
          - Max: å¢žå¼ºé…ç½®
          - Ultra: å®Œæ•´é…ç½®
          
          ## ðŸ“‹ åŒ…å«çš„luciåº”ç”¨
          $(find release/packages/ -name "luci-app-*.ipk" -o -name "luci-app-*.apk" | sed 's/.*\///g' | sed 's/\.ipk$//' | sed 's/\.apk$//' | sed 's/^/- /' | sort)
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          1. åˆ·æœºå‰è¯·å¤‡ä»½åŽŸé…ç½®
          2. é¦–æ¬¡åˆ·æœºå»ºè®®ä½¿ç”¨factoryå›ºä»¶
          3. å‡çº§è¯·ä½¿ç”¨sysupgradeå›ºä»¶
          4. åˆ·æœºåŽéœ€æ¢å¤å‡ºåŽ‚è®¾ç½®
          
          ---
          æž„å»ºæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')
          EOF

      - name: ðŸš€ å‘å¸ƒåˆ°GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ipq60xx-${{ needs.setup-and-base-build.outputs.build-date }}
          name: ImmortalWrt ipq60xx ${{ needs.setup-and-base-build.outputs.build-date }}
          body_path: release/NOTES.md
          files: |
            release/*.bin
            release/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š æ˜¾ç¤ºæœ€ç»ˆç£ç›˜ç©ºé—´
        run: |
          echo "## ðŸ“Š æœ€ç»ˆç£ç›˜ç©ºé—´" >> $GITHUB_STEP_SUMMARY
          df -h | tee -a $GITHUB_STEP_SUMMARY
