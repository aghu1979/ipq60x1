name: OpenWrt Base System Build

on:
  workflow_call:
    inputs:
      chip:
        required: true
        type: string
      branch:
        required: true
        type: string

jobs:
  build-base:
    runs-on: ubuntu-22.04
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      build-path: ${{ steps.cache-key.outputs.path }}
    steps:
      - name: ğŸ› ï¸ åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” æ£€æŸ¥ç›®å½•ç»“æ„
        run: |
          echo "ğŸ“Œ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“Œ æ ¹ç›®å½•å†…å®¹:"
          ls -la
          echo ""
          echo "ğŸ“Œ æ£€æŸ¥.githubç›®å½•:"
          ls -la .github/ 2>/dev/null || echo "âŒ .githubç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "ğŸ“Œ æŸ¥æ‰¾configsç›®å½•:"
          find . -name "configs" -type d 2>/dev/null
          echo ""
          echo "ğŸ“Œ æŸ¥æ‰¾scriptsç›®å½•:"
          find . -name "scripts" -type d 2>/dev/null
          echo ""
          echo "ğŸ“Œ æŸ¥æ‰¾baseé…ç½®æ–‡ä»¶:"
          find . -name "base_*.config" -type f 2>/dev/null
          echo ""
          echo "ğŸ“‹ è¾“å…¥å‚æ•°:"
          echo "  - chip: '${{ inputs.chip }}'"
          echo "  - branch: '${{ inputs.branch }}'"

      - name: ğŸ”‘ ç”Ÿæˆç¼“å­˜é”®
        id: cache-key
        run: |
          echo "ğŸ“‹ å¼€å§‹ç”Ÿæˆç¼“å­˜é”®..."
          echo "  - chip: '${{ inputs.chip }}'"
          echo "  - branch: '${{ inputs.branch }}'"
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          CHIP_CONFIG_FILE="base_${{ inputs.chip }}.config"
          BRANCH_CONFIG_FILE="base_${{ inputs.branch }}.config"
          
          echo "ğŸ“‹ æŸ¥æ‰¾é…ç½®æ–‡ä»¶:"
          echo "  - èŠ¯ç‰‡é…ç½®æ–‡ä»¶: $CHIP_CONFIG_FILE"
          echo "  - åˆ†æ”¯é…ç½®æ–‡ä»¶: $BRANCH_CONFIG_FILE"
          
          # æŸ¥æ‰¾èŠ¯ç‰‡é…ç½®æ–‡ä»¶
          if [ -f "configs/$CHIP_CONFIG_FILE" ]; then
            CHIP_CONFIG="configs/$CHIP_CONFIG_FILE"
            echo "  âœ… æ‰¾åˆ°èŠ¯ç‰‡é…ç½®: $CHIP_CONFIG"
          elif [ -f ".github/configs/$CHIP_CONFIG_FILE" ]; then
            CHIP_CONFIG=".github/configs/$CHIP_CONFIG_FILE"
            echo "  âœ… æ‰¾åˆ°èŠ¯ç‰‡é…ç½®: $CHIP_CONFIG"
          else
            echo "  âŒ æ‰¾ä¸åˆ°èŠ¯ç‰‡é…ç½®æ–‡ä»¶: $CHIP_CONFIG_FILE"
            echo "ğŸ“‹ å¯ç”¨çš„èŠ¯ç‰‡é…ç½®æ–‡ä»¶:"
            find . -name "base_*.config" -type f 2>/dev/null | sed 's/^/    /'
            exit 1
          fi
          
          # æŸ¥æ‰¾åˆ†æ”¯é…ç½®æ–‡ä»¶
          if [ -f "configs/$BRANCH_CONFIG_FILE" ]; then
            BRANCH_CONFIG="configs/$BRANCH_CONFIG_FILE"
            echo "  âœ… æ‰¾åˆ°åˆ†æ”¯é…ç½®: $BRANCH_CONFIG"
          elif [ -f ".github/configs/$BRANCH_CONFIG_FILE" ]; then
            BRANCH_CONFIG=".github/configs/$BRANCH_CONFIG_FILE"
            echo "  âœ… æ‰¾åˆ°åˆ†æ”¯é…ç½®: $BRANCH_CONFIG"
          else
            echo "  âŒ æ‰¾ä¸åˆ°åˆ†æ”¯é…ç½®æ–‡ä»¶: $BRANCH_CONFIG_FILE"
            echo "ğŸ“‹ å¯ç”¨çš„åˆ†æ”¯é…ç½®æ–‡ä»¶:"
            find . -name "base_*.config" -type f 2>/dev/null | grep "base_openwrt\|base_immwrt\|base_libwrt" | sed 's/^/    /'
            exit 1
          fi
          
          # ç”ŸæˆåŸºäºé…ç½®çš„ç¼“å­˜é”®
          CHIP_HASH=$(sha256sum "$CHIP_CONFIG" | cut -d' ' -f1)
          BRANCH_HASH=$(sha256sum "$BRANCH_CONFIG" | cut -d' ' -f1)
          CACHE_KEY="base-${{ inputs.chip }}-${{ inputs.branch }}-${CHIP_HASH:0:8}-${BRANCH_HASH:0:8}"
          BUILD_PATH="build-base-${{ inputs.chip }}-${{ inputs.branch }}"
          
          echo "key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "path=$BUILD_PATH" >> $GITHUB_OUTPUT
          echo "chip-config=$CHIP_CONFIG" >> $GITHUB_OUTPUT
          echo "branch-config=$BRANCH_CONFIG" >> $GITHUB_OUTPUT
          echo "âœ… ç¼“å­˜é”®ç”Ÿæˆå®Œæˆ: $CACHE_KEY"

      - name: ğŸ“¦ æ¢å¤åŸºç¡€ç¯å¢ƒç¼“å­˜
        id: cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.cache-key.outputs.path }}
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            base-${{ inputs.chip }}-${{ inputs.branch }}-

      - name: ğŸŒ± å‡†å¤‡åŸºç¡€ç¯å¢ƒ
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ”§ å‡†å¤‡åŸºç¡€ç¼–è¯‘ç¯å¢ƒ..."
          echo "ğŸ“Œ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“Œ èŠ¯ç‰‡: ${{ inputs.chip }}"
          echo "ğŸ“Œ åˆ†æ”¯: ${{ inputs.branch }}"
          echo "ğŸ“Œ èŠ¯ç‰‡é…ç½®æ–‡ä»¶: ${{ steps.cache-key.outputs.chip-config }}"
          echo "ğŸ“Œ åˆ†æ”¯é…ç½®æ–‡ä»¶: ${{ steps.cache-key.outputs.branch-config }}"
          
          # åˆ›å»ºæ„å»ºç›®å½•
          mkdir -p ${{ steps.cache-key.outputs.path }}
          
          # è®¾ç½®æºç ä»“åº“URLå’Œåˆ†æ”¯ - ä½¿ç”¨æ­£ç¡®çš„ä»“åº“åœ°å€
          case "${{ inputs.branch }}" in
            "openwrt")
              REPO_URL="https://github.com/laipeng668/openwrt.git"
              REPO_BRANCH="master"
              ;;
            "immwrt")
              REPO_URL="https://github.com/laipeng668/immortalwrt.git"
              REPO_BRANCH="master"
              ;;
            "libwrt")
              REPO_URL="https://github.com/laipeng668/openwrt-6.x.git"
              REPO_BRANCH="k6.12-nss"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„åˆ†æ”¯: ${{ inputs.branch }}"
              echo "ğŸ’¡ æ”¯æŒçš„åˆ†æ”¯: openwrt, immwrt, libwrt"
              exit 1
              ;;
          esac
          
          echo "ğŸ”½ å…‹éš†æºç : $REPO_URL"
          echo "ğŸ“‹ ä½¿ç”¨åˆ†æ”¯: $REPO_BRANCH"
          
          # å…‹éš†æŒ‡å®šåˆ†æ”¯
          git clone --depth=1 -b $REPO_BRANCH $REPO_URL openwrt-src
          
          # è¿›å…¥æºç ç›®å½•
          cd openwrt-src
          echo "ğŸ“Œ è¿›å…¥æºç ç›®å½•: $(pwd)"
          echo "ğŸ“Œ å½“å‰åˆ†æ”¯:"
          git branch
          echo "ğŸ“Œ ä¸Šçº§ç›®å½•å†…å®¹:"
          ls -la ../
          
          # ä¿®æ­£é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹äºopenwrt-srcç›®å½•ï¼‰
          CHIP_CONFIG_REL="../${{ steps.cache-key.outputs.chip-config }}"
          BRANCH_CONFIG_REL="../${{ steps.cache-key.outputs.branch-config }}"
          
          echo "ğŸ“‹ ç›¸å¯¹è·¯å¾„:"
          echo "  - èŠ¯ç‰‡é…ç½®: $CHIP_CONFIG_REL"
          echo "  - åˆ†æ”¯é…ç½®: $BRANCH_CONFIG_REL"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$CHIP_CONFIG_REL" ]; then
            echo "âŒ èŠ¯ç‰‡é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CHIP_CONFIG_REL"
            echo "ğŸ“‹ ä¸Šçº§ç›®å½•ä¸­çš„configså†…å®¹:"
            ls -la ../configs/ 2>/dev/null || echo "configsç›®å½•ä¸å­˜åœ¨"
            echo "ğŸ“‹ ä¸Šçº§ç›®å½•ä¸­çš„.github/configså†…å®¹:"
            ls -la ../.github/configs/ 2>/dev/null || echo ".github/configsç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ ! -f "$BRANCH_CONFIG_REL" ]; then
            echo "âŒ åˆ†æ”¯é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $BRANCH_CONFIG_REL"
            exit 1
          fi
          
          # ä¿å­˜èŠ¯ç‰‡é…ç½®ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
          echo "ğŸ“‹ ä¿å­˜èŠ¯ç‰‡é…ç½®..."
          cp "$CHIP_CONFIG_REL" .config.chip
          echo "âœ… å·²ä¿å­˜èŠ¯ç‰‡é…ç½®"
          
          # åº”ç”¨èŠ¯ç‰‡é…ç½®
          cp "$CHIP_CONFIG_REL" .config
          echo "âœ… å·²åº”ç”¨èŠ¯ç‰‡é…ç½®"
          
          # ä¿å­˜åˆ†æ”¯é…ç½®ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
          cp "$BRANCH_CONFIG_REL" .config.branch
          echo "âœ… å·²ä¿å­˜åˆ†æ”¯é…ç½®"
          
          # è¿½åŠ åˆ†æ”¯é…ç½®
          cat "$BRANCH_CONFIG_REL" >> .config
          echo "âœ… å·²åº”ç”¨åˆ†æ”¯é…ç½®"
          
          # ç¬¬ä¸€æ¬¡ make defconfig - è¡¥å…¨åŸºç¡€é…ç½®çš„ä¾èµ–
          echo ""
          echo "ğŸ”§ ç¬¬ä¸€æ¬¡ make defconfig - è¡¥å…¨åŸºç¡€é…ç½®ä¾èµ–..."
          make defconfig
          echo "ğŸ“‹ åŸºç¡€é…ç½®é¡¹æ•°: $(grep -c '^CONFIG_' .config)"
          
          # ç¬¬ä¸€æ¬¡LUCIè½¯ä»¶åŒ…æ£€æŸ¥
          echo ""
          echo "ğŸ” ==================== ç¬¬ä¸€æ¬¡LUCIè½¯ä»¶åŒ…æ£€æŸ¥ ===================="
          LUCI_PACKAGES=$(grep "^CONFIG_PACKAGE_luci-" .config | sed 's/^CONFIG_PACKAGE_\(.*\)=y/\1/' | sort)
          if [ -n "$LUCI_PACKAGES" ]; then
            echo "ğŸ“¦ åŸºç¡€é…ç½®ä¸­çš„LUCIè½¯ä»¶åŒ…:"
            echo "$LUCI_PACKAGES"
            
            # æ£€æŸ¥è½¯ä»¶åŒ…å¯ç”¨æ€§
            MISSING_PACKAGES=""
            for pkg in $LUCI_PACKAGES; do
              if [ ! -d "package/feeds/packages/$pkg" ] && [ ! -d "package/feeds/luci/$pkg" ] && [ ! -d "package/$pkg" ]; then
                MISSING_PACKAGES="$MISSING_PACKAGES $pkg"
              fi
            done
            
            if [ -n "$MISSING_PACKAGES" ]; then
              echo "âš ï¸ å‘ç°ç¼ºå¤±çš„LUCIè½¯ä»¶åŒ…:$MISSING_PACKAGES"
              echo "ğŸ’¡ è¿™äº›è½¯ä»¶åŒ…å¯èƒ½åœ¨feedsæ›´æ–°åå¯ç”¨"
            else
              echo "âœ… æ‰€æœ‰åŸºç¡€LUCIè½¯ä»¶åŒ…éƒ½å¯ç”¨"
            fi
          else
            echo "â„¹ï¸ åŸºç¡€é…ç½®ä¸­æ²¡æœ‰LUCIè½¯ä»¶åŒ…"
          fi
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶è„šæœ¬æ–‡ä»¶
          if [ -d "../scripts" ]; then
            SCRIPT_DIR="../scripts"
          elif [ -d "../.github/scripts" ]; then
            SCRIPT_DIR="../.github/scripts"
          else
            echo "âŒ æ‰¾ä¸åˆ°scriptsç›®å½•"
            echo "ğŸ“‹ ä¸Šçº§ç›®å½•å†…å®¹:"
            ls -la ../
            exit 1
          fi
          
          echo "ğŸ“‹ ä½¿ç”¨è„šæœ¬ç›®å½•: $SCRIPT_DIR"
          cp "$SCRIPT_DIR/diy.sh" ./
          cp "$SCRIPT_DIR/repo.sh" ./
          cp "$SCRIPT_DIR/compare-packages.sh" ./
          chmod +x diy.sh repo.sh compare-packages.sh
          
          # ç¬¬ä¸€é˜¶æ®µï¼šå¯¹æ¯”èŠ¯ç‰‡é…ç½®å’Œåˆå¹¶åçš„é…ç½®
          echo ""
          echo "ğŸ” ==================== åŸºç¡€ç³»ç»Ÿé…ç½®å¯¹æ¯” ===================="
          echo "å¯¹æ¯”: èŠ¯ç‰‡é…ç½® â†’ (èŠ¯ç‰‡é…ç½® + åˆ†æ”¯é…ç½®)"
          ./compare-packages.sh .config.chip .config "åŸºç¡€ç³»ç»Ÿ"
          
          # æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
          echo ""
          echo "ğŸ”§ æ‰§è¡Œç³»ç»Ÿåˆå§‹åŒ–..."
          ./diy.sh
          
          echo "ğŸ“¦ æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº..."
          ./repo.sh
          
          # æ›´æ–°feeds
          echo "ğŸ”„ æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # ç¬¬äºŒæ¬¡ make defconfig - è¡¥å…¨feedsæ›´æ–°åçš„é…ç½®
          echo ""
          echo "ğŸ”§ ç¬¬äºŒæ¬¡ make defconfig - è¡¥å…¨feedsæ›´æ–°åçš„é…ç½®..."
          make defconfig
          echo "ğŸ“‹ feedsæ›´æ–°åé…ç½®é¡¹æ•°: $(grep -c '^CONFIG_' .config)"
          
          # ç¬¬äºŒæ¬¡LUCIè½¯ä»¶åŒ…æ£€æŸ¥å’Œè‡ªåŠ¨ä¿®å¤
          echo ""
          echo "ğŸ” ==================== ç¬¬äºŒæ¬¡LUCIè½¯ä»¶åŒ…æ£€æŸ¥ ===================="
          LUCI_PACKAGES=$(grep "^CONFIG_PACKAGE_luci-" .config | sed 's/^CONFIG_PACKAGE_\(.*\)=y/\1/' | sort)
          TOTAL_PACKAGES=$(echo "$LUCI_PACKAGES" | wc -l)
          echo "ğŸ“¦ éœ€è¦çš„LUCIè½¯ä»¶åŒ…æ€»æ•°: $TOTAL_PACKAGES"
          
          if [ $TOTAL_PACKAGES -gt 0 ]; then
            # åˆ›å»ºæ£€æŸ¥æŠ¥å‘Š
            printf '# åŸºç¡€ç³»ç»ŸLUCIè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š\n\n**æ£€æŸ¥æ—¶é—´**: %s\n**é…ç½®**: %s-%s\n**æ€»è½¯ä»¶åŒ…æ•°**: %d\n\n## ğŸ“¦ è½¯ä»¶åŒ…å¯ç”¨æ€§æ£€æŸ¥\n\n| è½¯ä»¶åŒ… | çŠ¶æ€ | ä½ç½® | å¤‡æ³¨ |\n|--------|------|------|------|\n' \
              "$(date)" "${{ inputs.chip }}" "${{ inputs.branch }}" "$TOTAL_PACKAGES" > luci-packages-åŸºç¡€ç³»ç»Ÿ.md
            
            MISSING_COUNT=0
            FOUND_COUNT=0
            MISSING_PACKAGES=""
            
            for pkg in $LUCI_PACKAGES; do
              if [ -d "package/feeds/packages/$pkg" ]; then
                echo "âœ… $pkg - å¯ç”¨ (packages)"
                printf '| %s | âœ… å¯ç”¨ | packages | - |\n' "$pkg" >> luci-packages-åŸºç¡€ç³»ç»Ÿ.md
                ((FOUND_COUNT++))
              elif [ -d "package/feeds/luci/$pkg" ]; then
                echo "âœ… $pkg - å¯ç”¨ (luci)"
                printf '| %s | âœ… å¯ç”¨ | luci | - |\n' "$pkg" >> luci-packages-åŸºç¡€ç³»ç»Ÿ.md
                ((FOUND_COUNT++))
              elif [ -d "package/$pkg" ]; then
                echo "âœ… $pkg - å¯ç”¨ (local)"
                printf '| %s | âœ… å¯ç”¨ | local | - |\n' "$pkg" >> luci-packages-åŸºç¡€ç³»ç»Ÿ.md
                ((FOUND_COUNT++))
              else
                echo "âŒ $pkg - ç¼ºå¤±"
                printf '| %s | âŒ ç¼ºå¤± | - | éœ€è¦ä¿®å¤ |\n' "$pkg" >> luci-packages-åŸºç¡€ç³»ç»Ÿ.md
                ((MISSING_COUNT++))
                MISSING_PACKAGES="$MISSING_PACKAGES $pkg"
              fi
            done
            
            # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
            printf '\n## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯\n\n- æ€»è½¯ä»¶åŒ…æ•°: %d\n- æ‰¾åˆ°è½¯ä»¶åŒ…: %d\n- ç¼ºå¤±è½¯ä»¶åŒ…: %d\n- æˆåŠŸç‡: %d%%\n' \
              "$TOTAL_PACKAGES" "$FOUND_COUNT" "$MISSING_COUNT" "$(( FOUND_COUNT * 100 / TOTAL_PACKAGES ))" >> luci-packages-åŸºç¡€ç³»ç»Ÿ.md
            
            if [ $MISSING_COUNT -gt 0 ]; then
              echo ""
              echo "ğŸš¨ å‘ç° $MISSING_COUNT ä¸ªç¼ºå¤±çš„LUCIè½¯ä»¶åŒ…ï¼"
              echo "ğŸ“¦ ç¼ºå¤±åˆ—è¡¨:$MISSING_PACKAGES"
              echo ""
              echo "ğŸ”§ å°è¯•è‡ªåŠ¨ä¿®å¤..."
              
              # å°è¯•è‡ªåŠ¨ä¿®å¤
              REPAIRED_COUNT=0
              for pkg in $MISSING_PACKAGES; do
                echo "ğŸ” ä¿®å¤è½¯ä»¶åŒ…: $pkg"
                
                # å°è¯•æŸ¥æ‰¾ç›¸ä¼¼çš„è½¯ä»¶åŒ…å
                SIMILAR=$(find package/feeds -name "*$(echo $pkg | tr '-' '\n' | head -1)*" -type d 2>/dev/null | head -5)
                if [ -n "$SIMILAR" ]; then
                  echo "  ğŸ’¡ æ‰¾åˆ°ç›¸ä¼¼çš„è½¯ä»¶åŒ…:"
                  echo "$SIMILAR" | sed 's/^/    /'
                fi
                
                # å°è¯•é‡æ–°å®‰è£…feeds
                echo "  ğŸ”„ å°è¯•é‡æ–°å®‰è£…feeds..."
                if ./scripts/feeds install $pkg 2>/dev/null; then
                  echo "  âœ… æˆåŠŸå®‰è£…: $pkg"
                  ((REPAIRED_COUNT++))
                else
                  echo "  âŒ æ— æ³•å®‰è£…: $pkg"
                  
                  # å°è¯•æŸ¥æ‰¾è½¯ä»¶åŒ…å®šä¹‰
                  PKG_FOUND=$(find . -name "Makefile" -exec grep -l "Package/$pkg" {} \; 2>/dev/null | head -3)
                  if [ -n "$PKG_FOUND" ]; then
                    echo "  ğŸ“„ è½¯ä»¶åŒ…å®šä¹‰ä½ç½®:"
                    echo "$PKG_FOUND" | sed 's/^/    /'
                  fi
                fi
              done
              
              # ç¬¬ä¸‰æ¬¡ make defconfig - ä¿®å¤åæ›´æ–°é…ç½®
              if [ $REPAIRED_COUNT -gt 0 ]; then
                echo ""
                echo "ğŸ”§ ç¬¬ä¸‰æ¬¡ make defconfig - ä¿®å¤åæ›´æ–°é…ç½®..."
                make defconfig
                
                # æœ€ç»ˆæ£€æŸ¥
                echo ""
                echo "ğŸ” ==================== æœ€ç»ˆLUCIè½¯ä»¶åŒ…æ£€æŸ¥ ===================="
                FINAL_MISSING_COUNT=0
                for pkg in $MISSING_PACKAGES; do
                  if [ -d "package/feeds/packages/$pkg" ] || [ -d "package/feeds/luci/$pkg" ] || [ -d "package/$pkg" ]; then
                    echo "âœ… $pkg - å·²ä¿®å¤"
                  else
                    echo "âŒ $pkg - ä»ç„¶ç¼ºå¤±"
                    ((FINAL_MISSING_COUNT++))
                  fi
                done
                
                # æ›´æ–°æŠ¥å‘Š
                printf '\n## ğŸ”§ è‡ªåŠ¨ä¿®å¤ç»“æœ\n\n- å°è¯•ä¿®å¤: %d\n- æˆåŠŸä¿®å¤: %d\n- ä»ç„¶ç¼ºå¤±: %d\n' \
                  "$MISSING_COUNT" "$REPAIRED_COUNT" "$FINAL_MISSING_COUNT" >> luci-packages-åŸºç¡€ç³»ç»Ÿ.md
                
                if [ $FINAL_MISSING_COUNT -gt 0 ]; then
                  echo ""
                  echo "âŒ ä»æœ‰ $FINAL_MISSING_COUNT ä¸ªè½¯ä»¶åŒ…æ— æ³•ä¿®å¤"
                  echo "ğŸš¨ åŸºç¡€ç³»ç»Ÿç¼–è¯‘å°†åœæ­¢ï¼Œè¯·æ£€æŸ¥è½¯ä»¶åŒ…åç§°æˆ–æºç "
                  exit 1
                else
                  echo ""
                  echo "âœ… æ‰€æœ‰LUCIè½¯ä»¶åŒ…å·²æˆåŠŸä¿®å¤ï¼"
                fi
              else
                echo ""
                echo "âŒ è‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼Œæ— æ³•ä¿®å¤ä»»ä½•è½¯ä»¶åŒ…"
                echo "ğŸš¨ åŸºç¡€ç³»ç»Ÿç¼–è¯‘å°†åœæ­¢"
                exit 1
              fi
            else
              echo ""
              echo "âœ… æ‰€æœ‰ $TOTAL_PACKAGES ä¸ªLUCIè½¯ä»¶åŒ…æ£€æŸ¥é€šè¿‡ï¼"
            fi
          else
            echo "â„¹ï¸ åŸºç¡€é…ç½®ä¸­æ²¡æœ‰LUCIè½¯ä»¶åŒ…"
            printf '# åŸºç¡€ç³»ç»ŸLUCIè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š\n\n**æ£€æŸ¥æ—¶é—´**: %s\n**é…ç½®**: %s-%s\n\nâ„¹ï¸ åŸºç¡€é…ç½®ä¸­æ²¡æœ‰LUCIè½¯ä»¶åŒ…\n' \
              "$(date)" "${{ inputs.chip }}" "${{ inputs.branch }}" > luci-packages-åŸºç¡€ç³»ç»Ÿ.md
          fi
          
          # å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
          echo "ğŸ”¨ å‡†å¤‡ç¼–è¯‘å·¥å…·é“¾..."
          make -j$(nproc) IGNORE_ERRORS=1 download
          make -j$(nproc) IGNORE_ERRORS=1 tools/compile
          make -j$(nproc) IGNORE_ERRORS=1 toolchain/compile
          
          # ä¿å­˜å¯¹æ¯”æŠ¥å‘Šåˆ°å½“å‰ç›®å½•
          if [ -f "luci-packages-åŸºç¡€ç³»ç»Ÿ.md" ]; then
            cp luci-packages-åŸºç¡€ç³»ç»Ÿ.md ../luci-packages-åŸºç¡€ç³»ç»Ÿ-${{ inputs.branch }}.md
            echo "âœ… å·²ä¿å­˜å¯¹æ¯”æŠ¥å‘Š: luci-packages-åŸºç¡€ç³»ç»Ÿ-${{ inputs.branch }}.md"
          else
            echo "âš ï¸ å¯¹æ¯”æŠ¥å‘Šæœªç”Ÿæˆ"
          fi
          
          # è¿”å›ä¸Šçº§ç›®å½•
          cd ..
          
          # æ‰“åŒ…åŸºç¡€ç¯å¢ƒ
          echo "ğŸ“¦ æ‰“åŒ…åŸºç¡€ç¯å¢ƒ..."
          tar -czf ${{ steps.cache-key.outputs.path }}/base.tar.gz -C openwrt-src .
          echo "âœ… åŸºç¡€ç¯å¢ƒå‡†å¤‡å®Œæˆ"

      - name: ğŸ“¤ ä¸Šä¼ åŸºç¡€ç³»ç»ŸæŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: base-report-${{ inputs.branch }}-${{ github.run_id }}
          path: |
            luci-packages-åŸºç¡€ç³»ç»Ÿ-${{ inputs.branch }}.md
          retention-days: 7
          if-no-files-found: warn
