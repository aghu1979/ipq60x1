name: OpenWrt Base System Build

on:
  workflow_call:
    inputs:
      chip:
        required: true
        type: string
      branch:
        required: true
        type: string

jobs:
  build-base:
    runs-on: ubuntu-22.04
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      build-path: ${{ steps.cache-key.outputs.path }}
    steps:
      - name: ğŸ› ï¸ åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” æ£€æŸ¥ç›®å½•ç»“æ„
        run: |
          echo "ğŸ“Œ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“Œ æ ¹ç›®å½•å†…å®¹:"
          ls -la
          echo ""
          echo "ğŸ“Œ æ£€æŸ¥.githubç›®å½•:"
          ls -la .github/ 2>/dev/null || echo "âŒ .githubç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "ğŸ“Œ æŸ¥æ‰¾configsç›®å½•:"
          find . -name "configs" -type d 2>/dev/null
          echo ""
          echo "ğŸ“Œ æŸ¥æ‰¾scriptsç›®å½•:"
          find . -name "scripts" -type d 2>/dev/null
          echo ""
          echo "ğŸ“Œ æŸ¥æ‰¾baseé…ç½®æ–‡ä»¶:"
          find . -name "base_*.config" -type f 2>/dev/null

      - name: ğŸ”‘ ç”Ÿæˆç¼“å­˜é”®
        id: cache-key
        run: |
          # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "configs/base_${{ inputs.chip }}.config" ]; then
            CHIP_CONFIG="configs/base_${{ inputs.chip }}.config"
          elif [ -f ".github/configs/base_${{ inputs.chip }}.config" ]; then
            CHIP_CONFIG=".github/configs/base_${{ inputs.chip }}.config"
          else
            echo "âŒ æ‰¾ä¸åˆ°èŠ¯ç‰‡é…ç½®æ–‡ä»¶: base_${{ inputs.chip }}.config"
            exit 1
          fi
          
          if [ -f "configs/base_${{ inputs.branch }}.config" ]; then
            BRANCH_CONFIG="configs/base_${{ inputs.branch }}.config"
          elif [ -f ".github/configs/base_${{ inputs.branch }}.config" ]; then
            BRANCH_CONFIG=".github/configs/base_${{ inputs.branch }}.config"
          else
            echo "âŒ æ‰¾ä¸åˆ°åˆ†æ”¯é…ç½®æ–‡ä»¶: base_${{ inputs.branch }}.config"
            exit 1
          fi
          
          # ç”ŸæˆåŸºäºé…ç½®çš„ç¼“å­˜é”®
          CHIP_HASH=$(sha256sum "$CHIP_CONFIG" | cut -d' ' -f1)
          BRANCH_HASH=$(sha256sum "$BRANCH_CONFIG" | cut -d' ' -f1)
          CACHE_KEY="base-${{ inputs.chip }}-${{ inputs.branch }}-${CHIP_HASH:0:8}-${BRANCH_HASH:0:8}"
          BUILD_PATH="build-base-${{ inputs.chip }}-${{ inputs.branch }}"
          
          echo "key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "path=$BUILD_PATH" >> $GITHUB_OUTPUT
          echo "chip-config=$CHIP_CONFIG" >> $GITHUB_OUTPUT
          echo "branch-config=$BRANCH_CONFIG" >> $GITHUB_OUTPUT
          echo "Generated cache key: $CACHE_KEY"

      - name: ğŸ“¦ æ¢å¤åŸºç¡€ç¯å¢ƒç¼“å­˜
        id: cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.cache-key.outputs.path }}
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            base-${{ inputs.chip }}-${{ inputs.branch }}-

      - name: ğŸŒ± å‡†å¤‡åŸºç¡€ç¯å¢ƒ
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ”§ å‡†å¤‡åŸºç¡€ç¼–è¯‘ç¯å¢ƒ..."
          echo "ğŸ“Œ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“Œ èŠ¯ç‰‡: ${{ inputs.chip }}"
          echo "ğŸ“Œ åˆ†æ”¯: ${{ inputs.branch }}"
          echo "ğŸ“Œ èŠ¯ç‰‡é…ç½®æ–‡ä»¶: ${{ steps.cache-key.outputs.chip-config }}"
          echo "ğŸ“Œ åˆ†æ”¯é…ç½®æ–‡ä»¶: ${{ steps.cache-key.outputs.branch-config }}"
          
          # åˆ›å»ºæ„å»ºç›®å½•
          mkdir -p ${{ steps.cache-key.outputs.path }}
          
          # è®¾ç½®æºç ä»“åº“URL
          case "${{ inputs.branch }}" in
            "openwrt")
              REPO_URL="https://github.com/openwrt/openwrt"
              ;;
            "immwrt")
              REPO_URL="https://github.com/immortalwrt/immortalwrt"
              ;;
            "libwrt")
              REPO_URL="https://github.com/LibreWrt/LibreWrt"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„åˆ†æ”¯: ${{ inputs.branch }}"
              echo "ğŸ’¡ æ”¯æŒçš„åˆ†æ”¯: openwrt, immwrt, libwrt"
              exit 1
              ;;
          esac
          
          # å…‹éš†æºç 
          echo "ğŸ”½ å…‹éš†æºç : $REPO_URL"
          git clone --depth=1 $REPO_URL openwrt-src
          
          # è¿›å…¥æºç ç›®å½•
          cd openwrt-src
          echo "ğŸ“Œ è¿›å…¥æºç ç›®å½•: $(pwd)"
          
          # ä¿å­˜èŠ¯ç‰‡é…ç½®ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
          echo "ğŸ“‹ ä¿å­˜èŠ¯ç‰‡é…ç½®..."
          cp "${{ steps.cache-key.outputs.chip-config }}" .config.chip
          echo "âœ… å·²ä¿å­˜èŠ¯ç‰‡é…ç½®"
          
          # åº”ç”¨èŠ¯ç‰‡é…ç½®
          cp "${{ steps.cache-key.outputs.chip-config }}" .config
          echo "âœ… å·²åº”ç”¨èŠ¯ç‰‡é…ç½®"
          
          # ä¿å­˜åˆ†æ”¯é…ç½®ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
          cp "${{ steps.cache-key.outputs.branch-config }}" .config.branch
          echo "âœ… å·²ä¿å­˜åˆ†æ”¯é…ç½®"
          
          # è¿½åŠ åˆ†æ”¯é…ç½®
          cat "${{ steps.cache-key.outputs.branch-config }}" >> .config
          echo "âœ… å·²åº”ç”¨åˆ†æ”¯é…ç½®"
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶è„šæœ¬æ–‡ä»¶
          if [ -d "../scripts" ]; then
            SCRIPT_DIR="../scripts"
          elif [ -d ".github/scripts" ]; then
            SCRIPT_DIR=".github/scripts"
          else
            echo "âŒ æ‰¾ä¸åˆ°scriptsç›®å½•"
            exit 1
          fi
          
          echo "ğŸ“‹ ä½¿ç”¨è„šæœ¬ç›®å½•: $SCRIPT_DIR"
          cp "$SCRIPT_DIR/diy.sh" ./
          cp "$SCRIPT_DIR/repo.sh" ./
          cp "$SCRIPT_DIR/compare-packages.sh" ./
          chmod +x diy.sh repo.sh compare-packages.sh
          
          # ç¬¬ä¸€é˜¶æ®µï¼šå¯¹æ¯”èŠ¯ç‰‡é…ç½®å’Œåˆå¹¶åçš„é…ç½®
          echo ""
          echo "ğŸ” ==================== åŸºç¡€ç³»ç»Ÿé…ç½®å¯¹æ¯” ===================="
          echo "å¯¹æ¯”: èŠ¯ç‰‡é…ç½® â†’ (èŠ¯ç‰‡é…ç½® + åˆ†æ”¯é…ç½®)"
          ./compare-packages.sh .config.chip .config "åŸºç¡€ç³»ç»Ÿ"
          
          # æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
          echo ""
          echo "ğŸ”§ æ‰§è¡Œç³»ç»Ÿåˆå§‹åŒ–..."
          ./diy.sh
          
          echo "ğŸ“¦ æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº..."
          ./repo.sh
          
          # æ›´æ–°feeds
          echo "ğŸ”„ æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
          echo "ğŸ”¨ å‡†å¤‡ç¼–è¯‘å·¥å…·é“¾..."
          make defconfig
          make -j$(nproc) IGNORE_ERRORS=1 download
          make -j$(nproc) IGNORE_ERRORS=1 tools/compile
          make -j$(nproc) IGNORE_ERRORS=1 toolchain/compile
          
          # ä¿å­˜å¯¹æ¯”æŠ¥å‘Š
          if [ -f "luci-packages-åŸºç¡€ç³»ç»Ÿ.md" ]; then
            cp luci-packages-åŸºç¡€ç³»ç»Ÿ.md ../
            echo "âœ… å·²ä¿å­˜å¯¹æ¯”æŠ¥å‘Š"
          else
            echo "âš ï¸ å¯¹æ¯”æŠ¥å‘Šæœªç”Ÿæˆ"
          fi
          
          # è¿”å›ä¸Šçº§ç›®å½•
          cd ..
          
          # æ‰“åŒ…åŸºç¡€ç¯å¢ƒ
          echo "ğŸ“¦ æ‰“åŒ…åŸºç¡€ç¯å¢ƒ..."
          tar -czf ${{ steps.cache-key.outputs.path }}/base.tar.gz -C openwrt-src .
          echo "âœ… åŸºç¡€ç¯å¢ƒå‡†å¤‡å®Œæˆ"

      - name: ğŸ“¤ ä¸Šä¼ åŸºç¡€ç³»ç»ŸæŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: base-report-${{ github.run_id }}
          path: |
            luci-packages-åŸºç¡€ç³»ç»Ÿ.md
          retention-days: 7
          if-no-files-found: warn
