name: OpenWrt Base System Build

on:
  workflow_call:
    inputs:
      chip:
        required: true
        type: string
      branch:
        required: true
        type: string
    outputs:
      cache-key: ${{ jobs.build-base.outputs.cache-key }}
      build-path: ${{ jobs.build-base.outputs.build-path }}

jobs:
  build-base:
    runs-on: ubuntu-22.04
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      build-path: ${{ steps.cache-key.outputs.path }}
    steps:
      - name: ğŸ› ï¸ åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”‘ ç”Ÿæˆç¼“å­˜é”®
        id: cache-key
        run: |
          # ç”ŸæˆåŸºäºé…ç½®çš„ç¼“å­˜é”®
          CHIP_HASH=$(sha256sum configs/base_${{ inputs.chip }}.config | cut -d' ' -f1)
          BRANCH_HASH=$(sha256sum configs/base_${{ inputs.branch }}.config | cut -d' ' -f1)
          CACHE_KEY="base-${{ inputs.chip }}-${{ inputs.branch }}-${CHIP_HASH:0:8}-${BRANCH_HASH:0:8}"
          BUILD_PATH="build-base-${{ inputs.chip }}-${{ inputs.branch }}"
          
          echo "key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "path=$BUILD_PATH" >> $GITHUB_OUTPUT
          echo "Generated cache key: $CACHE_KEY"

      - name: ğŸ“¦ æ¢å¤åŸºç¡€ç¯å¢ƒç¼“å­˜
        id: cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.cache-key.outputs.path }}
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            base-${{ inputs.chip }}-${{ inputs.branch }}-

      - name: ğŸŒ± å‡†å¤‡åŸºç¡€ç¯å¢ƒ
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ”§ å‡†å¤‡åŸºç¡€ç¼–è¯‘ç¯å¢ƒ..."
          echo "ğŸ“Œ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“Œ é…ç½®æ–‡ä»¶ç›®å½•å†…å®¹:"
          ls -la configs/
          echo "ğŸ“Œ è„šæœ¬ç›®å½•å†…å®¹:"
          ls -la scripts/
          
          # åˆ›å»ºæ„å»ºç›®å½•
          mkdir -p ${{ steps.cache-key.outputs.path }}
          
          # è®¾ç½®æºç ä»“åº“URL
          case "${{ inputs.branch }}" in
            "openwrt")
              REPO_URL="https://github.com/openwrt/openwrt"
              ;;
            "immwrt")
              REPO_URL="https://github.com/immortalwrt/immortalwrt"
              ;;
            "libwrt")
              REPO_URL="https://github.com/LibreWrt/LibreWrt"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„åˆ†æ”¯: ${{ inputs.branch }}"
              exit 1
              ;;
          esac
          
          # å…‹éš†æºç 
          echo "ğŸ”½ å…‹éš†æºç : $REPO_URL"
          git clone --depth=1 $REPO_URL openwrt-src
          
          # è¿›å…¥æºç ç›®å½•
          cd openwrt-src
          echo "ğŸ“Œ è¿›å…¥æºç ç›®å½•: $(pwd)"
          
          # ä¿å­˜èŠ¯ç‰‡é…ç½®ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
          echo "ğŸ“‹ ä¿å­˜èŠ¯ç‰‡é…ç½®..."
          if [ -f "../configs/base_${{ inputs.chip }}.config" ]; then
            cp "../configs/base_${{ inputs.chip }}.config" .config.chip
            echo "âœ… å·²ä¿å­˜èŠ¯ç‰‡é…ç½®"
          else
            echo "âŒ æ‰¾ä¸åˆ°èŠ¯ç‰‡é…ç½®æ–‡ä»¶: configs/base_${{ inputs.chip }}.config"
            exit 1
          fi
          
          # åº”ç”¨èŠ¯ç‰‡é…ç½®
          cp "../configs/base_${{ inputs.chip }}.config" .config
          echo "âœ… å·²åº”ç”¨èŠ¯ç‰‡é…ç½®: configs/base_${{ inputs.chip }}.config"
          
          # ä¿å­˜åˆ†æ”¯é…ç½®ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
          if [ -f "../configs/base_${{ inputs.branch }}.config" ]; then
            cp "../configs/base_${{ inputs.branch }}.config" .config.branch
            echo "âœ… å·²ä¿å­˜åˆ†æ”¯é…ç½®"
          else
            echo "âŒ æ‰¾ä¸åˆ°åˆ†æ”¯é…ç½®æ–‡ä»¶: configs/base_${{ inputs.branch }}.config"
            exit 1
          fi
          
          # è¿½åŠ åˆ†æ”¯é…ç½®
          cat "../configs/base_${{ inputs.branch }}.config" >> .config
          echo "âœ… å·²åº”ç”¨åˆ†æ”¯é…ç½®: configs/base_${{ inputs.branch }}.config"
          
          # å¤åˆ¶è„šæœ¬æ–‡ä»¶
          cp ../scripts/diy.sh ./
          cp ../scripts/repo.sh ./
          cp ../scripts/compare-packages.sh ./
          chmod +x diy.sh repo.sh compare-packages.sh
          
          # ç¬¬ä¸€é˜¶æ®µï¼šå¯¹æ¯”èŠ¯ç‰‡é…ç½®å’Œåˆå¹¶åçš„é…ç½®
          echo ""
          echo "ğŸ” ==================== åŸºç¡€ç³»ç»Ÿé…ç½®å¯¹æ¯” ===================="
          echo "å¯¹æ¯”: èŠ¯ç‰‡é…ç½® â†’ (èŠ¯ç‰‡é…ç½® + åˆ†æ”¯é…ç½®)"
          ./compare-packages.sh .config.chip .config "åŸºç¡€ç³»ç»Ÿ"
          
          # æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
          echo ""
          echo "ğŸ”§ æ‰§è¡Œç³»ç»Ÿåˆå§‹åŒ–..."
          ./diy.sh
          
          echo "ğŸ“¦ æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº..."
          ./repo.sh
          
          # æ›´æ–°feeds
          echo "ğŸ”„ æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
          echo "ğŸ”¨ å‡†å¤‡ç¼–è¯‘å·¥å…·é“¾..."
          make defconfig
          make -j$(nproc) IGNORE_ERRORS=1 download
          make -j$(nproc) IGNORE_ERRORS=1 tools/compile
          make -j$(nproc) IGNORE_ERRORS=1 toolchain/compile
          
          # ä¿å­˜å¯¹æ¯”æŠ¥å‘Š
          cp luci-packages-åŸºç¡€ç³»ç»Ÿ.md ../
          
          # è¿”å›ä¸Šçº§ç›®å½•
          cd ..
          
          # æ‰“åŒ…åŸºç¡€ç¯å¢ƒ
          echo "ğŸ“¦ æ‰“åŒ…åŸºç¡€ç¯å¢ƒ..."
          tar -czf ${{ steps.cache-key.outputs.path }}/base.tar.gz -C openwrt-src .
          echo "âœ… åŸºç¡€ç¯å¢ƒå‡†å¤‡å®Œæˆ"

      - name: ğŸ“¤ ä¸Šä¼ åŸºç¡€ç³»ç»ŸæŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: base-report-${{ github.run_id }}
          path: |
            luci-packages-åŸºç¡€ç³»ç»Ÿ.md
          retention-days: 7
