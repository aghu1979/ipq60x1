name: OpenWrt Final Build

on:
  workflow_call:
    inputs:
      chip:
        required: true
        type: string
      branch:
        required: true
        type: string
      config:
        required: true
        type: string
      base-cache-key:
        required: true
        type: string
    secrets:
      GH_TOKEN:
        required: false

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    outputs:
      build-status: ${{ steps.build.outputs.status }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” æ£€æŸ¥ç›®å½•ç»“æ„
        run: |
          echo "ğŸ“Œ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“Œ æ ¹ç›®å½•å†…å®¹:"
          ls -la
          echo ""
          echo "ğŸ“Œ æŸ¥æ‰¾configsç›®å½•:"
          find . -name "configs" -type d 2>/dev/null
          echo ""
          echo "ğŸ“Œ æŸ¥æ‰¾scriptsç›®å½•:"
          find . -name "scripts" -type d 2>/dev/null
          echo ""
          echo "ğŸ“‹ è¾“å…¥å‚æ•°:"
          echo "  - chip: '${{ inputs.chip }}'"
          echo "  - branch: '${{ inputs.branch }}'"
          echo "  - config: '${{ inputs.config }}'"
          echo "  - base-cache-key: '${{ inputs.base-cache-key }}'"

      - name: ğŸ“¦ æ¢å¤åŸºç¡€ç¯å¢ƒ
        run: |
          echo "ğŸ“¦ æ¢å¤åŸºç¡€ç¯å¢ƒ..."
          echo "ğŸ“Œ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“Œ åŸºç¡€ç¼“å­˜é”®: '${{ inputs.base-cache-key }}'"
          
          # æ£€æŸ¥ç¼“å­˜é”®æ˜¯å¦ä¸ºç©º
          if [ -z "${{ inputs.base-cache-key }}" ]; then
            echo "âŒ åŸºç¡€ç¼“å­˜é”®ä¸ºç©º"
            echo "ğŸ“‹ æŸ¥æ‰¾æ‰€æœ‰ç¼“å­˜ç›®å½•:"
            find . -name "build-base-*" -type d 2>/dev/null
            exit 1
          fi
          
          # ä»ç¼“å­˜é”®ä¸­æå–æ„å»ºè·¯å¾„
          BUILD_PATH=$(echo "${{ inputs.base-cache-key }}" | sed 's/base-//' | sed 's/-[^-]*$//' | sed 's/-[^-]*$//')
          BUILD_PATH="build-base-$BUILD_PATH"
          echo "ğŸ“Œ æ¨æ–­çš„æ„å»ºè·¯å¾„: $BUILD_PATH"
          
          # åˆ›å»ºæ„å»ºç›®å½•
          mkdir -p openwrt-build
          
          # è§£å‹åŸºç¡€ç¯å¢ƒ
          if [ -f "$BUILD_PATH/base.tar.gz" ]; then
            tar -xzf "$BUILD_PATH/base.tar.gz" -C openwrt-build
            echo "âœ… åŸºç¡€ç¯å¢ƒæ¢å¤å®Œæˆ"
          else
            echo "âŒ æ‰¾ä¸åˆ°åŸºç¡€ç¯å¢ƒç¼“å­˜æ–‡ä»¶"
            echo "ğŸ“‹ æŸ¥æ‰¾æ‰€æœ‰ç¼“å­˜ç›®å½•:"
            find . -name "build-base-*" -type d 2>/dev/null
            echo "ğŸ“‹ æŸ¥æ‰¾æ‰€æœ‰base.tar.gzæ–‡ä»¶:"
            find . -name "base.tar.gz" -type f 2>/dev/null
            exit 1
          fi

      - name: ğŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶
        run: |
          echo "ğŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶..."
          cd openwrt-build
          
          # å¤‡ä»½åŸå§‹é…ç½®ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
          cp .config .config.base
          echo "ğŸ“‹ åŸå§‹é…ç½®é¡¹æ•°: $(grep -c '^CONFIG_' .config.base)"
          
          # æŸ¥æ‰¾ç”¨æˆ·é…ç½®æ–‡ä»¶
          if [ -f "../configs/${{ inputs.config }}.config" ]; then
            USER_CONFIG="../configs/${{ inputs.config }}.config"
          elif [ -f "../.github/configs/${{ inputs.config }}.config" ]; then
            USER_CONFIG="../.github/configs/${{ inputs.config }}.config"
          else
            echo "âŒ æ‰¾ä¸åˆ°ç”¨æˆ·é…ç½®æ–‡ä»¶: ${{ inputs.config }}.config"
            echo "ğŸ“‹ æŸ¥æ‰¾æ‰€æœ‰é…ç½®æ–‡ä»¶:"
            find .. -name "*.config" -type f 2>/dev/null
            exit 1
          fi
          
          echo "ğŸ“‹ åº”ç”¨ç”¨æˆ·é…ç½®: $USER_CONFIG"
          echo "ğŸ“‹ ç”¨æˆ·é…ç½®é¡¹æ•°: $(grep -c '^CONFIG_' "$USER_CONFIG")"
          
          # ä¿å­˜ç”¨æˆ·é…ç½®
          cp "$USER_CONFIG" .config.user
          
          # åˆå¹¶é…ç½®
          while IFS= read -r line; do
            if [[ $line =~ ^CONFIG_ ]]; then
              key=$(echo "$line" | cut -d'=' -f1)
              if grep -q "^$key=" .config; then
                sed -i "s|^$key=.*|$line|" .config
              else
                echo "$line" >> .config
              fi
            fi
          done < "$USER_CONFIG"
          
          echo "âœ… ç”¨æˆ·é…ç½®åˆå¹¶å®Œæˆ"
          
          # ç¬¬ä¸€æ¬¡ make defconfig - è¡¥å…¨ç”¨æˆ·é…ç½®çš„ä¾èµ–
          echo ""
          echo "ğŸ”§ ç¬¬ä¸€æ¬¡ make defconfig - è¡¥å…¨ç”¨æˆ·é…ç½®ä¾èµ–..."
          make defconfig
          echo "ğŸ“‹ åˆå¹¶ç”¨æˆ·é…ç½®åé¡¹æ•°: $(grep -c '^CONFIG_' .config)"
          
          # ç¬¬ä¸€æ¬¡LUCIè½¯ä»¶åŒ…æ£€æŸ¥
          echo ""
          echo "ğŸ” ==================== ç”¨æˆ·é…ç½®LUCIè½¯ä»¶åŒ…æ£€æŸ¥ ===================="
          USER_LUCI=$(grep "^CONFIG_PACKAGE_luci-" .config.user | sed 's/^CONFIG_PACKAGE_\(.*\)=y/\1/' | sort)
          if [ -n "$USER_LUCI" ]; then
            echo "ğŸ“¦ ç”¨æˆ·é…ç½®ä¸­çš„LUCIè½¯ä»¶åŒ…:"
            echo "$USER_LUCI"
            
            # æ£€æŸ¥è½¯ä»¶åŒ…å¯ç”¨æ€§
            MISSING_USER=""
            for pkg in $USER_LUCI; do
              if [ ! -d "package/feeds/packages/$pkg" ] && [ ! -d "package/feeds/luci/$pkg" ] && [ ! -d "package/$pkg" ]; then
                MISSING_USER="$MISSING_USER $pkg"
              fi
            done
            
            if [ -n "$MISSING_USER" ]; then
              echo "âš ï¸ ç”¨æˆ·é…ç½®ä¸­å‘ç°ç¼ºå¤±çš„LUCIè½¯ä»¶åŒ…:$MISSING_USER"
            else
              echo "âœ… ç”¨æˆ·é…ç½®ä¸­çš„æ‰€æœ‰LUCIè½¯ä»¶åŒ…éƒ½å¯ç”¨"
            fi
          else
            echo "â„¹ï¸ ç”¨æˆ·é…ç½®ä¸­æ²¡æœ‰LUCIè½¯ä»¶åŒ…"
          fi
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶å¯¹æ¯”è„šæœ¬
          if [ -f "../scripts/compare-packages.sh" ]; then
            cp ../scripts/compare-packages.sh ./
          elif [ -f "../.github/scripts/compare-packages.sh" ]; then
            cp ../.github/scripts/compare-packages.sh ./
          else
            echo "âŒ æ‰¾ä¸åˆ°compare-packages.shè„šæœ¬"
            exit 1
          fi
          chmod +x compare-packages.sh
          
          # ç¬¬äºŒé˜¶æ®µï¼šå¯¹æ¯”åŸºç¡€é…ç½®å’Œæœ€ç»ˆé…ç½®
          echo ""
          echo "ğŸ” ==================== æœ€ç»ˆé…ç½®å¯¹æ¯” ===================="
          echo "å¯¹æ¯”: åŸºç¡€é…ç½® â†’ (åŸºç¡€é…ç½® + ${{ inputs.config }}é…ç½®)"
          ./compare-packages.sh .config.base .config "æœ€ç»ˆé…ç½®-${{ inputs.config }}"
          
          # ç¬¬äºŒæ¬¡ make defconfig - ç¡®ä¿æœ€ç»ˆé…ç½®å®Œæ•´
          echo ""
          echo "ğŸ”§ ç¬¬äºŒæ¬¡ make defconfig - ç¡®ä¿æœ€ç»ˆé…ç½®å®Œæ•´..."
          make defconfig
          echo "ğŸ“‹ æœ€ç»ˆé…ç½®é¡¹æ•°: $(grep -c '^CONFIG_' .config)"

      - name: ğŸ” æ£€æŸ¥LUCIè½¯ä»¶åŒ…
        run: |
          echo "ğŸ” æœ€ç»ˆLUCIè½¯ä»¶åŒ…æ£€æŸ¥..."
          cd openwrt-build
          
          # æå–æ‰€æœ‰LUCIè½¯ä»¶åŒ…
          LUCI_PACKAGES=$(grep "^CONFIG_PACKAGE_luci-" .config | sed 's/^CONFIG_PACKAGE_\(.*\)=y/\1/' | sort)
          TOTAL_PACKAGES=$(echo "$LUCI_PACKAGES" | wc -l)
          echo "ğŸ“¦ æœ€ç»ˆéœ€è¦çš„LUCIè½¯ä»¶åŒ…æ€»æ•°: $TOTAL_PACKAGES"
          
          # åˆ›å»ºæ£€æŸ¥æŠ¥å‘Š - ä½¿ç”¨printfé¿å…heredocé—®é¢˜
          printf '# æœ€ç»ˆLUCIè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š - %s\n\n**æ£€æŸ¥æ—¶é—´**: %s\n**é…ç½®**: %s-%s-%s\n**æ€»è½¯ä»¶åŒ…æ•°**: %d\n\n## ğŸ“¦ è½¯ä»¶åŒ…å¯ç”¨æ€§æ£€æŸ¥\n\n| è½¯ä»¶åŒ… | çŠ¶æ€ | ä½ç½® | å¤‡æ³¨ |\n|--------|------|------|------|\n' \
            "${{ inputs.config }}" \
            "$(date)" \
            "${{ inputs.chip }}" "${{ inputs.branch }}" "${{ inputs.config }}" \
            "$TOTAL_PACKAGES" > luci-final-check-${{ inputs.config }}.md
          
          # æ£€æŸ¥è½¯ä»¶åŒ…å¯ç”¨æ€§
          MISSING_COUNT=0
          FOUND_COUNT=0
          MISSING_PACKAGES=""
          
          for pkg in $LUCI_PACKAGES; do
            if [ -d "package/feeds/packages/$pkg" ]; then
              echo "âœ… $pkg - å¯ç”¨ (packages)"
              printf '| %s | âœ… å¯ç”¨ | packages | - |\n' "$pkg" >> luci-final-check-${{ inputs.config }}.md
              ((FOUND_COUNT++))
            elif [ -d "package/feeds/luci/$pkg" ]; then
              echo "âœ… $pkg - å¯ç”¨ (luci)"
              printf '| %s | âœ… å¯ç”¨ | luci | - |\n' "$pkg" >> luci-final-check-${{ inputs.config }}.md
              ((FOUND_COUNT++))
            elif [ -d "package/$pkg" ]; then
              echo "âœ… $pkg - å¯ç”¨ (local)"
              printf '| %s | âœ… å¯ç”¨ | local | - |\n' "$pkg" >> luci-final-check-${{ inputs.config }}.md
              ((FOUND_COUNT++))
            else
              echo "âŒ $pkg - ç¼ºå¤±"
              printf '| %s | âŒ ç¼ºå¤± | - | éœ€è¦ä¿®å¤ |\n' "$pkg" >> luci-final-check-${{ inputs.config }}.md
              ((MISSING_COUNT++))
              MISSING_PACKAGES="$MISSING_PACKAGES $pkg"
            fi
          done
          
          # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
          printf '\n## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯\n\n- æ€»è½¯ä»¶åŒ…æ•°: %d\n- æ‰¾åˆ°è½¯ä»¶åŒ…: %d\n- ç¼ºå¤±è½¯ä»¶åŒ…: %d\n- æˆåŠŸç‡: %d%%\n' \
            "$TOTAL_PACKAGES" "$FOUND_COUNT" "$MISSING_COUNT" "$(( FOUND_COUNT * 100 / TOTAL_PACKAGES ))" >> luci-final-check-${{ inputs.config }}.md
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo ""
            echo "ğŸš¨ å‘ç° $MISSING_COUNT ä¸ªç¼ºå¤±çš„LUCIè½¯ä»¶åŒ…ï¼"
            echo "ğŸ“¦ ç¼ºå¤±åˆ—è¡¨:$MISSING_PACKAGES"
            echo ""
            echo "ğŸ”§ å°è¯•è‡ªåŠ¨ä¿®å¤..."
            
            # å°è¯•è‡ªåŠ¨ä¿®å¤
            REPAIRED_COUNT=0
            for pkg in $MISSING_PACKAGES; do
              echo "ğŸ” ä¿®å¤è½¯ä»¶åŒ…: $pkg"
              
              # å°è¯•æŸ¥æ‰¾ç›¸ä¼¼çš„è½¯ä»¶åŒ…å
              SIMILAR=$(find package/feeds -name "*$(echo $pkg | tr '-' '\n' | head -1)*" -type d 2>/dev/null | head -5)
              if [ -n "$SIMILAR" ]; then
                echo "  ğŸ’¡ æ‰¾åˆ°ç›¸ä¼¼çš„è½¯ä»¶åŒ…:"
                echo "$SIMILAR" | sed 's/^/    /'
              fi
              
              # å°è¯•é‡æ–°å®‰è£…feeds
              echo "  ğŸ”„ å°è¯•é‡æ–°å®‰è£…feeds..."
              if ./scripts/feeds install $pkg 2>/dev/null; then
                echo "  âœ… æˆåŠŸå®‰è£…: $pkg"
                ((REPAIRED_COUNT++))
              else
                echo "  âŒ æ— æ³•å®‰è£…: $pkg"
                
                # å°è¯•æŸ¥æ‰¾è½¯ä»¶åŒ…å®šä¹‰
                PKG_FOUND=$(find . -name "Makefile" -exec grep -l "Package/$pkg" {} \; 2>/dev/null | head -3)
                if [ -n "$PKG_FOUND" ]; then
                  echo "  ğŸ“„ è½¯ä»¶åŒ…å®šä¹‰ä½ç½®:"
                  echo "$PKG_FOUND" | sed 's/^/    /'
                fi
              fi
            done
            
            # ç¬¬ä¸‰æ¬¡ make defconfig - ä¿®å¤åæ›´æ–°é…ç½®
            if [ $REPAIRED_COUNT -gt 0 ]; then
              echo ""
              echo "ğŸ”§ ç¬¬ä¸‰æ¬¡ make defconfig - ä¿®å¤åæ›´æ–°é…ç½®..."
              make defconfig
              
              # æœ€ç»ˆæ£€æŸ¥
              echo ""
              echo "ğŸ” ==================== æœ€ç»ˆLUCIè½¯ä»¶åŒ…ä¿®å¤æ£€æŸ¥ ===================="
              FINAL_MISSING_COUNT=0
              for pkg in $MISSING_PACKAGES; do
                if [ -d "package/feeds/packages/$pkg" ] || [ -d "package/feeds/luci/$pkg" ] || [ -d "package/$pkg" ]; then
                  echo "âœ… $pkg - å·²ä¿®å¤"
                else
                  echo "âŒ $pkg - ä»ç„¶ç¼ºå¤±"
                  ((FINAL_MISSING_COUNT++))
                fi
              done
              
              # æ›´æ–°æŠ¥å‘Š
              printf '\n## ğŸ”§ è‡ªåŠ¨ä¿®å¤ç»“æœ\n\n- å°è¯•ä¿®å¤: %d\n- æˆåŠŸä¿®å¤: %d\n- ä»ç„¶ç¼ºå¤±: %d\n' \
                "$MISSING_COUNT" "$REPAIRED_COUNT" "$FINAL_MISSING_COUNT" >> luci-final-check-${{ inputs.config }}.md
              
              if [ $FINAL_MISSING_COUNT -gt 0 ]; then
                echo ""
                echo "âŒ ä»æœ‰ $FINAL_MISSING_COUNT ä¸ªè½¯ä»¶åŒ…æ— æ³•ä¿®å¤"
                echo "ğŸš¨ æœ€ç»ˆç¼–è¯‘å°†åœæ­¢ï¼Œè¯·æ£€æŸ¥è½¯ä»¶åŒ…åç§°æˆ–æºç "
                
                # åˆ—å‡ºä»ç„¶ç¼ºå¤±çš„è½¯ä»¶åŒ…
                echo ""
                echo "ğŸ“‹ ä»ç„¶ç¼ºå¤±çš„è½¯ä»¶åŒ…:"
                for pkg in $MISSING_PACKAGES; do
                  if [ ! -d "package/feeds/packages/$pkg" ] && [ ! -d "package/feeds/luci/$pkg" ] && [ ! -d "package/$pkg" ]; then
                    echo "  - $pkg"
                  fi
                done
                
                exit 1
              else
                echo ""
                echo "âœ… æ‰€æœ‰LUCIè½¯ä»¶åŒ…å·²æˆåŠŸä¿®å¤ï¼"
              fi
            else
              echo ""
              echo "âŒ è‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼Œæ— æ³•ä¿®å¤ä»»ä½•è½¯ä»¶åŒ…"
              echo "ğŸš¨ æœ€ç»ˆç¼–è¯‘å°†åœæ­¢"
              exit 1
            fi
          else
            echo ""
            echo "âœ… æ‰€æœ‰ $TOTAL_PACKAGES ä¸ªLUCIè½¯ä»¶åŒ…æ£€æŸ¥é€šè¿‡ï¼"
          fi
          
          # è¾“å‡ºæŠ¥å‘Š
          echo ""
          echo "ğŸ“„ æœ€ç»ˆæ£€æŸ¥æŠ¥å‘Š:"
          cat luci-final-check-${{ inputs.config }}.md

      - name: ğŸš€ ç¼–è¯‘å›ºä»¶
        id: build
        run: |
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          cd openwrt-build
          
          # è®¾ç½®ç¼–è¯‘å‚æ•°
          echo "ğŸ”¨ ä½¿ç”¨ $(nproc) ä¸ªæ ¸å¿ƒå¹¶è¡Œç¼–è¯‘"
          
          # å°è¯•å¹¶è¡Œç¼–è¯‘
          if ! make -j$(nproc) IGNORE_ERRORS=1; then
            echo "âš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            make -j1 V=s
          fi
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          if [ -d "bin/targets" ] && [ "$(ls -A bin/targets)" ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸ"
            echo "ğŸ“¦ ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶:"
            find bin/targets -name "*.bin" -type f -exec ls -lh {} \;
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ğŸ“¦ æ”¶é›†ç¼–è¯‘äº§ç‰©
        run: |
          echo "ğŸ“¦ æ”¶é›†ç¼–è¯‘äº§ç‰©..."
          mkdir -p artifacts
          
          # å¤åˆ¶å›ºä»¶æ–‡ä»¶
          echo "ğŸ“‚ æ”¶é›†å›ºä»¶æ–‡ä»¶..."
          find openwrt-build/bin/targets -name "*.bin" -type f -exec cp {} artifacts/ \;
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          echo "ğŸ“‚ æ”¶é›†é…ç½®æ–‡ä»¶..."
          cp openwrt-build/.config artifacts/config-${{ inputs.chip }}-${{ inputs.branch }}-${{ inputs.config }}.config
          find openwrt-build/bin/targets -name "*.manifest" -type f -exec cp {} artifacts/ \;
          find openwrt-build/bin/targets -name "config.buildinfo" -type f -exec cp {} artifacts/ \;
          
          # å¤åˆ¶è½¯ä»¶åŒ…
          echo "ğŸ“‚ æ”¶é›†è½¯ä»¶åŒ…..."
          mkdir -p artifacts/packages
          find openwrt-build/bin/packages -name "*.ipk" -type f -exec cp {} artifacts/packages/ \;
          
          # å¤åˆ¶æ‰€æœ‰æŠ¥å‘Š
          echo "ğŸ“‚ æ”¶é›†æŠ¥å‘Šæ–‡ä»¶..."
          cp openwrt-build/luci-*.md artifacts/ 2>/dev/null || true
          cp luci-*.md artifacts/ 2>/dev/null || true
          
          # ç”Ÿæˆæ–‡ä»¶æ¸…å•
          echo "ğŸ“‹ ç”Ÿæˆæ–‡ä»¶æ¸…å•..."
          ls -la artifacts/ > artifacts/filelist.txt
          echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆ"
          echo "ğŸ“Š äº§ç‰©ç»Ÿè®¡:"
          echo "  - å›ºä»¶æ–‡ä»¶: $(find artifacts -name '*.bin' | wc -l)"
          echo "  - è½¯ä»¶åŒ…: $(find artifacts/packages -name '*.ipk' | wc -l)"
          echo "  - é…ç½®æ–‡ä»¶: $(find artifacts -name '*.config' | wc -l)"
          echo "  - æŠ¥å‘Šæ–‡ä»¶: $(find artifacts -name '*.md' | wc -l)"

      - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.chip }}-${{ inputs.branch }}-${{ inputs.config }}-${{ github.run_id }}
          path: artifacts/
          retention-days: 7
          if-no-files-found: error
