# .github/workflows/dispatch.yml
name: ğŸš€ è°ƒåº¦ä¸­å¿ƒ

on:
  # åŒ—äº¬æ—¶é—´æ¯å‘¨äº”0ç‚¹ (UTC+8 = UTCå‘¨å››16:00) è‡ªåŠ¨è§¦å‘
  schedule:
    - cron: '0 16 * * 4'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      os_version:
        description: 'é€‰æ‹©æ“ä½œç³»ç»Ÿç‰ˆæœ¬'
        required: true
        default: 'ubuntu-22.04'
        type: choice
        options:
          - ubuntu-22.04
          - ubuntu-24.04

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  CHIPSET: ipq60xx
  BRANCH: immwrt
  # å®šä¹‰è¾“å‡ºé¢œè‰²å’Œå›¾æ ‡
  COLOR_ERROR: '\033[1;31m'
  COLOR_WARN: '\033[1;33m'
  COLOR_INFO: '\033[1;36m'
  COLOR_SUCCESS: '\033[1;32m'
  COLOR_RESET: '\033[0m'
  ICON_ERROR: 'âŒ'
  ICON_WARN: 'âš ï¸'
  ICON_INFO: 'â„¹ï¸'
  ICON_SUCCESS: 'âœ…'

jobs:
  # ä½œä¸š1: å‡†å¤‡å·¥ä½œ
  # ç”Ÿæˆç¼“å­˜å“ˆå¸Œã€æå–è®¾å¤‡åˆ—è¡¨ç­‰ï¼Œä¾›åç»­ä½œä¸šä½¿ç”¨
  setup:
    name: ğŸ“‹ å‡†å¤‡å·¥ä½œ
    runs-on: ubuntu-latest
    outputs:
      # è¾“å‡ºå“ˆå¸Œå€¼ï¼Œä¾›æ‰€æœ‰æ„å»ºä½œä¸šä½¿ç”¨
      hashes-value: ${{ steps.generate-hashes.outputs.hashes-value }}
      # è¾“å‡ºè®¾å¤‡åˆ—è¡¨ï¼Œä¾›æ„å»ºå’Œå‘å¸ƒä½œä¸šä½¿ç”¨
      devices: ${{ steps.get-devices.outputs.devices }}
      # è¾“å‡ºå†…æ ¸ç‰ˆæœ¬ï¼Œä¾›å‘å¸ƒä½œä¸šä½¿ç”¨
      kernel-version: ${{ steps.get-kernel.outputs.kernel-version }}
    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”‘ ç”Ÿæˆå“ˆå¸Œæ–‡ä»¶
        id: generate-hashes
        run: |
          set -euo pipefail
          HASH_FILES=(
            "configs/base_${{ env.CHIPSET }}.config"
            "configs/base_${{ env.BRANCH }}.config"
            "scripts/diy.sh"
            "scripts/repo.sh"
          )
          for file in "${HASH_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo -e "${{ env.COLOR_ERROR}}${{ env.ICON_ERROR}} é”™è¯¯: æ–‡ä»¶ $file ä¸å­˜åœ¨ï¼${{ env.COLOR_RESET}}"
              exit 1
            fi
          done
          HASH_VALUE=$(cat "${HASH_FILES[@]}" | sha256sum | cut -d' ' -f1)
          echo "hashes-value=$HASH_VALUE" >> $GITHUB_OUTPUT
          echo -e "${{ env.COLOR_SUCCESS}}${{ env.ICON_SUCCESS}} ç¼“å­˜å“ˆå¸Œå€¼: $HASH_VALUE${{ env.COLOR_RESET}}"

      - name: ğŸ” æå–è®¾å¤‡åˆ—è¡¨
        id: get-devices
        run: |
          set -euo pipefail
          DEVICES=$(grep -oE 'CONFIG_TARGET_DEVICE_.*_DEVICE_(.*)=y' "configs/base_${{ env.CHIPSET }}.config" | sed -E 's/CONFIG_TARGET_DEVICE_.*_DEVICE_(.*)=y/\1/' | tr '\n' ' ')
          echo "devices=$DEVICES" >> $GITHUB_OUTPUT
          echo -e "${{ env.COLOR_SUCCESS}}${{ env.ICON_SUCCESS}} å‘ç°è®¾å¤‡: $DEVICES${{ env.COLOR_RESET}}"
          
      - name: ğŸ” è·å–å†…æ ¸ç‰ˆæœ¬ (éœ€è¦å…ˆå…‹éš†æºç )
        id: get-kernel
        run: |
          set -euo pipefail
          git clone --depth=1 https://github.com/immortalwrt/immortalwrt
          cd immortalwrt
          # ä¸´æ—¶ç”Ÿæˆä¸€ä¸ªæœ€å°é…ç½®æ¥è·å–å†…æ ¸ç‰ˆæœ¬
          echo "CONFIG_TARGET_${{ env.CHIPSET }}=y" > .config
          KERNEL_VERSION=$(make kernelconfig | grep -oP 'CONFIG_KERNEL_\K[0-9]+\.[0-9]+\.[0-9]+' | head -n 1)
          echo "kernel-version=$KERNEL_VERSION" >> $GITHUB_OUTPUT
          echo -e "${{ env.COLOR_SUCCESS}}${{ env.ICON_SUCCESS}} å†…æ ¸ç‰ˆæœ¬: $KERNEL_VERSION${{ env.COLOR_RESET}}"

  # ä½œä¸š2: å¹¶è¡Œæ„å»ºå›ºä»¶
  # ä½¿ç”¨çŸ©é˜µç­–ç•¥ï¼Œä¸ºæ¯ä¸ªé…ç½®è°ƒç”¨å¯å¤ç”¨æ„å»ºå·¥ä½œæµ
  build-firmware:
    name: ğŸ—ï¸ æ„å»º ${{ matrix.profile }} é…ç½®
    needs: setup
    strategy:
      fail-fast: false # ä¸€ä¸ªé…ç½®å¤±è´¥ï¼Œå…¶ä»–é…ç½®ç»§ç»­
      matrix:
        profile: [Pro, Max, Ultra]
    uses: ./.github/workflows/reusable_builder.yml
    with:
      os_version: ${{ inputs.os_version || 'ubuntu-22.04' }}
      chipset: ${{ env.CHIPSET }}
      branch: ${{ env.BRANCH }}
      profile: ${{ matrix.profile }}
      hashes-value: ${{ needs.setup.outputs.hashes-value }}
      devices: ${{ needs.setup.outputs.devices }}
    secrets: inherit

  # ä½œä¸š3: å‘å¸ƒ Release
  # åœ¨æ‰€æœ‰æ„å»ºä½œä¸šå®Œæˆåï¼Œæ”¶é›†äº§ç‰©å¹¶å‘å¸ƒ
  release:
    name: ğŸš€ å‘å¸ƒ Release
    # needs æ‰€æœ‰æ„å»ºä½œä¸šéƒ½å®Œæˆ (æ— è®ºæˆåŠŸå¤±è´¥)ï¼Œå¹¶ä¸” setup ä½œä¸šæˆåŠŸ
    if: always() && needs.setup.result == 'success'
    needs: [setup, build-firmware]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      releases: write
    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts
          merge-multiple: true

      - name: ğŸ“¦ æ‰“åŒ…æœ€ç»ˆäº§ç‰©
        run: |
          set -euo pipefail
          mkdir -p release_assets
          # æ‰“åŒ…é…ç½®æ–‡ä»¶
          tar -czvf release_assets/${{ env.CHIPSET }}-config.tar.gz -C all_artifacts config/
          # æ‰“åŒ…è½¯ä»¶åŒ…
          tar -czvf release_assets/${{ env.CHIPSET }}-app.tar.gz -C all_artifacts packages/
          # æ‰“åŒ…æ—¥å¿—
          tar -czvf release_assets/${{ env.CHIPSET }}-log.tar.gz -C all_artifacts logs/
          # å¤åˆ¶å›ºä»¶
          cp -r all_artifacts/firmware/* release_assets/
          
          # ç”Ÿæˆ LuCI åº”ç”¨åˆ—è¡¨
          tar -tzf release_assets/${{ env.CHIPSET }}-app.tar.gz | grep luci-app | sed 's/.*\///' | sort | uniq > release_assets/luci_apps_list.txt

      - name: ğŸš€ å‘å¸ƒåˆ° GitHub Release
        # åªæœ‰å½“æ‰€æœ‰æ„å»ºä»»åŠ¡éƒ½æˆåŠŸæ—¶æ‰å‘å¸ƒ
        if: needs.build-firmware.result == 'success'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.CHIPSET }}-${{ github.run_number }}-${{ github.sha }}
          body: |
            ## ğŸ‰ ImmortalWrt ${{ env.CHIPSET }} å›ºä»¶å‘å¸ƒ
            - **ä½œè€…**: Mary
            - **å‘å¸ƒæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            - **æºç åˆ†æ”¯**: ${{ env.BRANCH }}
            - **ç¼–è¯‘é…ç½®**: Pro, Max, Ultra
            - **å†…æ ¸ç‰ˆæœ¬**: ${{ needs.setup.outputs.kernel-version }}
            
            ---
            
            ## ğŸ“‹ å›ºä»¶ä¿¡æ¯
            - **é»˜è®¤ç®¡ç†åœ°å€**: 192.168.111.1
            - **é»˜è®¤ç”¨æˆ·**: root
            - **é»˜è®¤å¯†ç **: æ—  (ç›´æ¥å›è½¦)
            - **é»˜è®¤WIFIå¯†ç **: 12345678
            
            ---
            
            ## ğŸ“¦ åŒ…å«çš„ LuCI åº”ç”¨åˆ—è¡¨
            $(cat release_assets/luci_apps_list.txt)
            
            ---
            
            ## â¬‡ï¸ ä¸‹è½½è¯´æ˜
            è¯·æ ¹æ®æ‚¨çš„è®¾å¤‡å‹å·å’Œæ‰€éœ€é…ç½®ä¸‹è½½å¯¹åº”çš„å›ºä»¶æ–‡ä»¶ã€‚
            - `immwrt-<è®¾å¤‡å>-<factory/sysupgrade>-<Pro/Max/Ultra>.bin` æ˜¯å›ºä»¶æ–‡ä»¶ã€‚
            - `${{ env.CHIPSET }}-config.tar.gz` åŒ…å«æ‰€æœ‰é…ç½®ã€æ¸…å•å’Œæ„å»ºä¿¡æ¯ã€‚
            - `${{ env.CHIPSET }}-app.tar.gz` åŒ…å«æ‰€æœ‰ç¼–è¯‘å‡ºçš„è½¯ä»¶åŒ…ã€‚
            - `${{ env.CHIPSET }}-log.tar.gz` åŒ…å«æœ¬æ¬¡ç¼–è¯‘çš„è¯¦ç»†æ—¥å¿—ã€‚

          files: |
            release_assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
