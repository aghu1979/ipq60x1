name: Build Packages

on:
  workflow_call:
    inputs:
      build_all:
        description: 'æ˜¯å¦ä¸ºæ‰€æœ‰æ ¸å¿ƒç³»ç»Ÿç¼–è¯‘'
        required: true
        default: true
        type: boolean
      core-artifact:
        description: 'æ ¸å¿ƒç³»ç»ŸArtifactåç§°ï¼ˆå½“build_allä¸ºfalseæ—¶å¿…éœ€ï¼‰'
        required: false
        type: string
      package:
        description: 'è½¯ä»¶åŒ…é…ç½®'
        required: true
        default: 'Pro'
        type: string
      core-map:
        description: 'æ ¸å¿ƒç³»ç»Ÿæ˜ å°„æ–‡ä»¶åç§°ï¼ˆå¯é€‰ï¼Œç”¨äºæ‰¹é‡ç¼–è¯‘ï¼‰'
        required: false
        type: string
  workflow_dispatch:
    inputs:
      build_all:
        description: 'æ˜¯å¦ä¸ºæ‰€æœ‰æ ¸å¿ƒç³»ç»Ÿç¼–è¯‘'
        required: true
        default: true
        type: boolean
      core-artifact:
        description: 'æ ¸å¿ƒç³»ç»ŸArtifactåç§°ï¼ˆå½“build_allä¸ºfalseæ—¶å¿…éœ€ï¼‰'
        required: false
      package:
        description: 'è½¯ä»¶åŒ…é…ç½®'
        required: true
        default: 'Pro'
        type: choice
        options:
          - Pro
          - Max
          - Ultra
      core-map:
        description: 'æ ¸å¿ƒç³»ç»Ÿæ˜ å°„æ–‡ä»¶åç§°ï¼ˆå¯é€‰ï¼Œç”¨äºæ‰¹é‡ç¼–è¯‘ï¼‰'
        required: false

jobs:
  # ä¸‹è½½æ ¸å¿ƒç³»ç»Ÿæ˜ å°„å¹¶ç”Ÿæˆä»»åŠ¡çŸ©é˜µ
  generate-package-matrix:
    runs-on: ubuntu-latest
    if: inputs.build_all == 'true' && inputs.core_map != ''
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: ğŸ“¥ ä¸‹è½½æ˜ å°„æ–‡ä»¶
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.core_map }}
          path: ./

      - name: ğŸ“¦ ç”Ÿæˆè½¯ä»¶åŒ…ç¼–è¯‘çŸ©é˜µ
        id: set-matrix
        run: |
          # ä»æ˜ å°„æ–‡ä»¶ç”ŸæˆçŸ©é˜µ
          matrix=$(jq -c 'to_entries | map({core: .key, artifact: .value, package: "${{ inputs.package }}"})' core-map.json)
          
          echo "matrix=$matrix" >> $GITHUB_OUTPUT
          echo "Generated matrix: $matrix"

  # å•ä¸ªæ ¸å¿ƒç³»ç»Ÿç¼–è¯‘
  build-single-package:
    runs-on: ubuntu-latest
    if: inputs.build_all == 'false'
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ ä¸‹è½½æ ¸å¿ƒç³»ç»Ÿ
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.core-artifact }}
          path: core-system

      - name: ğŸ”§ ç¼–è¯‘è½¯ä»¶åŒ…
        run: |
          # æ‰§è¡Œè½¯ä»¶åŒ…ç¼–è¯‘è„šæœ¬
          chmod +x scripts/build-packages.sh
          ./scripts/build-packages.sh \
            --package "${{ inputs.package }}" \
            --core-path "core-system"

      - name: ğŸ“¤ ä¸Šä¼ å›ºä»¶
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ inputs.package }}-${{ github.run_id }}
          path: |
            firmware/
            reports/
          retention-days: 7

  # æ‰¹é‡ç¼–è¯‘æ‰€æœ‰æ ¸å¿ƒç³»ç»Ÿ
  build-all-packages:
    needs: generate-package-matrix
    runs-on: ubuntu-latest
    if: inputs.build_all == 'true' && inputs.core_map != ''
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-package-matrix.outputs.matrix) }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ ä¸‹è½½æ ¸å¿ƒç³»ç»Ÿ
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: core-system

      - name: ğŸ”§ ç¼–è¯‘è½¯ä»¶åŒ…
        run: |
          # æ‰§è¡Œè½¯ä»¶åŒ…ç¼–è¯‘è„šæœ¬
          chmod +x scripts/build-packages.sh
          ./scripts/build-packages.sh \
            --package "${{ matrix.package }}" \
            --core-path "core-system"

      - name: ğŸ“¤ ä¸Šä¼ å›ºä»¶
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.core }}-${{ matrix.package }}-${{ github.run_id }}
          path: |
            firmware/
            reports/
          retention-days: 7

  # ä¸ºæ²¡æœ‰æ˜ å°„æ–‡ä»¶çš„æƒ…å†µæä¾›å¤‡é€‰æ–¹æ¡ˆ
  build-packages-without-map:
    runs-on: ubuntu-latest
    if: inputs.build_all == 'true' && (inputs.core_map == '' || needs.generate-package-matrix.result == 'failure')
    strategy:
      fail-fast: false
      matrix:
        chip: [ipq60xx]
        # chip: [ipq60xx, ipq80xx]  # æœªæ¥æ‰©å±•æ—¶å–æ¶ˆæ³¨é‡Š
        branch: [openwrt, immwrt, libwrt]
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ ä¸‹è½½æ ¸å¿ƒç³»ç»Ÿ
        uses: actions/download-artifact@v4
        with:
          name: core-${{ matrix.chip }}-${{ matrix.branch }}-${{ github.run_id }}
          path: core-system

      - name: ğŸ”§ ç¼–è¯‘è½¯ä»¶åŒ…
        run: |
          # æ‰§è¡Œè½¯ä»¶åŒ…ç¼–è¯‘è„šæœ¬
          chmod +x scripts/build-packages.sh
          ./scripts/build-packages.sh \
            --package "${{ inputs.package }}" \
            --core-path "core-system"

      - name: ğŸ“¤ ä¸Šä¼ å›ºä»¶
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.chip }}-${{ matrix.branch }}-${{ matrix.package }}-${{ github.run_id }}
          path: |
            firmware/
            reports/
          retention-days: 7
