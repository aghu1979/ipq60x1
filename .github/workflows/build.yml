name: Multi-Config OpenWrt Build

on:
  workflow_dispatch:
    inputs:
      branch:
        description: '选择要编译的分支'
        required: true
        default: 'immwrt'
        type: choice
        options:
          - immwrt
          # - openwrt  # 未来可轻松添加
          # - libwrt   # 未来可轻松添加
      config:
        description: '选择要编译的配置'
        required: true
        default: 'Pro'
        type: choice
        options:
          - Pro
          - Max
          - Ultra
          - All

env:
  # 这些环境变量可以在所有步骤中引用
  DIY_P1_SH: .github/scripts/diy.sh
  DIY_P2_SH: .github/scripts/repo.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  TZ: Asia/Shanghai

jobs:
  build:
    # 【关键修正】使用 if 条件来精确控制哪个矩阵作业应该运行
    # 这个条件会根据用户的手动输入来过滤矩阵中定义的作业
    if: >
      (github.event.inputs.config == 'All' || matrix.config == github.event.inputs.config) &&
      (github.event.inputs.branch == matrix.branch)
    
    runs-on: ubuntu-22.04
    
    # 【关键修正】合并所有矩阵项到一个 include 列表中
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- ImmortalWrt 分支的所有配置 ---
          - branch: 'immwrt'
            config: 'Pro'
            REPO_URL: 'https://github.com/laipeng668/immortalwrt.git'
            REPO_BRANCH: 'master'
            REPO_SHORT: 'immwrt'
          - branch: 'immwrt'
            config: 'Max'
            REPO_URL: 'https://github.com/laipeng668/immortalwrt.git'
            REPO_BRANCH: 'master'
            REPO_SHORT: 'immwrt'
          - branch: 'immwrt'
            config: 'Ultra'
            REPO_URL: 'https://github.com/laipeng668/immortalwrt.git'
            REPO_BRANCH: 'master'
            REPO_SHORT: 'immwrt'
          
          # --- 未来扩展：在此处添加其他分支的所有配置 ---
          # --- OpenWrt 分支 ---
          # - branch: 'openwrt'
          #   config: 'Pro'
          #   REPO_URL: 'https://github.com/openwrt/openwrt.git'
          #   REPO_BRANCH: 'main'
          #   REPO_SHORT: 'openwrt'
          # - branch: 'openwrt'
          #   config: 'Max'
          #   REPO_URL: 'https://github.com/openwrt/openwrt.git'
          #   REPO_BRANCH: 'main'
          #   REPO_SHORT: 'openwrt'
          # - branch: 'openwrt'
          #   config: 'Ultra'
          #   REPO_URL: 'https://github.com/openwrt/openwrt.git'
          #   REPO_BRANCH: 'main'
          #   REPO_SHORT: 'openwrt'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialization Environment
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2204)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      # 核心：分层缓存 - 第一层 (基础环境)
      - name: Cache Base Environment
        id: cache-base
        uses: actions/cache@v4
        with:
          path: |
            openwrt/toolchain
            openwrt/dl
          # 【关键修正】缓存键需要精确匹配基础配置文件
          key: ${{ runner.os }}-base-${{ matrix.REPO_SHORT }}-${{ hashFiles('**/base_ipq60xx.config', '**/base_immwrt.config', '**/base_openwrt.config', '**/base_libwrt.config') }}
          restore-keys: |
            ${{ runner.os }}-base-${{ matrix.REPO_SHORT }}-

      - name: Clone Source Code
        run: |
          df -hT $PWD
          git clone ${{ matrix.REPO_URL }} -b ${{ matrix.REPO_BRANCH }} openwrt
          cd openwrt
          git log -1 --pretty=format:"%h %s"

      - name: Load Custom Feeds & Scripts
        run: |
          [ -e $DIY_P1_SH ] && chmod +x $DIY_P1_SH && cd openwrt && $GITHUB_WORKSPACE/$DIY_P1_SH
          [ -e $DIY_P2_SH ] && chmod +x $DIY_P2_SH && cd openwrt && $GITHUB_WORKSPACE/$DIY_P2_SH

      - name: Generate Configuration File
        run: |
          cd openwrt
          echo "Generating .config for ${{ matrix.config }} on ${{ matrix.REPO_SHORT }}"
          # 1. 合并配置文件
          cat $GITHUB_WORKSPACE/.github/configs/base_ipq60xx.config >> .config
          cat $GITHUB_WORKSPACE/.github/configs/base_${{ matrix.REPO_SHORT }}.config >> .config
          cat $GITHUB_WORKSPACE/.github/configs/${{ matrix.config }}.config >> .config
          
          # 2. 【关键】使用 defconfig 处理依赖
          make defconfig
          
          # 3. (可选) 打印最终配置用于调试
          # cat .config

      - name: Download Packages
        id: download
        run: |
          cd openwrt
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile Firmware
        id: compile
        run: |
          cd openwrt
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
          [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
        with:
          name: ${{ matrix.REPO_SHORT }}_${{ matrix.config }}_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: |
            openwrt/bin/targets/*/*
            !openwrt/bin/targets/*/*.manifest
            !openwrt/bin/targets/*/*.json
          retention-days: 30
