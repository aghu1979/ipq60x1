name: OpenWrt Multi-Config Build

on:
  workflow_dispatch:
    inputs:
      ubuntu_version:
        description: 'é€‰æ‹©Ubuntuç‰ˆæœ¬'
        required: true
        default: 'ubuntu-22.04'
        type: choice
        options:
          - ubuntu-22.04
          - ubuntu-24.04
      target_arch:
        description: 'ç›®æ ‡èŠ¯ç‰‡æž¶æž„'
        required: true
        default: 'ipq60xx'
        type: choice
        options:
          - ipq60xx
          - ipq80xx
          - mtk
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯å‘¨äº”0ç‚¹ (UTCæ—¶é—´å‘¨å››16ç‚¹)
    - cron: '0 16 * * 4'

env:
  # å®šä¹‰å…¨å±€å˜é‡
  TZ: Asia/Shanghai
  REPO_URL: https://github.com/laipeng668/immortalwrt.git
  REPO_BRANCH: master
  # å®šä¹‰é¢œè‰²å’Œå›¾æ ‡
  COLOR_GREEN: '\033[0;32m'
  COLOR_RED: '\033[0;31m'
  COLOR_YELLOW: '\033[0;33m'
  COLOR_BLUE: '\033[0;34m'
  COLOR_PURPLE: '\033[0;35m'
  COLOR_CYAN: '\033[0;36m'
  COLOR_RESET: '\033[0m'
  ICON_START: 'ðŸš€'
  ICON_SUCCESS: 'âœ…'
  ICON_ERROR: 'âŒ'
  ICON_WARNING: 'âš ï¸'
  ICON_INFO: 'â„¹ï¸'
  ICON_PACKAGE: 'ðŸ“¦'
  ICON_CONFIG: 'âš™ï¸'

jobs:
  # å‡†å¤‡é˜¶æ®µï¼šè®¾ç½®åŸºç¡€çŽ¯å¢ƒ
  setup:
    runs-on: ${{ inputs.ubuntu_version || 'ubuntu-22.04' }}
    outputs:
      target_arch: ${{ steps.setup.outputs.target_arch }}
      cache_key: ${{ steps.setup.outputs.cache_key }}
      device_list: ${{ steps.setup.outputs.device_list }}
      base_configs: ${{ steps.setup.outputs.base_configs }}
      user_configs: ${{ steps.setup.outputs.user_configs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        id: setup
        run: |
          # è¾“å‡ºå¼€å§‹ä¿¡æ¯
          echo -e "${{ env.COLOR_CYAN }}${{ env.ICON_START }} å¼€å§‹è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒ${{ env.COLOR_RESET }}"
          
          # è®¾ç½®ç›®æ ‡æž¶æž„
          TARGET_ARCH="${{ inputs.target_arch || 'ipq60xx' }}"
          echo "target_arch=$TARGET_ARCH" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆç¼“å­˜é”®
          CACHE_KEY="openwrt-${TARGET_ARCH}-$(date +%Y%m%d)"
          echo "cache_key=$CACHE_KEY" >> $GITHUB_OUTPUT
          
          # èŽ·å–åŸºç¡€é…ç½®åˆ—è¡¨
          BASE_CONFIGS=$(ls configs/base_*.config | xargs -n 1 basename | sed 's/.config$//' | tr '\n' ' ')
          echo "base_configs=$BASE_CONFIGS" >> $GITHUB_OUTPUT
          
          # èŽ·å–ç”¨æˆ·é…ç½®åˆ—è¡¨
          USER_CONFIGS=$(ls configs/[Pp]ro.config configs/[Mm]ax.config configs/[Uu]ltra.config 2>/dev/null | xargs -n 1 basename | sed 's/.config$//' | tr '\n' ' ')
          echo "user_configs=$USER_CONFIGS" >> $GITHUB_OUTPUT
          
          # ä»ŽåŸºç¡€é…ç½®ä¸­æå–è®¾å¤‡åˆ—è¡¨
          DEVICE_LIST=$(grep -o 'CONFIG_TARGET_DEVICE_.*_DEVICE_.*=y' configs/base_${TARGET_ARCH}.config | sed 's/CONFIG_TARGET_DEVICE_.*_DEVICE_//g' | sed 's/=y//g' | tr '\n' ' ')
          echo "device_list=$DEVICE_LIST" >> $GITHUB_OUTPUT
          
          # è¾“å‡ºæ‘˜è¦ä¿¡æ¯
          echo -e "${{ env.COLOR_BLUE }}${{ env.ICON_INFO }} ç›®æ ‡æž¶æž„: $TARGET_ARCH${{ env.COLOR_RESET }}"
          echo -e "${{ env.COLOR_BLUE }}${{ env.ICON_INFO }} åŸºç¡€é…ç½®: $BASE_CONFIGS${{ env.COLOR_RESET }}"
          echo -e "${{ env.COLOR_BLUE }}${{ env.ICON_INFO }} ç”¨æˆ·é…ç½®: $USER_CONFIGS${{ env.COLOR_RESET }}"
          echo -e "${{ env.COLOR_BLUE }}${{ env.ICON_INFO }} è®¾å¤‡åˆ—è¡¨: $DEVICE_LIST${{ env.COLOR_RESET }}"
          echo -e "${{ env.COLOR_BLUE }}${{ env.ICON_INFO }} ç¼“å­˜é”®: $CACHE_KEY${{ env.COLOR_RESET }}"
          
          # è¾“å‡ºç»“æŸä¿¡æ¯
          echo -e "${{ env.COLOR_GREEN }}${{ env.ICON_SUCCESS }} çŽ¯å¢ƒè®¾ç½®å®Œæˆ${{ env.COLOR_RESET }}"

  # åŸºç¡€çŽ¯å¢ƒç¼–è¯‘é˜¶æ®µ
  build-base:
    needs: setup
    runs-on: ${{ inputs.ubuntu_version || 'ubuntu-22.04' }}
    strategy:
      matrix:
        base_config: ${{ fromJson(needs.setup.outputs.base_configs) }}
    outputs:
      base_path: ${{ steps.build.outputs.base_path }}
      cache_hit: ${{ steps.cache.outputs.cache-hit }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialization Environment
        run: |
          # è¾“å‡ºå¼€å§‹ä¿¡æ¯
          echo -e "${{ env.COLOR_CYAN }}${{ env.ICON_START }} å¼€å§‹åˆå§‹åŒ–ç¼–è¯‘çŽ¯å¢ƒ${{ env.COLOR_RESET }}"
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          sudo DEBIAN_FRONTEND=noninteractive apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y $(curl -fsSL is.gd/depends_ubuntu_2204)
          sudo systemctl daemon-reload
          sudo timedatectl set-timezone "$TZ"
          
          # è¾“å‡ºç»“æŸä¿¡æ¯
          echo -e "${{ env.COLOR_GREEN }}${{ env.ICON_SUCCESS }} çŽ¯å¢ƒåˆå§‹åŒ–å®Œæˆ${{ env.COLOR_RESET }}"

      - name: Cache Base Environment
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            openwrt/
            .ccache
            staging_dir
          key: ${{ needs.setup.outputs.cache_key }}-${{ matrix.base_config }}
          restore-keys: |
            ${{ needs.setup.outputs.cache_key }}-
            openwrt-

      - name: Clone Source Code
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          # è¾“å‡ºå¼€å§‹ä¿¡æ¯
          echo -e "${{ env.COLOR_CYAN }}${{ env.ICON_START }} å¼€å§‹å…‹éš†æºä»£ç ${{ env.COLOR_RESET }}"
          
          # åˆ›å»ºå·¥ä½œç›®å½•
          mkdir -p openwrt
          cd openwrt
          
          # å…‹éš†æºä»£ç 
          git clone --depth 1 -b $REPO_BRANCH $REPO_URL .
          
          # è¾“å‡ºç»“æŸä¿¡æ¯
          echo -e "${{ env.COLOR_GREEN }}${{ env.ICON_SUCCESS }} æºä»£ç å…‹éš†å®Œæˆ${{ env.COLOR_RESET }}"

      - name: Load Base Configuration
        id: build
        run: |
          # è¾“å‡ºå¼€å§‹ä¿¡æ¯
          echo -e "${{ env.COLOR_CYAN }}${{ env.ICON_CONFIG }} å¼€å§‹åŠ è½½åŸºç¡€é…ç½®: ${{ matrix.base_config }}${{ env.COLOR_RESET }}"
          
          # è¿›å…¥æºä»£ç ç›®å½•
          cd openwrt
          
          # å¤åˆ¶åŸºç¡€é…ç½®
          cp ../configs/${{ matrix.base_config }}.config .config
          
          # è¿è¡Œè‡ªå®šä¹‰è„šæœ¬
          chmod +x ../scripts/diy.sh
          ../scripts/diy.sh
          
          # æ›´æ–°feeds
          echo -e "${{ env.COLOR_BLUE }}${{ env.ICON_PACKAGE }} æ›´æ–°è½¯ä»¶æº${{ env.COLOR_RESET }}"
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº
          chmod +x ../scripts/repo.sh
          ../scripts/repo.sh
          
          # å†æ¬¡æ›´æ–°feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # ç”Ÿæˆdefconfig
          make defconfig
          
          # è¾“å‡ºé…ç½®ä¿¡æ¯
          echo -e "${{ env.COLOR_BLUE }}${{ env.ICON_INFO }} å½“å‰é…ç½®åŒ…å«çš„è½¯ä»¶åŒ…:${{ env.COLOR_RESET }}"
          grep "CONFIG_PACKAGE_.*=y" .config | head -20
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "base_path=$PWD" >> $GITHUB_OUTPUT
          
          # è¾“å‡ºç»“æŸä¿¡æ¯
          echo -e "${{ env.COLOR_GREEN }}${{ env.ICON_SUCCESS }} åŸºç¡€é…ç½®åŠ è½½å®Œæˆ${{ env.COLOR_RESET }}"

      - name: Download Base Packages
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          # è¾“å‡ºå¼€å§‹ä¿¡æ¯
          echo -e "${{ env.COLOR_CYAN }}${{ env.ICON_PACKAGE }} å¼€å§‹ä¸‹è½½åŸºç¡€è½¯ä»¶åŒ…${{ env.COLOR_RESET }}"
          
          # è¿›å…¥æºä»£ç ç›®å½•
          cd openwrt
          
          # ä¸‹è½½è½¯ä»¶åŒ…
          make download -j$(nproc)
          
          # è¾“å‡ºç»“æŸä¿¡æ¯
          echo -e "${{ env.COLOR_GREEN }}${{ env.ICON_SUCCESS }} åŸºç¡€è½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ${{ env.COLOR_RESET }}"

      - name: Build Base Environment
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          # è¾“å‡ºå¼€å§‹ä¿¡æ¯
          echo -e "${{ env.COLOR_CYAN }}${{ env.ICON_START }} å¼€å§‹æž„å»ºåŸºç¡€çŽ¯å¢ƒ${{ env.COLOR_RESET }}"
          
          # è¿›å…¥æºä»£ç ç›®å½•
          cd openwrt
          
          # æž„å»ºå·¥å…·é“¾
          echo -e "${{ env.COLOR_BLUE }}${{ env.ICON_INFO }} æž„å»ºå·¥å…·é“¾${{ env.COLOR_RESET }}"
          make toolchain/install -j$(nproc) || {
            echo -e "${{ env.COLOR_RED }}${{ env.ICON_ERROR }} å·¥å…·é“¾æž„å»ºå¤±è´¥${{ env.COLOR_RESET }}"
            exit 1
          }
          
          # è¾“å‡ºç»“æŸä¿¡æ¯
          echo -e "${{ env.COLOR_GREEN }}${{ env.ICON_SUCCESS }} åŸºç¡€çŽ¯å¢ƒæž„å»ºå®Œæˆ${{ env.COLOR_RESET }}"

  # å¤šé…ç½®ç¼–è¯‘é˜¶æ®µ
  build-configs:
    needs: [setup, build-base]
    runs-on: ${{ inputs.ubuntu_version || 'ubuntu-22.04' }}
    if: needs.build-base.outputs.cache_hit == 'true' || success()
    strategy:
      matrix:
        base_config: ${{ fromJson(needs.setup.outputs.base_configs) }}
        user_config: ${{ fromJson(needs.setup.outputs.user_configs) }}
        device: ${{ fromJson(needs.setup.outputs.device_list) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore Base Environment
        uses: actions/cache@v4
        with:
          path: |
            openwrt/
            .ccache
            staging_dir
          key: ${{ needs.setup.outputs.cache_key }}-${{ matrix.base_config }}

      - name: Load User Configuration
        run: |
          # è¾“å‡ºå¼€å§‹ä¿¡æ¯
          echo -e "${{ env.COLOR_CYAN }}${{ env.ICON_CONFIG }} å¼€å§‹åŠ è½½ç”¨æˆ·é…ç½®: ${{ matrix.user_config }}${{ env.COLOR_RESET }}"
          
          # è¿›å…¥æºä»£ç ç›®å½•
          cd openwrt
          
          # å¤‡ä»½åŽŸå§‹é…ç½®
          cp .config .config.base
          
          # åˆå¹¶ç”¨æˆ·é…ç½®
          cat ../configs/${{ matrix.user_config }}.config >> .config
          
          # è®¾ç½®ç›®æ ‡è®¾å¤‡
          sed -i "s/CONFIG_TARGET_DEVICE_.*_DEVICE_.*/CONFIG_TARGET_DEVICE_$(cat .config | grep CONFIG_TARGET_BOARD | awk -F '"' '{print $2}')_$(cat .config | grep CONFIG_TARGET_SUBTARGET | awk -F '"' '{print $2}')_DEVICE_${{ matrix.device }}=y/" .config
          
          # è¿è¡Œdefconfig
          make defconfig
          
          # åˆ†æžé…ç½®å·®å¼‚
          echo -e "${{ env.COLOR_BLUE }}${{ env.ICON_INFO }} é…ç½®å·®å¼‚åˆ†æž:${{ env.COLOR_RESET }}"
          diff -u .config.base .config || true
          
          # æ£€æŸ¥luciè½¯ä»¶åŒ…
          echo -e "${{ env.COLOR_BLUE }}${{ env.ICON_PACKAGE }} å½“å‰é…ç½®åŒ…å«çš„luciè½¯ä»¶åŒ…:${{ env.COLOR_RESET }}"
          grep "CONFIG_PACKAGE_luci-.*=y" .config | wc -l
          
          # è¾“å‡ºç»“æŸä¿¡æ¯
          echo -e "${{ env.COLOR_GREEN }}${{ env.ICON_SUCCESS }} ç”¨æˆ·é…ç½®åŠ è½½å®Œæˆ${{ env.COLOR_RESET }}"

      - name: Check Luci Packages
        run: |
          # è¾“å‡ºå¼€å§‹ä¿¡æ¯
          echo -e "${{ env.COLOR_CYAN }}${{ env.ICON_PACKAGE }} å¼€å§‹æ£€æŸ¥luciè½¯ä»¶åŒ…${{ env.COLOR_RESET }}"
          
          # è¿›å…¥æºä»£ç ç›®å½•
          cd openwrt
          
          # èŽ·å–ç”¨æˆ·é…ç½®ä¸­çš„luciè½¯ä»¶åŒ…åˆ—è¡¨
          USER_LUCI=$(grep "CONFIG_PACKAGE_luci-.*=y" ../configs/${{ matrix.user_config }}.config | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g' | tr '\n' ' ')
          
          # èŽ·å–å½“å‰é…ç½®ä¸­çš„luciè½¯ä»¶åŒ…åˆ—è¡¨
          CURRENT_LUCI=$(grep "CONFIG_PACKAGE_luci-.*=y" .config | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g' | tr '\n' ' ')
          
          # æ£€æŸ¥ç¼ºå¤±çš„è½¯ä»¶åŒ…
          MISSING_LUCI=""
          for pkg in $USER_LUCI; do
            if ! echo $CURRENT_LUCI | grep -q $pkg; then
              MISSING_LUCI="$MISSING_LUCI $pkg"
            fi
          done
          
          # è¾“å‡ºæ£€æŸ¥ç»“æžœ
          if [ -n "$MISSING_LUCI" ]; then
            echo -e "${{ env.COLOR_RED }}${{ env.ICON_ERROR }} å‘çŽ°ç¼ºå¤±çš„luciè½¯ä»¶åŒ…: $MISSING_LUCI${{ env.COLOR_RESET }}"
            echo -e "${{ env.COLOR_YELLOW }}${{ env.ICON_WARNING }} è¿™å¯èƒ½æ˜¯ç”±äºŽè½¯ä»¶åŒ…ä¾èµ–é—®é¢˜æˆ–è½¯ä»¶åŒ…ä¸å­˜åœ¨${{ env.COLOR_RESET }}"
            
            # å°è¯•ä¿®å¤ç¼ºå¤±çš„è½¯ä»¶åŒ…
            echo -e "${{ env.COLOR_BLUE }}${{ env.ICON_INFO }} å°è¯•ä¿®å¤ç¼ºå¤±çš„è½¯ä»¶åŒ…${{ env.COLOR_RESET }}"
            for pkg in $MISSING_LUCI; do
              echo "CONFIG_PACKAGE_$pkg=y" >> .config
            done
            
            # å†æ¬¡è¿è¡Œdefconfig
            make defconfig
            
            # å†æ¬¡æ£€æŸ¥
            FIXED_LUCI=$(grep "CONFIG_PACKAGE_luci-.*=y" .config | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g' | tr '\n' ' ')
            STILL_MISSING=""
            for pkg in $MISSING_LUCI; do
              if ! echo $FIXED_LUCI | grep -q $pkg; then
                STILL_MISSING="$STILL_MISSING $pkg"
              fi
            done
            
            if [ -n "$STILL_MISSING" ]; then
              echo -e "${{ env.COLOR_RED }}${{ env.ICON_ERROR }} æ— æ³•ä¿®å¤çš„luciè½¯ä»¶åŒ…: $STILL_MISSING${{ env.COLOR_RESET }}"
              echo -e "${{ env.COLOR_YELLOW }}${{ env.ICON_WARNING }} è¯·æ£€æŸ¥è½¯ä»¶åŒ…åç§°æ˜¯å¦æ­£ç¡®æˆ–æ˜¯å¦å­˜åœ¨${{ env.COLOR_RESET }}"
              exit 1
            else
              echo -e "${{ env.COLOR_GREEN }}${{ env.ICON_SUCCESS }} æ‰€æœ‰luciè½¯ä»¶åŒ…å·²æˆåŠŸä¿®å¤${{ env.COLOR_RESET }}"
            fi
          else
            echo -e "${{ env.COLOR_GREEN }}${{ env.ICON_SUCCESS }} æ‰€æœ‰luciè½¯ä»¶åŒ…éƒ½å·²æ­£ç¡®é…ç½®${{ env.COLOR_RESET }}"
          fi
          
          # è¾“å‡ºæœ€ç»ˆluciè½¯ä»¶åŒ…åˆ—è¡¨
          echo -e "${{ env.COLOR_BLUE }}${{ env.ICON_INFO }} æœ€ç»ˆluciè½¯ä»¶åŒ…åˆ—è¡¨:${{ env.COLOR_RESET }}"
          grep "CONFIG_PACKAGE_luci-.*=y" .config | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g'
          
          # è¾“å‡ºç»“æŸä¿¡æ¯
          echo -e "${{ env.COLOR_GREEN }}${{ env.ICON_SUCCESS }} luciè½¯ä»¶åŒ…æ£€æŸ¥å®Œæˆ${{ env.COLOR_RESET }}"

      - name: Build Firmware
        run: |
          # è¾“å‡ºå¼€å§‹ä¿¡æ¯
          echo -e "${{ env.COLOR_CYAN }}${{ env.ICON_START }} å¼€å§‹ç¼–è¯‘å›ºä»¶${{ env.COLOR_RESET }}"
          echo -e "${{ env.COLOR_BLUE }}${{ env.ICON_INFO }} ç›®æ ‡è®¾å¤‡: ${{ matrix.device }}${{ env.COLOR_RESET }}"
          echo -e "${{ env.COLOR_BLUE }}${{ env.ICON_INFO }} åŸºç¡€é…ç½®: ${{ matrix.base_config }}${{ env.COLOR_RESET }}"
          echo -e "${{ env.COLOR_BLUE }}${{ env.ICON_INFO }} ç”¨æˆ·é…ç½®: ${{ matrix.user_config }}${{ env.COLOR_RESET }}"
          
          # è¿›å…¥æºä»£ç ç›®å½•
          cd openwrt
          
          # ç¼–è¯‘å›ºä»¶
          make -j$(nproc) || {
            echo -e "${{ env.COLOR_RED }}${{ env.ICON_ERROR }} å›ºä»¶ç¼–è¯‘å¤±è´¥${{ env.COLOR_RESET }}"
            echo -e "${{ env.COLOR_YELLOW }}${{ env.ICON_WARNING }} å°è¯•å•çº¿ç¨‹ç¼–è¯‘${{ env.COLOR_RESET }}"
            make -j1 V=s || {
              echo -e "${{ env.COLOR_RED }}${{ env.ICON_ERROR }} å•çº¿ç¨‹ç¼–è¯‘ä¹Ÿå¤±è´¥${{ env.COLOR_RESET }}"
              exit 1
            }
          }
          
          # è¾“å‡ºç»“æŸä¿¡æ¯
          echo -e "${{ env.COLOR_GREEN }}${{ env.ICON_SUCCESS }} å›ºä»¶ç¼–è¯‘å®Œæˆ${{ env.COLOR_RESET }}"

      - name: Organize Files
        run: |
          # è¾“å‡ºå¼€å§‹ä¿¡æ¯
          echo -e "${{ env.COLOR_CYAN }}${{ env.ICON_PACKAGE }} å¼€å§‹æ•´ç†æ–‡ä»¶${{ env.COLOR_RESET }}"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p ../temp_artifacts/${{ matrix.device }}-${{ matrix.user_config }}
          
          # è¿›å…¥æºä»£ç ç›®å½•
          cd openwrt
          
          # èŽ·å–åˆ†æ”¯ç¼©å†™
          BRANCH_ABBR=$(echo $REPO_URL | awk -F '/' '{print $NF}' | sed 's/immortalwrt/immwrt/g' | sed 's/openwrt/openwrt/g' | sed 's/libwrt/libwrt/g')
          
          # èŽ·å–èŠ¯ç‰‡å˜é‡
          CHIP_VAR=$(cat .config | grep CONFIG_TARGET_BOARD | awk -F '"' '{print $2}')
          
          # å¤åˆ¶å¹¶é‡å‘½åå›ºä»¶æ–‡ä»¶
          for bin in bin/targets/*/*/*.bin; do
            if [[ $bin == *factory.bin ]]; then
              cp $bin ../temp_artifacts/${{ matrix.device }}-${{ matrix.user_config }}/${BRANCH_ABBR}-${CHIP_VAR}-${{ matrix.device }}-factory-${{ matrix.user_config }}.bin
            elif [[ $bin == *sysupgrade.bin ]]; then
              cp $bin ../temp_artifacts/${{ matrix.device }}-${{ matrix.user_config }}/${BRANCH_ABBR}-${CHIP_VAR}-${{ matrix.device }}-sysupgrade-${{ matrix.user_config }}.bin
            fi
          done
          
          # å¤åˆ¶å¹¶é‡å‘½åé…ç½®æ–‡ä»¶
          cp .config ../temp_artifacts/${{ matrix.device }}-${{ matrix.user_config }}/${BRANCH_ABBR}-${CHIP_VAR}-${{ matrix.device }}-${{ matrix.user_config }}.config
          
          # å¤åˆ¶å¹¶é‡å‘½åmanifestæ–‡ä»¶
          cp bin/targets/*/*/*.manifest ../temp_artifacts/${{ matrix.device }}-${{ matrix.user_config }}/${BRANCH_ABBR}-${CHIP_VAR}-${{ matrix.device }}-${{ matrix.user_config }}.manifest
          
          # å¤åˆ¶å¹¶é‡å‘½åbuildinfoæ–‡ä»¶
          cp bin/targets/*/*/config.buildinfo ../temp_artifacts/${{ matrix.device }}-${{ matrix.user_config }}/${BRANCH_ABBR}-${CHIP_VAR}-${{ matrix.device }}-${{ matrix.user_config }}.config.buildinfo
          
          # å¤åˆ¶è½¯ä»¶åŒ…
          mkdir -p ../temp_artifacts/packages-${{ matrix.user_config }}
          find bin/packages -name "*.ipk" -o -name "*.apk" | xargs -I {} cp {} ../temp_artifacts/packages-${{ matrix.user_config }}/
          
          # è¾“å‡ºç»“æŸä¿¡æ¯
          echo -e "${{ env.COLOR_GREEN }}${{ env.ICON_SUCCESS }} æ–‡ä»¶æ•´ç†å®Œæˆ${{ env.COLOR_RESET }}"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.device }}-${{ matrix.user_config }}
          path: temp_artifacts/${{ matrix.device }}-${{ matrix.user_config }}/
          retention-days: 7

  # å‘å¸ƒé˜¶æ®µ
  release:
    needs: [setup, build-configs]
    runs-on: ${{ inputs.ubuntu_version || 'ubuntu-22.04' }}
    if: always() && needs.build-configs.result != 'failure'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts

      - name: Organize Release Files
        run: |
          # è¾“å‡ºå¼€å§‹ä¿¡æ¯
          echo -e "${{ env.COLOR_CYAN }}${{ env.ICON_PACKAGE }} å¼€å§‹æ•´ç†å‘å¸ƒæ–‡ä»¶${{ env.COLOR_RESET }}"
          
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p release_files
          
          # èŽ·å–èŠ¯ç‰‡å˜é‡
          CHIP_VAR="${{ needs.setup.outputs.target_arch }}"
          
          # åˆå¹¶æ‰€æœ‰é…ç½®æ–‡ä»¶
          mkdir -p release_files/${CHIP_VAR}-config
          find all_artifacts -name "*.config" -exec cp {} release_files/${CHIP_VAR}-config/ \;
          cd release_files/${CHIP_VAR}-config
          tar -zcf ../${CHIP_VAR}-config.tar.gz .
          cd -
          
          # åˆå¹¶æ‰€æœ‰manifestæ–‡ä»¶
          mkdir -p release_files/${CHIP_VAR}-manifest
          find all_artifacts -name "*.manifest" -exec cp {} release_files/${CHIP_VAR}-manifest/ \;
          cd release_files/${CHIP_VAR}-manifest
          tar -zcf ../${CHIP_VAR}-manifest.tar.gz .
          cd -
          
          # åˆå¹¶æ‰€æœ‰buildinfoæ–‡ä»¶
          mkdir -p release_files/${CHIP_VAR}-buildinfo
          find all_artifacts -name "*.config.buildinfo" -exec cp {} release_files/${CHIP_VAR}-buildinfo/ \;
          cd release_files/${CHIP_VAR}-buildinfo
          tar -zcf ../${CHIP_VAR}-buildinfo.tar.gz .
          cd -
          
          # åˆå¹¶æ‰€æœ‰è½¯ä»¶åŒ…
          mkdir -p release_files/${CHIP_VAR}-packages
          find all_artifacts -name "*.ipk" -o -name "*.apk" | xargs -I {} cp {} release_files/${CHIP_VAR}-packages/
          cd release_files/${CHIP_VAR}-packages
          tar -zcf ../${CHIP_VAR}-packages.tar.gz .
          cd -
          
          # å¤åˆ¶æ‰€æœ‰å›ºä»¶æ–‡ä»¶
          find all_artifacts -name "*.bin" -exec cp {} release_files/ \;
          
          # åˆ›å»ºå‘å¸ƒä¿¡æ¯
          cat > release_files/README.md << EOF
          # OpenWrt å›ºä»¶å‘å¸ƒ
          
          ## ðŸ“’ å›ºä»¶ä¿¡æ¯
          - ðŸŒ é»˜è®¤åœ°å€: **192.168.111.1**
          - ðŸ”‘ é»˜è®¤å¯†ç : none
          - ðŸ–¥ï¸ æœºå™¨å: WRT
          
          ## ðŸ“¦ æ–‡ä»¶è¯´æ˜Ž
          - \`${CHIP_VAR}-config.tar.gz\`: æ‰€æœ‰é…ç½®æ–‡ä»¶
          - \`${CHIP_VAR}-manifest.tar.gz\`: æ‰€æœ‰è½¯ä»¶åŒ…æ¸…å•
          - \`${CHIP_VAR}-buildinfo.tar.gz\`: æ‰€æœ‰æž„å»ºä¿¡æ¯
          - \`${CHIP_VAR}-packages.tar.gz\`: æ‰€æœ‰è½¯ä»¶åŒ…
          - \*.bin: å›ºä»¶æ–‡ä»¶
          
          ## ðŸ”§ å›ºä»¶å‘½åè§„åˆ™
          - æ ¼å¼: åˆ†æ”¯ç¼©å†™-èŠ¯ç‰‡å˜é‡-è®¾å¤‡åç§°-ç±»åž‹-é…ç½®.bin
          - ç¤ºä¾‹: immwrt-ipq60xx-jdcloud_re-ss-01-sysupgrade-Pro.bin
          
          ## ðŸ“ ç¼–è¯‘ä¿¡æ¯
          - ç¼–è¯‘æ—¶é—´: $(date +"%Y-%m-%d %H:%M:%S")
          - æºç åœ°å€: $REPO_URL
          - æºç åˆ†æ”¯: $REPO_BRANCH
          EOF
          
          # è¾“å‡ºç»“æŸä¿¡æ¯
          echo -e "${{ env.COLOR_GREEN }}${{ env.ICON_SUCCESS }} å‘å¸ƒæ–‡ä»¶æ•´ç†å®Œæˆ${{ env.COLOR_RESET }}"

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          name: OpenWrt å›ºä»¶å‘å¸ƒ - $(date +"%Y.%m.%d")
          tag: openwrt-$(date +"%Y%m%d")
          artifacts: release_files/*
          bodyFile: release_files/README.md
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false

      - name: Cleanup
        run: |
          # è¾“å‡ºå¼€å§‹ä¿¡æ¯
          echo -e "${{ env.COLOR_CYAN }}${{ env.ICON_START }} å¼€å§‹æ¸…ç†${{ env.COLOR_RESET }}"
          
          # åˆ é™¤æ—§ç¼“å­˜
          gh cache list --key ${{ needs.setup.outputs.cache_key }}- --json key --jq '.[] | .key' | while read -r key; do
            gh cache delete "$key"
          done
          
          # è¾“å‡ºç»“æŸä¿¡æ¯
          echo -e "${{ env.COLOR_GREEN }}${{ env.ICON_SUCCESS }} æ¸…ç†å®Œæˆ${{ env.COLOR_RESET }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
