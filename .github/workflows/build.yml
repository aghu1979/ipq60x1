# OpenWrt å¤šé…ç½®è‡ªåŠ¨ç¼–è¯‘å·¥ä½œæµ
# æ”¯æŒå¤šèŠ¯ç‰‡æ¶æ„ã€å¤šåˆ†æ”¯ã€å¤šé…ç½®çš„å¹¶è¡Œç¼–è¯‘
# ä½œè€…: Mary
# é¦–æ¬¡åˆ›å»º: 2025-10-18
# æœ€åæ›´æ–°: 2025-10-18

name: OpenWrt Multi-Config Build

# è§¦å‘æ¡ä»¶
on:
  # å®šæ—¶è§¦å‘ï¼šåŒ—äº¬æ—¶é—´æ¯å‘¨äº”0ç‚¹ (UTCæ—¶é—´å‘¨å››16ç‚¹)
  schedule:
    - cron: '0 16 * * 4'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      ubuntu_version:
        description: 'é€‰æ‹©Ubuntuç‰ˆæœ¬'
        required: true
        default: '22.04'
        type: choice
        options:
          - '22.04'
          - '24.04'
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°ç¼–è¯‘ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        required: false
        default: false
        type: boolean

# ç¯å¢ƒå˜é‡
env:
  TZ: Asia/Shanghai  # æ—¶åŒºè®¾ç½®
  CACHE_VERSION: v2  # ç¼“å­˜ç‰ˆæœ¬å·ï¼Œç”¨äºç¼“å­˜å¤±æ•ˆæ§åˆ¶

# ä»»åŠ¡å®šä¹‰
jobs:
  # é˜¶æ®µ1ï¼šç”Ÿæˆé…ç½®å“ˆå¸Œå€¼
  # æ­¤ä»»åŠ¡ç”¨äºç”Ÿæˆæ‰€æœ‰é…ç½®æ–‡ä»¶çš„å“ˆå¸Œå€¼ï¼Œä½œä¸ºç¼“å­˜çš„key
  generate-hashes:
    name: ç”Ÿæˆé…ç½®å“ˆå¸Œ
    runs-on: ubuntu-latest
    outputs:
      # è¾“å‡ºå“ˆå¸Œæ–‡ä»¶å†…å®¹
      hashes-file: ${{ steps.hash.outputs.hashes-file }}
      # è¾“å‡ºç¼“å­˜key
      cache-key: ${{ steps.hash.outputs.cache-key }}
      # è¾“å‡ºé…ç½®æ–‡ä»¶æ•°é‡
      config-count: ${{ steps.hash.outputs.config-count }}
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ç”Ÿæˆå“ˆå¸Œæ–‡ä»¶
      - name: ç”Ÿæˆé…ç½®å“ˆå¸Œæ–‡ä»¶
        id: hash
        run: |
          # åˆ›å»ºå“ˆå¸Œæ–‡ä»¶
          {
            echo "# Configuration Hashes - $(date)"
            echo "# Generated by OpenWrt Build System"
            echo ""
            # æŸ¥æ‰¾æ‰€æœ‰é…ç½®æ–‡ä»¶å¹¶ç”Ÿæˆå“ˆå¸Œ
            find configs/ -type f -name "*.config" -exec sha256sum {} \; | \
              sed 's|configs/||' | \
              sort | \
              awk '{print $2 "=" $1}'
          } > hashes-file
          
          # ç»Ÿè®¡é…ç½®æ–‡ä»¶æ•°é‡
          CONFIG_COUNT=$(wc -l < hashes-file)
          
          # ç”Ÿæˆç¼“å­˜keyï¼ˆåŸºäºæ‰€æœ‰é…ç½®æ–‡ä»¶çš„å“ˆå¸Œï¼‰
          CACHE_KEY="openwrt-$(cat hashes-file | sha256sum | cut -d' ' -f1)"
          
          # è¾“å‡ºåˆ°GitHub Actions
          {
            echo "hashes-file<<EOF"
            cat hashes-file
            echo "EOF"
            echo "cache-key=$CACHE_KEY"
            echo "config-count=$CONFIG_COUNT"
          } >> $GITHUB_OUTPUT
          
          # æ—¥å¿—è¾“å‡º
          echo "âœ… ç”Ÿæˆå“ˆå¸Œæ–‡ä»¶å®Œæˆ"
          echo "ğŸ“Š é…ç½®æ–‡ä»¶æ•°é‡: $CONFIG_COUNT"
          echo "ğŸ”‘ ç¼“å­˜Key: $CACHE_KEY"

  # é˜¶æ®µ2ï¼šå‡†å¤‡åŸºç¡€ç¯å¢ƒ
  # æ­¤ä»»åŠ¡è´Ÿè´£å‡†å¤‡ç¼–è¯‘æ‰€éœ€çš„åŸºç¡€ç¯å¢ƒå’Œä¾èµ–
  prepare-base:
    name: å‡†å¤‡åŸºç¡€ç¯å¢ƒ
    needs: generate-hashes
    runs-on: ubuntu-${{ github.event.inputs.ubuntu_version || '22.04' }}
    outputs:
      # ç¼“å­˜æ˜¯å¦å‘½ä¸­
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
      # åŸºç¡€ç¯å¢ƒæ˜¯å¦å‡†å¤‡å®Œæˆ
      base-ready: ${{ steps.prepare.outputs.base-ready }}
      # åŸºç¡€ç¯å¢ƒè·¯å¾„
      base-path: ${{ steps.prepare.outputs.base-path }}
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ¸…ç†ç£ç›˜ç©ºé—´
      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main
        with:
          # ä¿ç•™å·¥å…·ç¼“å­˜
          tool-cache: true
          # åˆ é™¤Androidå·¥å…·
          android: true
          # åˆ é™¤.NETå·¥å…·
          dotnet: true
          # åˆ é™¤Haskellå·¥å…·
          haskell: true
          # åˆ é™¤Dockeré•œåƒ
          docker-images: true
          # åˆ é™¤å¤§åŒ…
          large-packages: true
          # åˆ›å»ºswapæ–‡ä»¶
          swap-storage: true

      # å®‰è£…ç¼–è¯‘ä¾èµ–
      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          # æ›´æ–°åŒ…åˆ—è¡¨
          sudo apt-get update
          # å®‰è£…ç¼–è¯‘æ‰€éœ€çš„åŒ…
          sudo apt-get install -y \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gcc-multilib \
            g++-multilib \
            gettext \
            libelf-dev \
            libssl-dev \
            libncurses5-dev \
            libncursesw5-dev \
            python3-distutils-extra \
            rsync \
            unzip \
            python3-pyelftools \
            python3-setuptools \
            python3-pip \
            python3-pyelftools \
            zlib1g-dev \
            subversion \
            git \
            wget \
            time \
            python3 \
            ccache \
            curl

      # å°è¯•æ¢å¤ç¼“å­˜
      - name: æ¢å¤åŸºç¡€ç¯å¢ƒç¼“å­˜
        id: cache
        uses: actions/cache@v3
        with:
          # ç¼“å­˜è·¯å¾„
          path: |
            base_env/
            dl/
            build_dir/host/
            build_dir/toolchain-*/
            staging_dir/host/
            staging_dir/toolchain-*/
            toolchain/
            .ccache
            feeds/
          # ç¼“å­˜key
          key: ${{ needs.generate-hashes.outputs.cache-key }}-${{ env.CACHE_VERSION }}-${{ runner.os }}
          # å¤‡ç”¨keyï¼ˆç”¨äºéƒ¨åˆ†ç¼“å­˜å‘½ä¸­ï¼‰
          restore-keys: |
            openwrt--${{ env.CACHE_VERSION }}-${{ runner.os }}

      # å‡†å¤‡åŸºç¡€ç¯å¢ƒï¼ˆç¼“å­˜æœªå‘½ä¸­æ—¶ï¼‰
      - name: å‡†å¤‡åŸºç¡€ç¯å¢ƒ
        id: prepare
        if: steps.cache.outputs.cache-hit != 'true' || github.event.inputs.force_rebuild == 'true'
        run: |
          # åˆ›å»ºåŸºç¡€ç¯å¢ƒç›®å½•
          mkdir -p base_env
          
          # å…‹éš†ä¸»ä»“åº“ï¼ˆä½¿ç”¨OpenWrtä½œä¸ºåŸºç¡€ï¼‰
          echo "ğŸ“¥ å…‹éš†åŸºç¡€ä»“åº“..."
          git clone https://github.com/laipeng668/openwrt.git base_env/openwrt
          cd base_env/openwrt
          
          # è®¾ç½®æ‰§è¡Œæƒé™
          chmod +x ../scripts/*.sh
          
          # æ‰§è¡ŒDIYè„šæœ¬å‡†å¤‡ç¯å¢ƒ
          echo "ğŸ”§ æ‰§è¡ŒDIYè„šæœ¬..."
          ../scripts/diy.sh openwrt ipq60xx
          
          # æ›´æ–°feeds
          echo "ğŸ“¦ æ›´æ–°feeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # ä¿å­˜å“ˆå¸Œæ–‡ä»¶
          cp ../../hashes-file ./
          
          # è¿”å›ä¸Šçº§ç›®å½•
          cd ../..
          
          # è¾“å‡ºå‡†å¤‡å®Œæˆæ ‡å¿—
          echo "base-ready=true" >> $GITHUB_OUTPUT
          echo "base-path=base_env/openwrt" >> $GITHUB_OUTPUT
          
          echo "âœ… åŸºç¡€ç¯å¢ƒå‡†å¤‡å®Œæˆ"

  # é˜¶æ®µ3ï¼šå¹¶è¡Œç¼–è¯‘æ‰€æœ‰é…ç½®
  # æ­¤ä»»åŠ¡ä½¿ç”¨çŸ©é˜µç­–ç•¥å¹¶è¡Œç¼–è¯‘æ‰€æœ‰åˆ†æ”¯å’Œé…ç½®ç»„åˆ
  build-configs:
    name: ç¼–è¯‘å›ºä»¶ (${{ matrix.branch }}-${{ matrix.config }})
    needs: [generate-hashes, prepare-base]
    # åªæœ‰åœ¨åŸºç¡€ç¯å¢ƒå‡†å¤‡å®Œæˆæˆ–ç¼“å­˜å‘½ä¸­æ—¶æ‰æ‰§è¡Œ
    if: always() && (needs.prepare-base.outputs.base-ready == 'true' || needs.prepare-base.outputs.cache-hit == 'true')
    runs-on: ubuntu-${{ github.event.inputs.ubuntu_version || '22.04' }}
    strategy:
      # ä¸å› å•ä¸ªä»»åŠ¡å¤±è´¥è€Œç»ˆæ­¢å…¶ä»–ä»»åŠ¡
      fail-fast: false
      # çŸ©é˜µå®šä¹‰
      matrix:
        # åˆ†æ”¯åˆ—è¡¨
        branch: [openwrt, immwrt, libwrt]
        # é…ç½®åˆ—è¡¨
        config: [Pro, Max, Ultra]
        # åˆ†æ”¯é…ç½®åŒ…å«
        include:
          # OpenWrtåˆ†æ”¯é…ç½®
          - branch: openwrt
            repo_url: https://github.com/laipeng668/openwrt.git
            repo_branch: master
            repo_short: openwrt
          # ImmortalWrtåˆ†æ”¯é…ç½®
          - branch: immwrt
            repo_url: https://github.com/laipeng668/immortalwrt.git
            repo_branch: master
            repo_short: immwrt
          # LibWrtåˆ†æ”¯é…ç½®
          - branch: libwrt
            repo_url: https://github.com/laipeng668/openwrt-6.x.git
            repo_branch: k6.12-nss
            repo_short: libwrt
    # è¶…æ—¶è®¾ç½®ï¼š3å°æ—¶
    timeout-minutes: 180
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ¸…ç†ç£ç›˜ç©ºé—´
      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main

      # æ¢å¤åŸºç¡€ç¯å¢ƒç¼“å­˜
      - name: æ¢å¤åŸºç¡€ç¯å¢ƒç¼“å­˜
        uses: actions/cache@v3
        with:
          path: |
            base_env/
            dl/
            build_dir/host/
            build_dir/toolchain-*/
            staging_dir/host/
            staging_dir/toolchain-*/
            toolchain/
            .ccache
            feeds/
          key: ${{ needs.generate-hashes.outputs.cache-key }}-${{ env.CACHE_VERSION }}-${{ runner.os }}

      # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        run: |
          # å®‰è£…ç¼–è¯‘ä¾èµ–
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gcc-multilib \
            g++-multilib \
            gettext \
            libelf-dev \
            libssl-dev \
            libncurses5-dev \
            libncursesw5-dev \
            python3-distutils-extra \
            rsync \
            unzip \
            python3-pyelftools \
            python3-setuptools \
            python3-pip \
            python3-pyelftools \
            zlib1g-dev
          
          # è®¾ç½®ccacheç¯å¢ƒå˜é‡
          echo "export CCACHE_DIR=$GITHUB_WORKSPACE/.ccache" >> $GITHUB_ENV
          echo "export CCACHE_MAXSIZE=5G" >> $GITHUB_ENV
          
          # åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
          source ./scripts/logger.sh
          log_info "å¼€å§‹ç¼–è¯‘ ${{ matrix.branch }}-${{ matrix.config }}"

      # å‡†å¤‡æºç 
      - name: å‡†å¤‡æºç 
        run: |
          # åŠ è½½æ—¥å¿—æ¨¡å—
          source ./scripts/logger.sh
          step_start "å‡†å¤‡æºç "
          
          # å¤åˆ¶åŸºç¡€ç¯å¢ƒæˆ–å…‹éš†æ–°ä»“åº“
          if [ -d "base_env/openwrt" ]; then
            echo "ğŸ“ å¤åˆ¶åŸºç¡€ç¯å¢ƒ..."
            cp -r base_env/openwrt ./
          else
            echo "ğŸ“¥ å…‹éš†ä»“åº“: ${{ matrix.repo_url }}"
            git clone ${{ matrix.repo_url }} openwrt
          fi
          
          # è¿›å…¥æºç ç›®å½•
          cd openwrt
          
          # æ¢å¤å“ˆå¸Œæ–‡ä»¶
          cp ../hashes-file ./
          
          # æ‰§è¡ŒDIYè„šæœ¬
          chmod +x ../scripts/*.sh
          ../scripts/diy.sh ${{ matrix.branch }} ipq60xx
          
          step_end "æºç å‡†å¤‡å®Œæˆ"

      # åˆå¹¶é…ç½®æ–‡ä»¶
      - name: åˆå¹¶é…ç½®æ–‡ä»¶
        run: |
          # åŠ è½½æ—¥å¿—æ¨¡å—
          source ./scripts/logger.sh
          cd openwrt
          step_start "åˆå¹¶é…ç½®æ–‡ä»¶"
          
          # åˆå¹¶é…ç½®ï¼ˆä¼˜å…ˆçº§ä»ä½åˆ°é«˜ï¼‰
          ../scripts/merge_config.sh ipq60xx ${{ matrix.branch }} ${{ matrix.config }}
          
          step_end "é…ç½®åˆå¹¶å®Œæˆ"

      # æ£€æŸ¥è½¯ä»¶åŒ…
      - name: æ£€æŸ¥è½¯ä»¶åŒ…
        run: |
          # åŠ è½½æ—¥å¿—æ¨¡å—
          source ./scripts/logger.sh
          cd openwrt
          step_start "æ£€æŸ¥è½¯ä»¶åŒ…"
          
          # æ‰§è¡Œè½¯ä»¶åŒ…æ£€æŸ¥
          ../scripts/check_packages.sh
          
          step_end "è½¯ä»¶åŒ…æ£€æŸ¥å®Œæˆ"

      # ç¼–è¯‘å›ºä»¶
      - name: ç¼–è¯‘å›ºä»¶
        run: |
          # åŠ è½½æ—¥å¿—æ¨¡å—
          source ./scripts/logger.sh
          cd openwrt
          step_start "ç¼–è¯‘å›ºä»¶"
          
          # è®¾ç½®ç¼–è¯‘å‚æ•°
          export CCACHE_DIR=$GITHUB_WORKSPACE/.ccache
          export CCACHE_MAXSIZE=5G
          
          # å¼€å§‹ç¼–è¯‘
          echo "ğŸ”¥ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          make -j$(nproc) 2>&1 | tee compile.log
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            log_error "ç¼–è¯‘å¤±è´¥ï¼"
            # ä¿å­˜é”™è¯¯æ—¥å¿—
            tail -n 1000 compile.log > error.log
            exit 1
          fi
          
          step_end "å›ºä»¶ç¼–è¯‘å®Œæˆ"

      # å¤„ç†äº§å‡ºç‰©
      - name: å¤„ç†äº§å‡ºç‰©
        run: |
          # åŠ è½½æ—¥å¿—æ¨¡å—
          source ./scripts/logger.sh
          cd openwrt
          step_start "å¤„ç†äº§å‡ºç‰©"
          
          # å¤„ç†äº§å‡ºç‰©
          ../scripts/process_artifacts.sh ${{ matrix.branch }} ${{ matrix.config }} ipq60xx
          
          step_end "äº§å‡ºç‰©å¤„ç†å®Œæˆ"

      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: build-${{ matrix.branch }}-${{ matrix.config }}
          path: |
            openwrt/artifacts/
            openwrt/*.log
          # ä¿ç•™7å¤©
          retention-days: 7

  # é˜¶æ®µ4ï¼šåˆ›å»ºRelease
  # æ­¤ä»»åŠ¡è´Ÿè´£åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ æ‰€æœ‰äº§å‡ºç‰©
  create-release:
    name: åˆ›å»ºRelease
    needs: [generate-hashes, build-configs]
    # åªæœ‰åœ¨æ‰€æœ‰ç¼–è¯‘ä»»åŠ¡æˆåŠŸæ—¶æ‰æ‰§è¡Œ
    if: always() && needs.build-configs.result == 'success'
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      # å‡†å¤‡å‘å¸ƒå†…å®¹
      - name: å‡†å¤‡å‘å¸ƒå†…å®¹
        run: |
          # åŠ è½½æ—¥å¿—æ¨¡å—
          source ./scripts/logger.sh
          step_start "å‡†å¤‡å‘å¸ƒ"
          
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p release
          
          # å¤åˆ¶å›ºä»¶æ–‡ä»¶
          echo "ğŸ“¦ æ”¶é›†å›ºä»¶æ–‡ä»¶..."
          find artifacts -name "*.bin" -exec cp {} release/ \;
          
          # æ‰“åŒ…é…ç½®æ–‡ä»¶
          echo "ğŸ“¦ æ‰“åŒ…é…ç½®æ–‡ä»¶..."
          find artifacts -name "*.config*" -exec cp {} release/ \;
          tar -czf release/ipq60xx-config.tar.gz -C release $(ls release/*.config* | xargs -n1 basename)
          
          # æ‰“åŒ…è½¯ä»¶åŒ…
          echo "ğŸ“¦ æ‰“åŒ…è½¯ä»¶åŒ…..."
          mkdir -p release/packages
          find artifacts -name "*.ipk" -exec cp {} release/packages/ \; 2>/dev/null || true
          tar -czf release/ipq60xx-app.tar.gz -C release/packages .
          
          # æ‰“åŒ…æ—¥å¿—
          echo "ğŸ“¦ æ‰“åŒ…æ—¥å¿—..."
          find artifacts -name "*.log" -exec cp {} release/ \;
          tar -czf release/ipq60xx-log.tar.gz -C release $(ls release/*.log | xargs -n1 basename)
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          echo "ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜..."
          ../scripts/prepare_release.sh > release_notes.md
          
          step_end "å‘å¸ƒå‡†å¤‡å®Œæˆ"

      # åˆ›å»ºRelease
      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v1
        with:
          # Releaseæ ‡ç­¾
          tag_name: ipq60xx-$(date +%Y%m%d)
          # Releaseå†…å®¹
          body_path: release_notes.md
          # ä¸Šä¼ æ–‡ä»¶
          files: |
            release/*.bin
            release/*.tar.gz
          # éè‰ç¨¿
          draft: false
          # éé¢„å‘å¸ƒ
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ¸…ç†æ—§ç‰ˆæœ¬
      - name: æ¸…ç†æ—§ç‰ˆæœ¬
        run: |
          # ä¿ç•™æœ€è¿‘7ä¸ªç‰ˆæœ¬
          echo "ğŸ§¹ æ¸…ç†æ—§ç‰ˆæœ¬..."
          gh release list --repo ${{ github.repository }} --limit 20 | \
            tail -n +8 | \
            awk '{print $1}' | \
            xargs -I {} gh release delete {} --repo ${{ github.repository }} --yes || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
