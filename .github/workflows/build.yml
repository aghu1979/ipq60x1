# ==============================================================================
# OpenWrt å¤šæ¶æ„ã€å¤šåˆ†æ”¯ã€å¤šé…ç½®è‡ªåŠ¨ç¼–è¯‘å·¥ä½œæµ
# ä½œè€…: Mary
# æè¿°: æ­¤å·¥ä½œæµæ—¨åœ¨å®ç°ä¸€ä¸ªé«˜åº¦è‡ªåŠ¨åŒ–ã€å¥å£®ä¸”ç”¨æˆ·å‹å¥½çš„å›ºä»¶ç¼–è¯‘æµæ°´çº¿ã€‚
#       å®ƒæ”¯æŒå¤šèŠ¯ç‰‡ã€å¤šåˆ†æ”¯ã€å¤šé…ç½®çš„ç»„åˆç¼–è¯‘ï¼Œå¹¶é€šè¿‡åˆ†é˜¶æ®µç¼“å­˜å’Œä¸¥æ ¼çš„
#       LUCI è½¯ä»¶åŒ…æ£€æŸ¥ï¼Œç¡®ä¿ç¼–è¯‘æ•ˆç‡å’ŒæˆåŠŸç‡ã€‚
# ==============================================================================

name: OpenWrt Auto Build

# è§¦å‘æ¡ä»¶: æ‰‹åŠ¨è§¦å‘ æˆ– å®šæ—¶è§¦å‘ (åŒ—äº¬æ—¶é—´å‘¨äº” 0:00 -> UTC æ—¶é—´å‘¨å›› 16:00)
on:
  workflow_dispatch:
  schedule:
    - cron: '0 16 * * 4' # "At 16:00 on Thursday" (UTC)

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  # å®šä¹‰èŠ¯ç‰‡æ¶æ„ï¼Œæ–¹ä¾¿åç»­ç»Ÿä¸€ä¿®æ”¹
  CHIP_ARCH: ipq60xx
  # å®šä¹‰ feeds æ›´æ–°æ—¶çš„å¹¶å‘æ•°
  FEEDS_THREADS: 4
  # å®šä¹‰ç¼–è¯‘æ—¶çš„å¹¶å‘æ•°
  BUILD_THREADS: $(nproc)
  # å®šä¹‰äº§ç‰©å­˜æ”¾ç›®å½•
  ARTIFACTS_DIR: released_files
  # å®šä¹‰æ—¥å¿—æ–‡ä»¶å
  LOG_FILE: build.log

jobs:
  # ==============================================================================
  # Job 1: å‡†å¤‡é˜¶æ®µ
  # ç›®çš„: ç”Ÿæˆæ‰€æœ‰é…ç½®æ–‡ä»¶çš„å“ˆå¸Œå€¼ï¼Œä½œä¸ºç¼“å­˜é”®çš„ä¸€éƒ¨åˆ†ã€‚
  # ==============================================================================
  prepare:
    name: ğŸš€ å‡†å¤‡é˜¶æ®µ - ç”Ÿæˆå“ˆå¸Œ
    runs-on: ubuntu-22.04
    outputs:
      # å°†å“ˆå¸Œæ–‡ä»¶çš„å†…å®¹ä½œä¸ºè¾“å‡ºï¼Œä¼ é€’ç»™åç»­ Job
      hashes_file: ${{ steps.generate_hashes.outputs.hashes_file }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç”Ÿæˆé…ç½®æ–‡ä»¶å“ˆå¸Œ
        id: generate_hashes
        run: |
          # è°ƒç”¨è„šæœ¬ç”Ÿæˆå“ˆå¸Œæ–‡ä»¶
          bash scripts/generate-hashes.sh
          # å°†å“ˆå¸Œæ–‡ä»¶å†…å®¹è®¾ç½®ä¸ºè¾“å‡ºå˜é‡
          echo "hashes_file<<EOF" >> $GITHUB_OUTPUT
          cat hashes.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # ==============================================================================
  # Job 2: é˜¶æ®µä¸€ - æ„å»ºåŸºç¡€ç¼–è¯‘ç¯å¢ƒ
  # ç›®çš„: ä¸ºæ¯ä¸ªåˆ†æ”¯å¹¶è¡Œæ„å»ºä¸€ä¸ªåŒ…å«å·¥å…·é“¾ã€ä¾èµ–å’Œ dl åŒ…çš„åŸºç¡€ç¯å¢ƒã€‚
  #       å¹¶è¿›è¡Œ LUCI è½¯ä»¶åŒ…é¢„æ£€ã€‚
  # ==============================================================================
  build-base:
    name: ğŸ—ï¸ é˜¶æ®µä¸€ - æ„å»º [${{ matrix.branch }}] åŸºç¡€ç¯å¢ƒ
    runs-on: ubuntu-22.04
    needs: prepare
    # å®šä¹‰çŸ©é˜µï¼Œå¹¶è¡Œå¤„ç†ä¸åŒåˆ†æ”¯
    strategy:
      fail-fast: false # å³ä½¿æŸä¸ªçŸ©é˜µä»»åŠ¡å¤±è´¥ï¼Œå…¶ä»–ä»»åŠ¡ä¹Ÿç»§ç»­è¿è¡Œ
      matrix:
        branch:
          - { repo_short: openwrt, repo_url: "https://github.com/openwrt/openwrt.git", repo_branch: "master" }
          - { repo_short: immwrt, repo_url: "https://github.com/immortalwrt/immortalwrt.git", repo_branch: "master" }
          - { repo_short: libwrt, repo_url: "https://github.com/openwrt/openwrt.git", repo_branch: "openwrt-24.10" } # æ³¨æ„ï¼šlibwrtçš„æºéœ€è¦æ‚¨ç¡®è®¤ï¼Œè¿™é‡Œç”¨å®˜æ–¹24.10åˆ†æ”¯ä½œä¸ºç¤ºä¾‹

    outputs:
      # å°†åŸºç¡€ç¯å¢ƒç¼–è¯‘çŠ¶æ€ä¼ é€’ç»™ä¸‹ä¸€é˜¶æ®µ
      base_env_success: ${{ steps.check_luci.outcome == 'success' }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
        run: |
          source scripts/logger.sh
          log_info "å·¥ä½œæµå¼€å§‹ï¼Œæ—¥å¿—æ–‡ä»¶: ${{ env.LOG_FILE }}"
          echo "FULL_LOG_PATH=$(pwd)/${{ env.LOG_FILE }}" >> $GITHUB_ENV

      - name: æ˜¾ç¤ºç¼–è¯‘å‰ç£ç›˜ç©ºé—´
        run: |
          source scripts/logger.sh
          log_info "ç¼–è¯‘å‰ç£ç›˜ç©ºé—´:"
          df -hT | tee -a ${{ env.FULL_LOG_PATH }}

      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: æ˜¾ç¤ºæ¸…ç†åç£ç›˜ç©ºé—´
        run: |
          source scripts/logger.sh
          log_info "æ¸…ç†åç£ç›˜ç©ºé—´:"
          df -hT | tee -a ${{ env.FULL_LOG_PATH }}

      - name: æ¢å¤ DL ç¼“å­˜
        id: cache-dl
        uses: actions/cache@v4
        with:
          path: dl/
          key: dl-${{ env.CHIP_ARCH }}-${{ hashFiles('hashes.txt') }}
          restore-keys: |
            dl-${{ env.CHIP_ARCH }}-

      - name: æ¢å¤ Ccache ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ env.CHIP_ARCH }}-${{ matrix.branch.repo_short }}-${{ github.run_id }}
          restore-keys: |
            ccache-${{ env.CHIP_ARCH }}-${{ matrix.branch.repo_short }}-

      - name: æ¢å¤åŸºç¡€ç¯å¢ƒç¼“å­˜
        id: cache-base-env
        uses: actions/cache@v4
        with:
          path: |
            build_dir/target/
            build_dir/host/
            staging_dir/
            .config
            feeds.conf
          key: base-env-${{ matrix.branch.repo_short }}-${{ env.CHIP_ARCH }}-${{ hashFiles('hashes.txt') }}
          restore-keys: |
            base-env-${{ matrix.branch.repo_short }}-${{ env.CHIP_ARCH }}-

      - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        if: steps.cache-base-env.outputs.cache-hit != 'true'
        run: |
          source scripts/logger.sh
          step_start "è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
          
          # å®šä¹‰ä¸€ä¸ªå¯é çš„ã€å›ºå®šçš„ä¾èµ–åŒ…åˆ—è¡¨ä½œä¸ºå¤‡ç”¨
          FALLBACK_PACKAGES="build-essential ccache file git libncurses5-dev libpython3-dev libssl-dev python3-distutils python3-filelock python3-pip python3-pyelftools python3-setuptools rsync unzip wget zlib1g-dev qemu-user-static g++ g++-multilib libc6-dev-i386"
          
          # å°è¯•ä»ç½‘ç»œè·å–ä¾èµ–åˆ—è¡¨
          log_info "å°è¯•ä»ç½‘ç»œè·å–æœ€æ–°çš„ä¾èµ–åŒ…åˆ—è¡¨..."
          ONLINE_PACKAGES=$(curl -fsSL git.io/depends-ubuntu-2204 || echo "")
          
          if [[ -n "$ONLINE_PACKAGES" ]]; then
            log_success "æˆåŠŸä»ç½‘ç»œè·å–ä¾èµ–åˆ—è¡¨ï¼Œå°†å®‰è£…: $ONLINE_PACKAGES"
            PACKAGES_TO_INSTALL="$ONLINE_PACKAGES"
          else
            log_warn "ç½‘ç»œè·å–å¤±è´¥ï¼Œå°†ä½¿ç”¨é¢„å®šä¹‰çš„å¤‡ç”¨ä¾èµ–åˆ—è¡¨ã€‚"
            log_info "å¤‡ç”¨ä¾èµ–åˆ—è¡¨: $FALLBACK_PACKAGES"
            PACKAGES_TO_INSTALL="$FALLBACK_PACKAGES"
          fi
          
          # æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…ä¾èµ–
          sudo apt-get update
          sudo apt-get install -y $PACKAGES_TO_INSTALL
          
          # åœæ­¢ unattended-upgrades æœåŠ¡ï¼Œé¿å…ç¼–è¯‘è¿‡ç¨‹ä¸­è¢«å¹²æ‰°
          # ä½¿ç”¨ || true ç¡®ä¿å³ä½¿æœåŠ¡ä¸å­˜åœ¨ä¹Ÿä¸ä¼šæŠ¥é”™
          sudo systemctl stop unattended-upgrades.service || true
          
          step_end "è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"

      - name: å…‹éš†æºç 
        if: steps.cache-base-env.outputs.cache-hit != 'true'
        run: |
          source scripts/logger.sh
          step_start "å…‹éš† ${{ matrix.branch.repo_short }} æºç "
          git clone ${{ matrix.branch.repo_url }} openwrt
          cd openwrt
          git checkout ${{ matrix.branch.repo_branch }}
          step_end "å…‹éš† ${{ matrix.branch.repo_short }} æºç "

      - name: åŠ è½½è‡ªå®šä¹‰è„šæœ¬
        if: steps.cache-base-env.outputs.cache-hit != 'true'
        run: |
          source scripts/logger.sh
          step_start "åŠ è½½è‡ªå®šä¹‰è„šæœ¬"
          # è¿›å…¥æºç ç›®å½•æ‰§è¡Œ
          cd openwrt
          # ã€å…³é”®ä¿®æ”¹ã€‘å¤åˆ¶æ•´ä¸ª scripts ç›®å½•åˆ°æºç ç›®å½•å†…
          cp -r ../scripts .
          # æ‰§è¡Œ diy.sh
          chmod +x scripts/diy.sh
          ./scripts/diy.sh
          step_end "åŠ è½½è‡ªå®šä¹‰è„šæœ¬"

      - name: æ›´æ–° Feeds
        if: steps.cache-base-env.outputs.cache-hit != 'true'
        run: |
          source scripts/logger.sh
          step_start "æ›´æ–° Feeds"
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          step_end "æ›´æ–° Feeds"

      - name: åˆå¹¶åŸºç¡€é…ç½®
        if: steps.cache-base-env.outputs.cache-hit != 'true'
        run: |
          source scripts/utils.sh
          step_start "åˆå¹¶åŸºç¡€é…ç½®"
          cd openwrt
          # åˆå¹¶èŠ¯ç‰‡é…ç½®å’Œåˆ†æ”¯é…ç½®
          merge_configs "../configs/base_${{ env.CHIP_ARCH }}.config" "../configs/base_${{ matrix.branch.repo_short }}.config"
          step_end "åˆå¹¶åŸºç¡€é…ç½®"

      - name: ä¸‹è½½æºç åŒ…
        if: steps.cache-base-env.outputs.cache-hit != 'true'
        run: |
          source scripts/logger.sh
          step_start "ä¸‹è½½æ‰€æœ‰æºç åŒ…"
          cd openwrt
          make defconfig
          make download -j${{ env.FEEDS_THREADS }}
          step_end "ä¸‹è½½æ‰€æœ‰æºç åŒ…"

      - name: é¢„ç¼–è¯‘å·¥å…·é“¾å’Œæ ¸å¿ƒå·¥å…·
        if: steps.cache-base-env.outputs.cache-hit != 'true'
        run: |
          source scripts/logger.sh
          step_start "é¢„ç¼–è¯‘å·¥å…·é“¾å’Œæ ¸å¿ƒå·¥å…·"
          cd openwrt
          make -j$(nproc) tools/compile
          make -j$(nproc) toolchain/compile
          make -j$(nproc) target/compile LINUX_UNAME_VERSION=6.6.47 # ç¤ºä¾‹å†…æ ¸ç‰ˆæœ¬ï¼Œå®é™…ç”±.configå†³å®š
          step_end "é¢„ç¼–è¯‘å·¥å…·é“¾å’Œæ ¸å¿ƒå·¥å…·"

      - name: LUCI è½¯ä»¶åŒ…é¢„æ£€
        id: check_luci
        # å³ä½¿ç¼“å­˜å‘½ä¸­ï¼Œä¹Ÿè¦æ£€æŸ¥ï¼Œå› ä¸ºé…ç½®å¯èƒ½æ›´æ–°äº†
        run: |
          source scripts/logger.sh
          step_start "LUCI è½¯ä»¶åŒ…é¢„æ£€ (Profile: Pro)"
          cd openwrt
          # æ¨¡æ‹Ÿåˆå¹¶ Pro é…ç½®
          merge_configs ".config" "../configs/Pro.config"
          # è°ƒç”¨æ£€æŸ¥è„šæœ¬
          bash ../scripts/check-luci.sh "Pro" ".config" "../configs/Pro.config"
          step_end "LUCI è½¯ä»¶åŒ…é¢„æ£€ (Profile: Pro)"

  # ==============================================================================
  # Job 3: é˜¶æ®µäºŒ - æ„å»ºæœ€ç»ˆå›ºä»¶
  # ç›®çš„: åœ¨åŸºç¡€ç¯å¢ƒä¹‹ä¸Šï¼Œå¹¶è¡Œç¼–è¯‘æ‰€æœ‰æœ€ç»ˆå›ºä»¶ã€‚
  # ==============================================================================
  build-final:
    name: ğŸ“¦ é˜¶æ®µäºŒ - æ„å»º [${{ matrix.branch }}-${{ matrix.profile }}] å›ºä»¶
    runs-on: ubuntu-22.04
    needs: build-base
    # åªæœ‰å½“æ‰€æœ‰åŸºç¡€ç¯å¢ƒéƒ½æˆåŠŸæ„å»ºåï¼Œæ‰æ‰§è¡Œæ­¤é˜¶æ®µ
    if: needs.build-base.outputs.base_env_success == 'true'
    strategy:
      fail-fast: false
      matrix:
        branch:
          - { repo_short: openwrt, repo_url: "https://github.com/openwrt/openwrt.git", repo_branch: "master" }
          - { repo_short: immwrt, repo_url: "https://github.com/immortalwrt/immortalwrt.git", repo_branch: "master" }
          - { repo_short: libwrt, repo_url: "https://github.com/openwrt/openwrt.git", repo_branch: "openwrt-24.10" }
        profile: [Pro, Max, Ultra]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
        run: |
          source scripts/logger.sh
          log_info "å·¥ä½œæµå¼€å§‹ï¼Œæ—¥å¿—æ–‡ä»¶: ${{ env.LOG_FILE }}"
          echo "FULL_LOG_PATH=$(pwd)/${{ env.LOG_FILE }}" >> $GITHUB_ENV

      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main

      - name: æ¢å¤ DL ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: dl/
          key: dl-${{ env.CHIP_ARCH }}-${{ hashFiles('hashes.txt') }}

      - name: æ¢å¤ Ccache ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ env.CHIP_ARCH }}-${{ matrix.branch.repo_short }}-${{ github.run_id }}

      - name: æ¢å¤åŸºç¡€ç¯å¢ƒç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            build_dir/target/
            build_dir/host/
            staging_dir/
            .config
            feeds.conf
          key: base-env-${{ matrix.branch.repo_short }}-${{ env.CHIP_ARCH }}-${{ hashFiles('hashes.txt') }}

      - name: å…‹éš†æºç 
        run: |
          source scripts/logger.sh
          step_start "å…‹éš† ${{ matrix.branch.repo_short }} æºç "
          git clone ${{ matrix.branch.repo_url }} openwrt
          cd openwrt
          git checkout ${{ matrix.branch.repo_branch }}
          step_end "å…‹éš† ${{ matrix.branch.repo_short }} æºç "

      - name: åˆå¹¶æœ€ç»ˆé…ç½®
        run: |
          source scripts/utils.sh
          step_start "åˆå¹¶æœ€ç»ˆé…ç½® [${{ matrix.profile }}]"
          cd openwrt
          # åˆå¹¶èŠ¯ç‰‡ã€åˆ†æ”¯ã€è½¯ä»¶åŒ…é…ç½®
          merge_configs "../configs/base_${{ env.CHIP_ARCH }}.config" "../configs/base_${{ matrix.branch.repo_short }}.config" "../configs/${{ matrix.profile }}.config"
          step_end "åˆå¹¶æœ€ç»ˆé…ç½® [${{ matrix.profile }}]"

      - name: LUCI è½¯ä»¶åŒ…ç»ˆæ£€
        run: |
          source scripts/logger.sh
          step_start "LUCI è½¯ä»¶åŒ…ç»ˆæ£€ (Profile: ${{ matrix.profile }})"
          cd openwrt
          make defconfig
          # è°ƒç”¨æ£€æŸ¥è„šæœ¬ï¼Œè¿›è¡Œæœ€ç»ˆç¡®è®¤
          bash ../scripts/check-luci.sh "${{ matrix.profile }}" ".config" "../configs/${{ matrix.profile }}.config"
          step_end "LUCI è½¯ä»¶åŒ…ç»ˆæ£€ (Profile: ${{ matrix.profile }})"

      - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
        run: |
          source scripts/logger.sh
          step_start "å¼€å§‹ç¼–è¯‘å›ºä»¶ [${{ matrix.branch }}-${{ matrix.profile }}]"
          cd openwrt
          make -j$(nproc) || make -j1 V=s
          step_end "å¼€å§‹ç¼–è¯‘å›ºä»¶ [${{ matrix.branch }}-${{ matrix.profile }}]"

      - name: æ•´ç†å’Œé‡å‘½åäº§ç‰©
        run: |
          source scripts/utils.sh
          source scripts/logger.sh
          step_start "æ•´ç†å’Œé‡å‘½åäº§ç‰©"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜æ”¾äº§ç‰©
          mkdir -p ${{ env.ARTIFACTS_DIR }}/${{ matrix.branch.repo_short }}-${{ matrix.profile }}
          
          cd openwrt
          
          # æå–è®¾å¤‡åˆ—è¡¨
          devices=$(extract_devices "../configs/base_${{ env.CHIP_ARCH }}.config")
          log_info "æå–åˆ°çš„è®¾å¤‡åˆ—è¡¨: $devices"
          
          # éå†è®¾å¤‡ï¼Œé‡å‘½åæ–‡ä»¶
          for device in $devices; do
            log_info "æ­£åœ¨å¤„ç†è®¾å¤‡: $device"
            
            # æŸ¥æ‰¾å¹¶é‡å‘½åå›ºä»¶
            find bin/targets/ -name "*${device}*-squashfs-sysupgrade.bin" -print0 | while IFS= read -r -d '' file; do
              new_name="${{ matrix.branch.repo_short }}-${device}-sysupgrade-${{ matrix.profile }}.bin"
              log_info "é‡å‘½åå›ºä»¶: $(basename "$file") -> $new_name"
              cp "$file" "../${{ env.ARTIFACTS_DIR }}/${{ matrix.branch.repo_short }}-${{ matrix.profile }}/$new_name"
            done
            
            find bin/targets/ -name "*${device}*-squashfs-factory.bin" -print0 | while IFS= read -r -d '' file; do
              new_name="${{ matrix.branch.repo_short }}-${device}-factory-${{ matrix.profile }}.bin"
              log_info "é‡å‘½åå›ºä»¶: $(basename "$file") -> $new_name"
              cp "$file" "../${{ env.ARTIFACTS_DIR }}/${{ matrix.branch.repo_short }}-${{ matrix.profile }}/$new_name"
            done
            
            # å¤åˆ¶å¹¶é‡å‘½åé…ç½®å’Œæ¸…å•æ–‡ä»¶
            cp .config "../${{ env.ARTIFACTS_DIR }}/${{ matrix.branch.repo_short }}-${{ matrix.profile }}/${{ matrix.branch.repo_short }}-${device}-${{ matrix.profile }}.config"
            cp bin/targets/*/manifest "../${{ env.ARTIFACTS_DIR }}/${{ matrix.branch.repo_short }}-${{ matrix.profile }}/${{ matrix.branch.repo_short }}-${device}-${{ matrix.profile }}.manifest"
            cp config.buildinfo "../${{ env.ARTIFACTS_DIR }}/${{ matrix.branch.repo_short }}-${{ matrix.profile }}/${{ matrix.branch.repo_short }}-${device}-${{ matrix.profile }}.config.buildinfo"
          done
          
          # å¤åˆ¶æ‰€æœ‰ ipk æ–‡ä»¶åˆ°ç»Ÿä¸€ç›®å½•ï¼Œå…è®¸è¦†ç›–
          mkdir -p "../${{ env.ARTIFACTS_DIR }}/packages"
          find bin/packages/ -name "*.ipk" -exec cp {} "../${{ env.ARTIFACTS_DIR }}/packages/" \;
          
          step_end "æ•´ç†å’Œé‡å‘½åäº§ç‰©"

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.branch.repo_short }}-${{ matrix.profile }}-artifacts
          path: ${{ env.ARTIFACTS_DIR }}/
          retention-days: 7

  # ==============================================================================
  # Job 4: å‘å¸ƒé˜¶æ®µ
  # ç›®çš„: æ”¶é›†æ‰€æœ‰äº§ç‰©ï¼Œæ‰“åŒ…ï¼Œå¹¶åˆ›å»º GitHub Releaseã€‚
  # ==============================================================================
  release:
    name: ğŸ‰ å‘å¸ƒé˜¶æ®µ
    runs-on: ubuntu-22.04
    needs: [prepare, build-final]
    if: always() && needs.build-final.result == 'success'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
        run: |
          source scripts/logger.sh
          log_info "å·¥ä½œæµå¼€å§‹ï¼Œæ—¥å¿—æ–‡ä»¶: ${{ env.LOG_FILE }}"
          echo "FULL_LOG_PATH=$(pwd)/${{ env.LOG_FILE }}" >> $GITHUB_ENV

      - name: ä¸‹è½½æ‰€æœ‰äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts

      - name: æ•´ç†å’Œæ‰“åŒ…å‘å¸ƒæ–‡ä»¶
        run: |
          source scripts/utils.sh
          source scripts/logger.sh
          step_start "æ•´ç†å’Œæ‰“åŒ…å‘å¸ƒæ–‡ä»¶"
          
          mkdir -p release_upload
          
          # 1. æ‰“åŒ…æ‰€æœ‰é…ç½®æ–‡ä»¶
          find all_artifacts -name "*.config" -print0 | tar -czf release_upload/${{ env.CHIP_ARCH }}-config.tar.gz --null -T -
          log_success "é…ç½®æ–‡ä»¶æ‰“åŒ…å®Œæˆ: ${{ env.CHIP_ARCH }}-config.tar.gz"
          
          # 2. æ‰“åŒ…æ‰€æœ‰è½¯ä»¶åŒ…
          if [ -d "all_artifacts/*/packages" ]; then
            tar -czf release_upload/${{ env.CHIP_ARCH }}-app.tar.gz -C all_artifacts/*/packages .
            log_success "è½¯ä»¶åŒ…æ‰“åŒ…å®Œæˆ: ${{ env.CHIP_ARCH }}-app.tar.gz"
          fi
          
          # 3. æ‰“åŒ…æ‰€æœ‰æ—¥å¿—
          find all_artifacts -name "*.log" -print0 | tar -czf release_upload/${{ env.CHIP_ARCH }}-log.tar.gz --null -T -
          log_success "æ—¥å¿—æ–‡ä»¶æ‰“åŒ…å®Œæˆ: ${{ env.CHIP_ARCH }}-log.tar.gz"
          
          # 4. ç§»åŠ¨æ‰€æœ‰å›ºä»¶åˆ°å‘å¸ƒç›®å½•
          find all_artifacts -name "*.bin" -exec cp {} release_upload/ \;
          log_success "æ‰€æœ‰å›ºä»¶æ–‡ä»¶å·²ç§»åŠ¨åˆ°å‘å¸ƒç›®å½•"
          
          # 5. ç”Ÿæˆ Release Notes
          kernel_version=$(get_kernel_version "all_artifacts")
          luci_apps_list=$(find release_upload -name "*.manifest" -exec cat {} \; | grep -E "luci-app-.*" | awk '{print $1}' | sort -u | tr '\n' ', ' | sed 's/,$//')
          
          cat > release_upload/ReleaseNotes.md << EOF
          ## OpenWrt å›ºä»¶å‘å¸ƒ
          
          ---
          
          ### ğŸ“‹ åŸºæœ¬ä¿¡æ¯
          - **èŠ¯ç‰‡æ¶æ„**: ${{ env.CHIP_ARCH }}
          - **æºç åˆ†æ”¯**: openwrt, immwrt, libwrt
          - **è½¯ä»¶åŒ…é…ç½®**: Pro, Max, Ultra
          - **å†…æ ¸ç‰ˆæœ¬**: ${kernel_version}
          - **ç¼–è¯‘æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **ä½œè€…**: Mary
          
          ### ğŸ”‘ é»˜è®¤è®¾ç½®
          - **ç®¡ç†åœ°å€**: 192.168.111.1
          - **é»˜è®¤ç”¨æˆ·**: root
          - **é»˜è®¤å¯†ç **: none (ç©ºå¯†ç )
          - **é»˜è®¤WiFi**: OpenWrt (å¯†ç : 12345678)
          
          ### ğŸ“¦ ç¼–è¯‘çš„ LUCI åº”ç”¨åˆ—è¡¨
          ${luci_apps_list}
          
          ### ğŸ“¥ é™„ä»¶è¯´æ˜
          - `*-factory.bin`: ç”¨äºä»åŸå‚å›ºä»¶åˆ·å…¥ã€‚
          - `*-sysupgrade.bin`: ç”¨äºåœ¨ç°æœ‰ OpenWrt ç³»ç»Ÿä¸Šå‡çº§ã€‚
          - `${{ env.CHIP_ARCH }}-config.tar.gz`: æ‰€æœ‰è®¾å¤‡çš„ .config, .manifest, config.buildinfo æ–‡ä»¶ã€‚
          - `${{ env.CHIP_ARCH }}-app.tar.gz`: æ‰€æœ‰ç¼–è¯‘ç”Ÿæˆçš„ .ipk è½¯ä»¶åŒ…ã€‚
          - `${{ env.CHIP_ARCH }}-log.tar.gz`: æœ¬æ¬¡ç¼–è¯‘çš„è¯¦ç»†æ—¥å¿—ã€‚
          
          ---
          
          **æ³¨æ„**: åˆ·æœºå‰è¯·ç¡®è®¤è®¾å¤‡å‹å·ï¼Œåˆ·é”™æœ‰å˜ç –é£é™©ï¼
          EOF
          
          step_end "æ•´ç†å’Œæ‰“åŒ…å‘å¸ƒæ–‡ä»¶"

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.CHIP_ARCH }}-$(date '+%Y-%m-%d')
          name: OpenWrt ${{ env.CHIP_ARCH }} Firmware $(date '+%Y-%m-%d')
          body_path: release_upload/ReleaseNotes.md
          files: |
            release_upload/*.bin
            release_upload/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
