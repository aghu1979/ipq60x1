# OpenWrt å¤šé…ç½®è‡ªåŠ¨ç¼–è¯‘å·¥ä½œæµ
# æ”¯æŒå¤šèŠ¯ç‰‡æ¶æ„ã€å¤šåˆ†æ”¯ã€å¤šé…ç½®çš„å¹¶è¡Œç¼–è¯‘
# é¦–æ¬¡åˆ›å»º: 2025-10-18
# æœ€åæ›´æ–°: 2025-10-18

name: OpenWrt Multi-Config Build

# è§¦å‘æ¡ä»¶
on:
  # å®šæ—¶è§¦å‘ï¼šåŒ—äº¬æ—¶é—´æ¯å‘¨äº”0ç‚¹ (UTCæ—¶é—´å‘¨å››16ç‚¹)
  schedule:
    - cron: '0 16 * * 4'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      ubuntu_version:
        description: 'é€‰æ‹©Ubuntuç‰ˆæœ¬'
        required: true
        default: '22.04'
        type: choice
        options:
          - '22.04'
          - '24.04'
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°ç¼–è¯‘ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        required: false
        default: false
        type: boolean

# ç¯å¢ƒå˜é‡
env:
  TZ: Asia/Shanghai  # æ—¶åŒºè®¾ç½®
  CACHE_VERSION: v2  # ç¼“å­˜ç‰ˆæœ¬å·ï¼Œç”¨äºç¼“å­˜å¤±æ•ˆæ§åˆ¶

# ä»»åŠ¡å®šä¹‰
jobs:
  # é˜¶æ®µ1ï¼šç”Ÿæˆé…ç½®å“ˆå¸Œå€¼
  generate-hashes:
    name: ç”Ÿæˆé…ç½®å“ˆå¸Œ
    runs-on: ubuntu-latest
    outputs:
      hashes-file: ${{ steps.hash.outputs.hashes-file }}
      cache-key: ${{ steps.hash.outputs.cache-key }}
      config-count: ${{ steps.hash.outputs.config-count }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç”Ÿæˆé…ç½®å“ˆå¸Œæ–‡ä»¶
        id: hash
        run: |
          {
            echo "# Configuration Hashes - $(date)"
            echo "# Generated by OpenWrt Build System"
            echo ""
            find $GITHUB_WORKSPACE/configs/ -type f -name "*.config" -exec sha256sum {} \; | \
              sed 's|configs/||' | \
              sort | \
              awk '{print $2 "=" $1}'
          } > $GITHUB_WORKSPACE/hashes-file
          
          CONFIG_COUNT=$(wc -l < $GITHUB_WORKSPACE/hashes-file)
          CACHE_KEY="openwrt-$(cat $GITHUB_WORKSPACE/hashes-file | sha256sum | cut -d' ' -f1)"
          
          {
            echo "hashes-file<<EOF"
            cat $GITHUB_WORKSPACE/hashes-file
            echo "EOF"
            echo "cache-key=$CACHE_KEY"
            echo "config-count=$CONFIG_COUNT"
          } >> $GITHUB_OUTPUT
          
          echo "âœ… ç”Ÿæˆå“ˆå¸Œæ–‡ä»¶å®Œæˆ"
          echo "ğŸ“Š é…ç½®æ–‡ä»¶æ•°é‡: $CONFIG_COUNT"
          echo "ğŸ”‘ ç¼“å­˜Key: $CACHE_KEY"

  # é˜¶æ®µ2ï¼šå‡†å¤‡å·¥å…·é“¾å’ŒåŸºç¡€ä¾èµ–
  prepare-toolchain:
    name: å‡†å¤‡å·¥å…·é“¾
    needs: generate-hashes
    runs-on: ubuntu-${{ github.event.inputs.ubuntu_version || '22.04' }}
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
      toolchain-ready: ${{ steps.prepare.outputs.toolchain-ready }}
      error-exit: ${{ steps.prepare.outputs.error-exit }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          docker-images: true
          large-packages: true
          swap-storage: true

      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gcc-multilib \
            g++-multilib \
            gettext \
            libelf-dev \
            libssl-dev \
            libncurses5-dev \
            libncursesw5-dev \
            python3-distutils-extra \
            rsync \
            unzip \
            python3-pyelftools \
            python3-setuptools \
            python3-pip \
            python3-pyelftools \
            zlib1g-dev \
            subversion \
            git \
            wget \
            time \
            python3 \
            ccache \
            curl

      - name: æ¢å¤å·¥å…·é“¾ç¼“å­˜
        id: cache
        uses: actions/cache@v3
        with:
          path: |
            $GITHUB_WORKSPACE/dl/
            $GITHUB_WORKSPACE/build_dir/host/
            $GITHUB_WORKSPACE/build_dir/toolchain-*/
            $GITHUB_WORKSPACE/staging_dir/host/
            $GITHUB_WORKSPACE/staging_dir/toolchain-*/
            $GITHUB_WORKSPACE/toolchain/
            $GITHUB_WORKSPACE/.ccache
          key: toolchain-${{ needs.generate-hashes.outputs.cache-key }}-${{ env.CACHE_VERSION }}-${{ runner.os }}
          restore-keys: |
            toolchain--${{ env.CACHE_VERSION }}-${{ runner.os }}

      - name: å‡†å¤‡å·¥å…·é“¾
        id: prepare
        if: steps.cache.outputs.cache-hit != 'true' || github.event.inputs.force_rebuild == 'true'
        run: |
          set -euo pipefail
          source $GITHUB_WORKSPACE/scripts/logger.sh
          
          step_start "å‡†å¤‡å·¥å…·é“¾"
          
          # åˆ›å»ºå·¥å…·é“¾ç›®å½•
          mkdir -p $GITHUB_WORKSPACE/toolchain_cache
          
          # å…‹éš†ä¸€ä¸ªåŸºç¡€ä»“åº“ç”¨äºå·¥å…·é“¾ç¼–è¯‘
          echo "ğŸ“¥ å…‹éš†ä»“åº“å‡†å¤‡å·¥å…·é“¾..."
          git clone https://github.com/laipeng668/openwrt.git $GITHUB_WORKSPACE/toolchain_cache/openwrt
          
          # å¤åˆ¶è„šæœ¬
          cp -r $GITHUB_WORKSPACE/scripts $GITHUB_WORKSPACE/toolchain_cache/openwrt/
          cp -r $GITHUB_WORKSPACE/configs $GITHUB_WORKSPACE/toolchain_cache/openwrt/
          
          cd $GITHUB_WORKSPACE/toolchain_cache/openwrt
          
          chmod +x scripts/*.sh
          
          # æ‰§è¡ŒDIYè„šæœ¬
          echo "ğŸ”§ æ‰§è¡ŒDIYè„šæœ¬..."
          if ! ./scripts/diy.sh openwrt ipq60xx; then
            log_error "DIYè„šæœ¬æ‰§è¡Œå¤±è´¥"
            echo "error-exit=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # æ›´æ–°feeds
          echo "ğŸ“¦ æ›´æ–°feeds..."
          if ! ./scripts/feeds update -a; then
            log_error "feedsæ›´æ–°å¤±è´¥"
            echo "error-exit=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if ! ./scripts/feeds install -a; then
            log_error "feedså®‰è£…å¤±è´¥"
            echo "error-exit=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # åªç¼–è¯‘å·¥å…·é“¾ï¼Œä¸ç¼–è¯‘å›ºä»¶
          echo "ğŸ”¨ ç¼–è¯‘å·¥å…·é“¾..."
          if ! make toolchain/install -j$(nproc); then
            log_error "å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
            echo "error-exit=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          cd $GITHUB_WORKSPACE
          
          echo "toolchain-ready=true" >> $GITHUB_OUTPUT
          echo "error-exit=false" >> $GITHUB_OUTPUT
          step_end "å·¥å…·é“¾å‡†å¤‡å®Œæˆ"

  # é˜¶æ®µ3ï¼šå¹¶è¡Œç¼–è¯‘3ä¸ªåˆ†æ”¯çš„åŸºç¡€ç¯å¢ƒ
  build-base-environments:
    name: ç¼–è¯‘åŸºç¡€ç¯å¢ƒ (${{ matrix.branch }})
    needs: [generate-hashes, prepare-toolchain]
    if: always() && needs.prepare-toolchain.outputs.toolchain-ready == 'true' && needs.prepare-toolchain.outputs.error-exit == 'false'
    runs-on: ubuntu-${{ github.event.inputs.ubuntu_version || '22.04' }}
    strategy:
      fail-fast: false
      matrix:
        branch: [openwrt, immwrt, libwrt]
        include:
          - branch: openwrt
            repo_url: https://github.com/laipeng668/openwrt.git
            repo_branch: master
            repo_short: openwrt
          - branch: immwrt
            repo_url: https://github.com/laipeng668/immortalwrt.git
            repo_branch: master
            repo_short: immwrt
          - branch: libwrt
            repo_url: https://github.com/laipeng668/openwrt-6.x.git
            repo_branch: k6.12-nss
            repo_short: libwrt
    timeout-minutes: 180
    outputs:
      base-ready: ${{ steps.build.outputs.base-ready }}
      base-error: ${{ steps.build.outputs.base-error }}
      base-path: ${{ steps.build.outputs.base-path }}
      branch-name: ${{ matrix.branch }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main

      - name: æ¢å¤å·¥å…·é“¾ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: |
            $GITHUB_WORKSPACE/dl/
            $GITHUB_WORKSPACE/build_dir/host/
            $GITHUB_WORKSPACE/build_dir/toolchain-*/
            $GITHUB_WORKSPACE/staging_dir/host/
            $GITHUB_WORKSPACE/staging_dir/toolchain-*/
            $GITHUB_WORKSPACE/toolchain/
            $GITHUB_WORKSPACE/.ccache
          key: toolchain-${{ needs.generate-hashes.outputs.cache-key }}-${{ env.CACHE_VERSION }}-${{ runner.os }}
          restore-keys: |
            toolchain--${{ env.CACHE_VERSION }}-${{ runner.os }}

      - name: æ¢å¤åŸºç¡€ç¯å¢ƒç¼“å­˜
        uses: actions/cache@v3
        with:
          path: |
            $GITHUB_WORKSPACE/base_env_${{ matrix.branch }}/
          key: base-env-${{ matrix.branch }}-${{ needs.generate-hashes.outputs.cache-key }}-${{ env.CACHE_VERSION }}-${{ runner.os }}
          restore-keys: |
            base-env-${{ matrix.branch }}--${{ env.CACHE_VERSION }}-${{ runner.os }}

      - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gcc-multilib \
            g++-multilib \
            gettext \
            libelf-dev \
            libssl-dev \
            libncurses5-dev \
            libncursesw5-dev \
            python3-distutils-extra \
            rsync \
            unzip \
            python3-pyelftools \
            python3-setuptools \
            python3-pip \
            python3-pyelftools \
            zlib1g-dev
          
          echo "export CCACHE_DIR=$GITHUB_WORKSPACE/.ccache" >> $GITHUB_ENV
          echo "export CCACHE_MAXSIZE=5G" >> $GITHUB_ENV
          
          source $GITHUB_WORKSPACE/scripts/logger.sh
          log_info "å¼€å§‹ç¼–è¯‘ ${{ matrix.branch }} åŸºç¡€ç¯å¢ƒ"

      - name: å‡†å¤‡åˆ†æ”¯æºç 
        id: prepare
        run: |
          set -euo pipefail
          source $GITHUB_WORKSPACE/scripts/logger.sh
          step_start "å‡†å¤‡ ${{ matrix.branch }} æºç "
          
          # æ£€æŸ¥åŸºç¡€ç¯å¢ƒæ˜¯å¦å·²å­˜åœ¨
          if [ -d "$GITHUB_WORKSPACE/base_env_${{ matrix.branch }}/openwrt" ]; then
            echo "ğŸ“ ä½¿ç”¨ç¼“å­˜çš„åŸºç¡€ç¯å¢ƒ"
            cd $GITHUB_WORKSPACE/base_env_${{ matrix.branch }}/openwrt
          else
            echo "ğŸ“¥ å…‹éš†ä»“åº“: ${{ matrix.repo_url }}"
            mkdir -p $GITHUB_WORKSPACE/base_env_${{ matrix.branch }}
            git clone ${{ matrix.repo_url }} $GITHUB_WORKSPACE/base_env_${{ matrix.branch }}/openwrt
            cd $GITHUB_WORKSPACE/base_env_${{ matrix.branch }}/openwrt
            
            # å¤åˆ¶è„šæœ¬å’Œé…ç½®
            cp -r $GITHUB_WORKSPACE/scripts ./
            cp -r $GITHUB_WORKSPACE/configs ./
            
            chmod +x scripts/*.sh
            
            # æ‰§è¡ŒDIYè„šæœ¬
            echo "ğŸ”§ æ‰§è¡ŒDIYè„šæœ¬..."
            if ! ./scripts/diy.sh ${{ matrix.branch }} ipq60xx; then
              log_error "DIYè„šæœ¬æ‰§è¡Œå¤±è´¥"
              echo "base-error=true" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            # æ›´æ–°feeds
            echo "ğŸ“¦ æ›´æ–°feeds..."
            if ! ./scripts/feeds update -a; then
              log_error "feedsæ›´æ–°å¤±è´¥"
              echo "base-error=true" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            if ! ./scripts/feeds install -a; then
              log_error "feedså®‰è£…å¤±è´¥"
              echo "base-error=true" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
          
          step_end "æºç å‡†å¤‡å®Œæˆ"

      - name: åˆå¹¶åŸºç¡€é…ç½®
        id: build
        run: |
          set -euo pipefail
          source $GITHUB_WORKSPACE/scripts/logger.sh
          step_start "åˆå¹¶åŸºç¡€é…ç½®"
          
          cd $GITHUB_WORKSPACE/base_env_${{ matrix.branch }}/openwrt
          
          # åˆå¹¶é…ç½®ï¼ˆä¼˜å…ˆçº§ä»ä½åˆ°é«˜ï¼‰
          echo "ğŸ“ åˆå¹¶èŠ¯ç‰‡é…ç½®: base_ipq60xx.config"
          cat configs/base_ipq60xx.config > .config
          
          echo "ğŸ“ åˆå¹¶åˆ†æ”¯é…ç½®: base_${{ matrix.branch }}.config"
          cat configs/base_${{ matrix.branch }}.config >> .config
          
          # æ ¼å¼åŒ–é…ç½®
          make defconfig
          
          # æå–è®¾å¤‡åˆ—è¡¨
          echo "ğŸ” æå–è®¾å¤‡åˆ—è¡¨..."
          local devices=$(grep "CONFIG_TARGET_DEVICE_.*_DEVICE_.*=y" .config | \
                         sed 's/.*_DEVICE_\(.*\)=y/\1' | \
                         sort -u)
          
          local device_count=$(echo "$devices" | wc -l)
          echo "ğŸ“Š æ£€æµ‹åˆ° $device_count ä¸ªè®¾å¤‡:"
          echo "$devices" | while read device; do
            echo "  - $device"
          done
          
          # æ£€æŸ¥åŸºç¡€é…ç½®
          echo "ğŸ“Š åŸºç¡€é…ç½®ç»Ÿè®¡:"
          echo "  - æ€»é…ç½®é¡¹: $(grep -c "^CONFIG_" .config)"
          echo "  - è®¾å¤‡æ•°é‡: $device_count"
          echo "  - å†…æ ¸é…ç½®: $(grep "^CONFIG_KERNEL" .config | wc -l)"
          
          # ä¿å­˜åŸºç¡€ç¯å¢ƒçŠ¶æ€
          echo "base-ready=true" >> $GITHUB_OUTPUT
          echo "base-error=false" >> $GITHUB_OUTPUT
          echo "base-path=base_env_${{ matrix.branch }}/openwrt" >> $GITHUB_OUTPUT
          
          step_end "åŸºç¡€é…ç½®åˆå¹¶å®Œæˆ"

      - name: æ£€æŸ¥åŸºç¡€è½¯ä»¶åŒ…
        run: |
          set -euo pipefail
          source $GITHUB_WORKSPACE/scripts/logger.sh
          cd $GITHUB_WORKSPACE/base_env_${{ matrix.branch }}/openwrt
          step_start "æ£€æŸ¥åŸºç¡€è½¯ä»¶åŒ…"
          
          # æ£€æŸ¥åŸºç¡€è½¯ä»¶åŒ…
          if ! $GITHUB_WORKSPACE/scripts/check_packages.sh; then
            log_error "åŸºç¡€è½¯ä»¶åŒ…æ£€æŸ¥å¤±è´¥"
            echo "âš ï¸ åŸºç¡€è½¯ä»¶åŒ…ç¼ºå¤±ï¼Œå°†ç¼“å­˜é€€å‡ºç­‰å¾…ä¿®å¤"
            exit 1
          fi
          
          step_end "åŸºç¡€è½¯ä»¶åŒ…æ£€æŸ¥å®Œæˆ"

      - name: ç¼–è¯‘åŸºç¡€ç¯å¢ƒ
        if: steps.build.outputs.base-error == 'false'
        run: |
          set -euo pipefail
          source $GITHUB_WORKSPACE/scripts/logger.sh
          cd $GITHUB_WORKSPACE/base_env_${{ matrix.branch }}/openwrt
          step_start "ç¼–è¯‘åŸºç¡€ç¯å¢ƒ"
          
          # ç¼–è¯‘åŸºç¡€ç³»ç»Ÿï¼ˆä¸åŒ…å«é¢å¤–è½¯ä»¶åŒ…ï¼‰
          echo "ğŸ”¨ ç¼–è¯‘åŸºç¡€ç³»ç»Ÿ..."
          if ! make -j$(nproc) 2>&1 | tee compile.log; then
            log_error "åŸºç¡€ç¯å¢ƒç¼–è¯‘å¤±è´¥ï¼"
            tail -n 1000 compile.log > error.log
            exit 1
          fi
          
          step_end "åŸºç¡€ç¯å¢ƒç¼–è¯‘å®Œæˆ"

      - name: ä¸Šä¼ åŸºç¡€ç¯å¢ƒ
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: base-env-${{ matrix.branch }}
          path: |
            $GITHUB_WORKSPACE/base_env_${{ matrix.branch }}/
            !base_env_${{ matrix.branch }}/openwrt/build_dir/*
            !base_env_${{ matrix.branch }}/openwrt/staging_dir/*
            !base_env_${{ matrix.branch }}/openwrt/tmp/*
          retention-days: 7

  # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰åŸºç¡€ç¯å¢ƒéƒ½æˆåŠŸ
  check-base-environments:
    name: æ£€æŸ¥åŸºç¡€ç¯å¢ƒçŠ¶æ€
    needs: build-base-environments
    if: always()
    runs-on: ubuntu-latest
    outputs:
      all-ready: ${{ steps.check.outputs.all-ready }}
      failed-branches: ${{ steps.check.outputs.failed-branches }}
      openwrt-ready: ${{ steps.check.outputs.openwrt-ready }}
      immwrt-ready: ${{ steps.check.outputs.immwrt-ready }}
      libwrt-ready: ${{ steps.check.outputs.libwrt-ready }}
    steps:
      - name: æ£€æŸ¥åŸºç¡€ç¯å¢ƒçŠ¶æ€
        id: check
        run: |
          # æ£€æŸ¥æ¯ä¸ªåˆ†æ”¯çš„çŠ¶æ€
          local failed_branches=""
          local all_ready="true"
          local openwrt_ready="false"
          local immwrt_ready="false"
          local libwrt_ready="false"
          
          # æ£€æŸ¥openwrt
          if [ "${{ needs.build-base-environments.result }}" = "success" ]; then
            echo "âœ… openwrt åŸºç¡€ç¯å¢ƒæˆåŠŸ"
            openwrt_ready="true"
          else
            echo "âŒ openwrt åŸºç¡€ç¯å¢ƒå¤±è´¥"
            all_ready="false"
            failed_branches="$failed_branches openwrt"
          fi
          
          # æ£€æŸ¥immwrt
          if [ "${{ needs.build-base-environments.result }}" = "success" ]; then
            echo "âœ… immwrt åŸºç¡€ç¯å¢ƒæˆåŠŸ"
            immwrt_ready="true"
          else
            echo "âŒ immwrt åŸºç¡€ç¯å¢ƒå¤±è´¥"
            all_ready="false"
            failed_branches="$failed_branches immwrt"
          fi
          
          # æ£€æŸ¥libwrt
          if [ "${{ needs.build-base-environments.result }}" = "success" ]; then
            echo "âœ… libwrt åŸºç¡€ç¯å¢ƒæˆåŠŸ"
            libwrt_ready="true"
          else
            echo "âŒ libwrt åŸºç¡€ç¯å¢ƒå¤±è´¥"
            all_ready="false"
            failed_branches="$failed_branches libwrt"
          fi
          
          echo "all-ready=$all_ready" >> $GITHUB_OUTPUT
          echo "failed-branches=$failed_branches" >> $GITHUB_OUTPUT
          echo "openwrt-ready=$openwrt_ready" >> $GITHUB_OUTPUT
          echo "immwrt-ready=$immwrt_ready" >> $GITHUB_OUTPUT
          echo "libwrt-ready=$libwrt_ready" >> $GITHUB_OUTPUT
          
          if [ "$all_ready" = "true" ]; then
            echo "âœ… æ‰€æœ‰åŸºç¡€ç¯å¢ƒå‡†å¤‡å®Œæˆ"
          else
            echo "âŒ ä»¥ä¸‹åŸºç¡€ç¯å¢ƒå¤±è´¥: $failed_branches"
            echo "âš ï¸ å°†ç¼“å­˜é€€å‡ºï¼Œç­‰å¾…ç”¨æˆ·ä¿®å¤è½¯ä»¶åŒ…é—®é¢˜"
          fi

  # é˜¶æ®µ4ï¼šå¹¶è¡Œç¼–è¯‘9ä¸ªè½¯ä»¶é…ç½®
  build-configs:
    name: ç¼–è¯‘å›ºä»¶ (${{ matrix.branch }}-${{ matrix.config }})
    needs: [generate-hashes, check-base-environments]
    if: always() && needs.check-base-environments.outputs.all-ready == 'true'
    runs-on: ubuntu-${{ github.event.inputs.ubuntu_version || '22.04' }}
    strategy:
      fail-fast: false
      matrix:
        branch: [openwrt, immwrt, libwrt]
        config: [Pro, Max, Ultra]
        include:
          - branch: openwrt
            repo_url: https://github.com/laipeng668/openwrt.git
            repo_branch: master
            repo_short: openwrt
            should-run: ${{ needs.check-base-environments.outputs.openwrt-ready == 'true' }}
          - branch: immwrt
            repo_url: https://github.com/laipeng668/immortalwrt.git
            repo_branch: master
            repo_short: immwrt
            should-run: ${{ needs.check-base-environments.outputs.immwrt-ready == 'true' }}
          - branch: libwrt
            repo_url: https://github.com/laipeng668/openwrt-6.x.git
            repo_branch: k6.12-nss
            repo_short: libwrt
            should-run: ${{ needs.check-base-environments.outputs.libwrt-ready == 'true' }}
    timeout-minutes: 180
    
    steps:
      - name: æ£€æŸ¥æ˜¯å¦åº”è¯¥è¿è¡Œ
        run: |
          if [ "${{ matrix.should-run }}" != "true" ]; then
            echo "âŒ ${{ matrix.branch }} åŸºç¡€ç¯å¢ƒæœªå‡†å¤‡å¥½ï¼Œè·³è¿‡ç¼–è¯‘"
            exit 1
          else
            echo "âœ… ${{ matrix.branch }} åŸºç¡€ç¯å¢ƒå·²å‡†å¤‡å¥½ï¼Œå¼€å§‹ç¼–è¯‘"
          fi

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main

      - name: æ¢å¤å·¥å…·é“¾ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: |
            $GITHUB_WORKSPACE/dl/
            $GITHUB_WORKSPACE/build_dir/host/
            $GITHUB_WORKSPACE/build_dir/toolchain-*/
            $GITHUB_WORKSPACE/staging_dir/host/
            $GITHUB_WORKSPACE/staging_dir/toolchain-*/
            $GITHUB_WORKSPACE/toolchain/
            $GITHUB_WORKSPACE/.ccache
          key: toolchain-${{ needs.generate-hashes.outputs.cache-key }}-${{ env.CACHE_VERSION }}-${{ runner.os }}

      - name: ä¸‹è½½åŸºç¡€ç¯å¢ƒ
        uses: actions/download-artifact@v3
        with:
          name: base-env-${{ matrix.branch }}
          path: $GITHUB_WORKSPACE/base_env_${{ matrix.branch }}

      - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gcc-multilib \
            g++-multilib \
            gettext \
            libelf-dev \
            libssl-dev \
            libncurses5-dev \
            libncursesw5-dev \
            python3-distutils-extra \
            rsync \
            unzip \
            python3-pyelftools \
            python3-setuptools \
            python3-pip \
            python3-pyelftools \
            zlib1g-dev
          
          echo "export CCACHE_DIR=$GITHUB_WORKSPACE/.ccache" >> $GITHUB_ENV
          echo "export CCACHE_MAXSIZE=5G" >> $GITHUB_ENV
          
          source $GITHUB_WORKSPACE/scripts/logger.sh
          log_info "å¼€å§‹ç¼–è¯‘ ${{ matrix.branch }}-${{ matrix.config }}"

      - name: å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
        run: |
          set -euo pipefail
          source $GITHUB_WORKSPACE/scripts/logger.sh
          step_start "å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ"
          
          cd $GITHUB_WORKSPACE/base_env_${{ matrix.branch }}/openwrt
          
          # ç¡®ä¿è„šæœ¬å­˜åœ¨
          if [ ! -d "scripts" ]; then
            cp -r $GITHUB_WORKSPACE/scripts ./
            cp -r $GITHUB_WORKSPACE/configs ./
            chmod +x scripts/*.sh
          fi
          
          step_end "ç¼–è¯‘ç¯å¢ƒå‡†å¤‡å®Œæˆ"

      - name: åˆå¹¶è½¯ä»¶åŒ…é…ç½®
        run: |
          set -euo pipefail
          source $GITHUB_WORKSPACE/scripts/logger.sh
          cd $GITHUB_WORKSPACE/base_env_${{ matrix.branch }}/openwrt
          step_start "åˆå¹¶è½¯ä»¶åŒ…é…ç½®"
          
          # åœ¨åŸºç¡€é…ç½®ä¸Šåˆå¹¶è½¯ä»¶åŒ…é…ç½®ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
          echo "ğŸ“ åˆå¹¶è½¯ä»¶åŒ…é…ç½®: ${{ matrix.config }}.config"
          cat configs/${{ matrix.config }}.config >> .config
          
          # æ ¼å¼åŒ–é…ç½®
          make defconfig
          
          # æ˜¾ç¤ºé…ç½®ç»Ÿè®¡
          echo "ğŸ“Š é…ç½®ç»Ÿè®¡:"
          echo "  - æ€»é…ç½®é¡¹: $(grep -c "^CONFIG_" .config)"
          echo "  - Luciåº”ç”¨: $(grep -c "^CONFIG_PACKAGE_luci-app.*=y" .config)"
          echo "  - å…¶ä»–è½¯ä»¶åŒ…: $(grep -c "^CONFIG_PACKAGE_.*=y" .config | grep -v "luci-app")"
          
          step_end "è½¯ä»¶åŒ…é…ç½®åˆå¹¶å®Œæˆ"

      - name: æ£€æŸ¥è½¯ä»¶åŒ…
        run: |
          set -euo pipefail
          source $GITHUB_WORKSPACE/scripts/logger.sh
          cd $GITHUB_WORKSPACE/base_env_${{ matrix.branch }}/openwrt
          step_start "æ£€æŸ¥è½¯ä»¶åŒ…"
          
          # æ£€æŸ¥è½¯ä»¶åŒ…ä¾èµ–
          if ! $GITHUB_WORKSPACE/scripts/check_packages.sh; then
            log_error "è½¯ä»¶åŒ…æ£€æŸ¥å¤±è´¥"
            
            # å°è¯•è‡ªåŠ¨ä¿®å¤
            echo "ğŸ”§ å°è¯•è‡ªåŠ¨ä¿®å¤è½¯ä»¶åŒ…é—®é¢˜..."
            # è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªåŠ¨ä¿®å¤é€»è¾‘
            
            # å¦‚æœä¿®å¤å¤±è´¥ï¼Œç”Ÿæˆè¯¦ç»†é”™è¯¯æŠ¥å‘Š
            echo "ğŸ“‹ ç”Ÿæˆè¯¦ç»†é”™è¯¯æŠ¥å‘Š..."
            {
              echo "# è½¯ä»¶åŒ…é”™è¯¯æŠ¥å‘Š"
              echo "åˆ†æ”¯: ${{ matrix.branch }}"
              echo "é…ç½®: ${{ matrix.config }}"
              echo "æ—¶é—´: $(date)"
              echo ""
              echo "é”™è¯¯è¯¦æƒ…:"
              cat error.log 2>/dev/null || echo "æ— é”™è¯¯æ—¥å¿—"
              echo ""
              echo "ç›´æ¥è®¿é—®é“¾æ¥:"
              echo "- å®Œæ•´æ—¥å¿—: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
            } > package_error_report.md
            
            exit 1
          fi
          
          step_end "è½¯ä»¶åŒ…æ£€æŸ¥å®Œæˆ"

      - name: ç¼–è¯‘å›ºä»¶
        run: |
          set -euo pipefail
          source $GITHUB_WORKSPACE/scripts/logger.sh
          cd $GITHUB_WORKSPACE/base_env_${{ matrix.branch }}/openwrt
          step_start "ç¼–è¯‘å›ºä»¶"
          
          # æ¸…ç†ä¹‹å‰çš„æ„å»ºï¼ˆå¦‚æœéœ€è¦ï¼‰
          make clean
          
          # ç¼–è¯‘å›ºä»¶
          echo "ğŸ”¥ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          if ! make -j$(nproc) 2>&1 | tee compile.log; then
            log_error "ç¼–è¯‘å¤±è´¥ï¼"
            tail -n 1000 compile.log > error.log
            exit 1
          fi
          
          step_end "å›ºä»¶ç¼–è¯‘å®Œæˆ"

      - name: å¤„ç†äº§å‡ºç‰©
        run: |
          set -euo pipefail
          source $GITHUB_WORKSPACE/scripts/logger.sh
          cd $GITHUB_WORKSPACE/base_env_${{ matrix.branch }}/openwrt
          step_start "å¤„ç†äº§å‡ºç‰©"
          
          $GITHUB_WORKSPACE/scripts/process_artifacts.sh ${{ matrix.branch }} ${{ matrix.config }} ipq60xx
          
          step_end "äº§å‡ºç‰©å¤„ç†å®Œæˆ"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: build-${{ matrix.branch }}-${{ matrix.config }}
          path: |
            $GITHUB_WORKSPACE/base_env_${{ matrix.branch }}/openwrt/artifacts/
            $GITHUB_WORKSPACE/base_env_${{ matrix.branch }}/openwrt/*.log
          retention-days: 7

  # é˜¶æ®µ5ï¼šåˆ›å»ºRelease
  create-release:
    name: åˆ›å»ºRelease
    needs: [generate-hashes, build-configs]
    if: always() && needs.build-configs.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v3
        with:
          path: $GITHUB_WORKSPACE/artifacts

      - name: å‡†å¤‡å‘å¸ƒå†…å®¹
        run: |
          set -euo pipefail
          source $GITHUB_WORKSPACE/scripts/logger.sh
          step_start "å‡†å¤‡å‘å¸ƒ"
          
          mkdir -p $GITHUB_WORKSPACE/release
          
          echo "ğŸ“¦ æ”¶é›†å›ºä»¶æ–‡ä»¶..."
          find $GITHUB_WORKSPACE/artifacts -name "*.bin" -exec cp {} $GITHUB_WORKSPACE/release/ \;
          
          echo "ğŸ“¦ æ‰“åŒ…é…ç½®æ–‡ä»¶..."
          find $GITHUB_WORKSPACE/artifacts -name "*.config*" -exec cp {} $GITHUB_WORKSPACE/release/ \;
          tar -czf $GITHUB_WORKSPACE/release/ipq60xx-config.tar.gz -C $GITHUB_WORKSPACE/release $(ls $GITHUB_WORKSPACE/release/*.config* | xargs -n1 basename)
          
          echo "ğŸ“¦ æ‰“åŒ…è½¯ä»¶åŒ…..."
          mkdir -p $GITHUB_WORKSPACE/release/packages
          find $GITHUB_WORKSPACE/artifacts -name "*.ipk" -exec cp {} $GITHUB_WORKSPACE/release/packages/ \; 2>/dev/null || true
          tar -czf $GITHUB_WORKSPACE/release/ipq60xx-app.tar.gz -C $GITHUB_WORKSPACE/release/packages .
          
          echo "ğŸ“¦ æ‰“åŒ…æ—¥å¿—..."
          find $GITHUB_WORKSPACE/artifacts -name "*.log" -exec cp {} $GITHUB_WORKSPACE/release/ \;
          tar -czf $GITHUB_WORKSPACE/release/ipq60xx-log.tar.gz -C $GITHUB_WORKSPACE/release $(ls $GITHUB_WORKSPACE/release/*.log | xargs -n1 basename)
          
          echo "ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜..."
          $GITHUB_WORKSPACE/scripts/prepare_release.sh > $GITHUB_WORKSPACE/release_notes.md
          
          step_end "å‘å¸ƒå‡†å¤‡å®Œæˆ"

      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ipq60xx-$(date +%Y%m%d)
          body_path: $GITHUB_WORKSPACE/release_notes.md
          files: |
            $GITHUB_WORKSPACE/release/*.bin
            $GITHUB_WORKSPACE/release/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ¸…ç†æ—§ç‰ˆæœ¬
        run: |
          echo "ğŸ§¹ æ¸…ç†æ—§ç‰ˆæœ¬..."
          gh release list --repo ${{ github.repository }} --limit 20 | \
            tail -n +8 | \
            awk '{print $1}' | \
            xargs -I {} gh release delete {} --repo ${{ github.repository }} --yes || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
