# æ¸…ç†å·¥ä½œæµ - å®šæœŸæ¸…ç†æ—§çš„Releaseå’ŒArtifacts
# ä½œè€…: Mary
# æœ€åæ›´æ–°: 2024-01-XX

name: æ¸…ç†æ—§ç‰ˆæœ¬

# è§¦å‘æ¡ä»¶
on:
  # å®šæ—¶è§¦å‘ï¼šæ¯æœˆ1å·å‡Œæ™¨2ç‚¹
  schedule:
    - cron: '0 2 1 * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æƒé™è®¾ç½®
permissions:
  contents: write  # åˆ é™¤Releaseéœ€è¦å†™æƒé™
  actions: read   # è¯»å–Artifactséœ€è¦è¯»æƒé™

# ä»»åŠ¡å®šä¹‰
jobs:
  # æ¸…ç†ä»»åŠ¡
  cleanup:
    name: æ¸…ç†æ—§ç‰ˆæœ¬
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # è®¾ç½®ç¯å¢ƒå˜é‡
      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          # è®¾ç½®ä¿ç•™ç‰ˆæœ¬æ•°é‡
          echo "KEEP_RELEASES=7" >> $GITHUB_ENV
          # è®¾ç½®ä¿ç•™å¤©æ•°
          echo "KEEP_DAYS=30" >> $GITHUB_ENV

      # æ¸…ç†æ—§çš„Releases
      - name: æ¸…ç†æ—§çš„Releases
        run: |
          echo "ğŸ§¹ å¼€å§‹æ¸…ç†æ—§çš„Releases..."
          
          # å®‰è£…gh cli
          sudo apt-get update
          sudo apt-get install -y gh
          
          # ç™»å½•gh cli
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          
          # è·å–æ‰€æœ‰Releases
          echo "ğŸ“‹ è·å–Releaseåˆ—è¡¨..."
          gh release list --repo ${{ github.repository }} --limit 50 --json tagName,createdAt | \
            jq -r --arg keep ${{ env.KEEP_RELEASES }} \
            '. | sort_by(.createdAt) | reverse | .[$keep | tonumber:] | .tagName' | \
            while read -r tag; do
              if [ -n "$tag" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤Release: $tag"
                gh release delete "$tag" --repo ${{ github.repository }} --yes || true
              fi
            done
          
          echo "âœ… Releaseæ¸…ç†å®Œæˆ"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ¸…ç†æ—§çš„Artifacts
      - name: æ¸…ç†æ—§çš„Artifacts
        run: |
          echo "ğŸ§¹ å¼€å§‹æ¸…ç†æ—§çš„Artifacts..."
          
          # å®‰è£…gh cli
          sudo apt-get install -y gh jq
          
          # ç™»å½•gh cli
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          
          # è·å–æ‰€æœ‰Artifacts
          echo "ğŸ“‹ è·å–Artifactåˆ—è¡¨..."
          gh api repos/:owner/:repo/actions/artifacts --jq '.artifacts[] | select(.created_at < (now - (${{ env.KEEP_DAYS }} | tonumber) * 24 * 3600 | strftime("%Y-%m-%dT%H:%M:%SZ")))' | \
            jq -r '.id' | \
            while read -r id; do
              if [ -n "$id" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤Artifact: $id"
                gh api --method DELETE repos/:owner/:repo/actions/artifacts/$id || true
              fi
            done
          
          echo "âœ… Artifactæ¸…ç†å®Œæˆ"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•
      - name: æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•
        run: |
          echo "ğŸ§¹ å¼€å§‹æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•..."
          
          # å®‰è£…gh cli
          sudo apt-get install -y gh jq
          
          # ç™»å½•gh cli
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          
          # è·å–æ‰€æœ‰å·¥ä½œæµè¿è¡Œè®°å½•
          echo "ğŸ“‹ è·å–å·¥ä½œæµè¿è¡Œè®°å½•..."
          gh api repos/:owner/:repo/actions/runs --jq '.workflow_runs[] | select(.created_at < (now - (${{ env.KEEP_DAYS }} | tonumber) * 24 * 3600 | strftime("%Y-%m-%dT%H:%M:%SZ")))' | \
            jq -r '.id' | \
            while read -r id; do
              if [ -n "$id" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤å·¥ä½œæµè¿è¡Œè®°å½•: $id"
                gh api --method DELETE repos/:owner/:repo/actions/runs/$id || true
              fi
            done
          
          echo "âœ… å·¥ä½œæµè¿è¡Œè®°å½•æ¸…ç†å®Œæˆ"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ç”Ÿæˆæ¸…ç†æŠ¥å‘Š
      - name: ç”Ÿæˆæ¸…ç†æŠ¥å‘Š
        run: |
          echo "ğŸ“Š ç”Ÿæˆæ¸…ç†æŠ¥å‘Š..."
          
          # åˆ›å»ºæŠ¥å‘Š
          {
            echo "# æ¸…ç†æŠ¥å‘Š"
            echo "æ¸…ç†æ—¶é—´: $(date)"
            echo "ä¿ç•™Releaseæ•°é‡: ${{ env.KEEP_RELEASES }}"
            echo "ä¿ç•™å¤©æ•°: ${{ env.KEEP_DAYS }}"
            echo ""
            echo "## æ¸…ç†ç»“æœ"
            echo "- æ—§çš„Releaseså·²åˆ é™¤"
            echo "- æ—§çš„Artifactså·²åˆ é™¤"
            echo "- æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•å·²åˆ é™¤"
            echo ""
            echo "## å½“å‰çŠ¶æ€"
            echo "- Releaseæ•°é‡: $(gh release list --repo ${{ github.repository }} --limit 100 | wc -l)"
            echo "- Artifactæ•°é‡: $(gh api repos/:owner/:repo/actions/artifacts --jq '.total_count')"
          } > cleanup_report.md
          
          echo "âœ… æ¸…ç†æŠ¥å‘Šå·²ç”Ÿæˆ"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ä¸Šä¼ æ¸…ç†æŠ¥å‘Š
      - name: ä¸Šä¼ æ¸…ç†æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: cleanup-report
          path: cleanup_report.md
          retention-days: 7
